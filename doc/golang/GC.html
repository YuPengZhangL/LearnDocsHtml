<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>GC 机制 | YupengZ个人文档</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="开源技术资料整理">
    
    <link rel="preload" href="/LearnDocsHtml/assets/css/0.styles.0042faaf.css" as="style"><link rel="preload" href="/LearnDocsHtml/assets/js/app.0f1bd8f2.js" as="script"><link rel="preload" href="/LearnDocsHtml/assets/js/3.67df8e7b.js" as="script"><link rel="preload" href="/LearnDocsHtml/assets/js/2.084dc933.js" as="script"><link rel="prefetch" href="/LearnDocsHtml/assets/js/10.9deb6ef0.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/11.3e7a30f5.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/12.f0875641.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/13.23510c83.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/14.1f896a53.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/15.a162b02a.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/16.82837904.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/17.04907854.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/18.6ec2e925.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/19.82048133.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/20.183aa861.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/21.33901b63.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/22.847aefdb.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/23.74ed3a9b.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/24.b6ba552b.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/25.1b9d230d.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/26.722cab78.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/27.1147dee1.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/28.f2857d64.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/29.11c8e912.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/30.129c224b.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/31.465857e6.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/32.182268cf.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/33.71679196.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/34.fe242440.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/35.8644ff0d.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/36.1f916d97.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/37.17fdfdba.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/38.7f72ddd5.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/39.048c9500.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/4.be19bd86.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/40.dd9db2e3.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/41.a1ab8356.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/42.beb5e602.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/43.dc67e933.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/44.0af8c02a.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/45.eb75ee6a.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/46.c5ce7e98.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/47.f067c624.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/48.4bf4f48b.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/49.f0a75c7f.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/5.a338d993.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/50.03abd7d4.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/51.880e9109.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/52.c48b61d7.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/53.0059f21f.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/54.c5125de3.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/55.23d722dd.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/56.4a2270bb.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/57.8c988ee6.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/58.3a86a376.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/59.9fcb676b.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/6.9da9678c.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/60.24a5563f.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/61.3b2aaed9.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/62.339f6e71.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/63.1edaf49b.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/64.65ae4ca8.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/65.5f0e8f08.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/66.cfc630d1.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/67.f63acc95.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/68.a3f12ccf.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/69.88b6028b.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/7.c63f6924.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/70.ce51048a.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/71.7b143a95.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/72.d736ae69.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/73.f4164019.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/74.fe5ebe4a.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/8.3b044c8a.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/9.96e8b5d8.js">
    <link rel="stylesheet" href="/LearnDocsHtml/assets/css/0.styles.0042faaf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/LearnDocsHtml/" class="home-link router-link-active"><img src="/LearnDocsHtml/logo.jpg" alt="YupengZ个人文档" class="logo"> <span class="site-name can-hide">YupengZ个人文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="目录" class="dropdown-title"><span class="title">目录</span> <span class="arrow down"></span></button> <button type="button" aria-label="目录" class="mobile-dropdown-title"><span class="title">目录</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/docker/" class="nav-link">
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/es/" class="nav-link">
  ES
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/etcd/" class="nav-link">
  Etcd
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/kafka/" class="nav-link">
  Kafka
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/kubernetes/" class="nav-link">
  Kubernetes
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/mongodb/" class="nav-link">
  mongodb
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/mysql/" class="nav-link">
  Mysql
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/network/" class="nav-link">
  Network
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/nginx/" class="nav-link">
  Nginx
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/postgresql/" class="nav-link">
  Postgresql
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/redis/" class="nav-link">
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/zookeeper/" class="nav-link">
  Zookeeper
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="目录" class="dropdown-title"><span class="title">目录</span> <span class="arrow down"></span></button> <button type="button" aria-label="目录" class="mobile-dropdown-title"><span class="title">目录</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/docker/" class="nav-link">
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/es/" class="nav-link">
  ES
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/etcd/" class="nav-link">
  Etcd
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/kafka/" class="nav-link">
  Kafka
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/kubernetes/" class="nav-link">
  Kubernetes
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/mongodb/" class="nav-link">
  mongodb
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/mysql/" class="nav-link">
  Mysql
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/network/" class="nav-link">
  Network
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/nginx/" class="nav-link">
  Nginx
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/postgresql/" class="nav-link">
  Postgresql
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/redis/" class="nav-link">
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/zookeeper/" class="nav-link">
  Zookeeper
</a></li></ul></div></div> <!----></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="gc-机制"><a href="#gc-机制" class="header-anchor">#</a> GC 机制</h1> <p><a href="https://www.topgoer.cn/docs/golangxiuyang/golangxiuyang-1cmee076rjgk7#anh6dl" target="_blank" rel="noopener noreferrer">参考地鼠文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="_1-go-v1-3之前的标记-清除-mark-and-sweep-算法"><a href="#_1-go-v1-3之前的标记-清除-mark-and-sweep-算法" class="header-anchor">#</a> 1. Go V1.3之前的标记-清除(mark and sweep)算法</h3> <ul><li>标记(Mark phase)</li> <li>清除(Sweep phase)</li></ul> <h4 id="_1-1-stw-stop-the-word-基本流程"><a href="#_1-1-stw-stop-the-word-基本流程" class="header-anchor">#</a> 1.1 STW(stop the word)基本流程</h4> <p><strong>mark and sweep算法在执行的时候，需要程序暂停</strong></p> <blockquote><ol><li>暂停程序业务逻辑, 找出不可达的对象，然后做上标记。第二步，回收标记好的对象</li></ol></blockquote> <p><img src="/LearnDocsHtml/assets/img/stw_gc1.e8b641c7.png" alt="image"></p> <blockquote><ol start="2"><li>开始标记，程序找出它所有可达的对象，并做上标记</li></ol></blockquote> <p><img src="/LearnDocsHtml/assets/img/stw_gc2.9700075b.png" alt="image"></p> <blockquote><ol start="3"><li>标记完了之后，然后开始清除未标记的对象</li></ol></blockquote> <p><img src="/LearnDocsHtml/assets/img/stw_gc3.68fe6361.png" alt="image"></p> <blockquote><ol start="4"><li>停止暂停，让程序继续跑。然后循环重复这个过程，直到process程序生命周期结束</li></ol></blockquote> <p><img src="/LearnDocsHtml/assets/img/stw_gc4.68fe6361.png" alt="image"></p> <h4 id="_1-2-标记-清扫-mark-and-sweep-的缺点"><a href="#_1-2-标记-清扫-mark-and-sweep-的缺点" class="header-anchor">#</a> 1.2 标记-清扫(mark and sweep)的缺点</h4> <ul><li>STW，stop the world；让程序暂停，程序出现卡顿 (重要问题)</li> <li>标记需要扫描整个heap</li> <li>清除数据会产生heap碎片</li></ul> <h3 id="_2-go-v1-5的三色并发标记法"><a href="#_2-go-v1-5的三色并发标记法" class="header-anchor">#</a> 2. Go V1.5的三色并发标记法</h3> <p><strong>三色标记法 实际上就是通过三个阶段的标记来确定清楚的对象都有哪些</strong></p> <h4 id="_2-1-三色标记法的基本流程"><a href="#_2-1-三色标记法的基本流程" class="header-anchor">#</a> 2.1 三色标记法的基本流程</h4> <blockquote><ol><li>新创建的对象,默认的颜色都是标记为“白色”</li></ol></blockquote> <p><img src="/LearnDocsHtml/assets/img/三色标记1.7af4fe80.png" alt="image"></p> <p><img src="/LearnDocsHtml/assets/img/三色标记1.1.7a72b214.png" alt="image"></p> <blockquote><ol start="2"><li>每次GC回收开始, 然后从根节点开始遍历所有对象，把遍历到的对象从白色集合放入“灰色”集合</li></ol></blockquote> <p><img src="/LearnDocsHtml/assets/img/三色标记2.0da5709b.png" alt="image"></p> <blockquote><ol start="3"><li>遍历灰色集合，将灰色对象引用的对象从白色集合放入灰色集合，之后将此灰色对象放入黑色集合</li></ol></blockquote> <p><img src="/LearnDocsHtml/assets/img/三色标记3.581a4d51.png" alt="image"></p> <blockquote><ol start="4"><li>复第三步, 直到灰色中无任何对象.</li></ol></blockquote> <p><img src="/LearnDocsHtml/assets/img/三色标记4.2b130373.png" alt="image"></p> <p><img src="/LearnDocsHtml/assets/img/三色标记4.1.bec0e233.png" alt="image"></p> <blockquote><ol start="5"><li>回收所有的白色标记表的对象. 也就是回收垃圾</li></ol></blockquote> <p><img src="/LearnDocsHtml/assets/img/三色标记5.a686117f.png" alt="image"></p> <h4 id="_2-2-如果没有stw-stop-the-word-三色标记存在的问题"><a href="#_2-2-如果没有stw-stop-the-word-三色标记存在的问题" class="header-anchor">#</a> 2.2 如果没有STW(stop the word)三色标记存在的问题？</h4> <p><img src="/LearnDocsHtml/assets/img/三色标记问题1.85084332.png" alt="image"></p> <p><img src="/LearnDocsHtml/assets/img/三色标记问题2.8ab5ba41.png" alt="image"></p> <p><img src="/LearnDocsHtml/assets/img/三色标记问题3.6fdf4336.png" alt="image"></p> <p><img src="/LearnDocsHtml/assets/img/三色标记问题4.927b6d70.png" alt="image"></p> <p><img src="/LearnDocsHtml/assets/img/三色标记问题5.9239f249.png" alt="image"></p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>可以看出，有两个问题, 在三色标记法中,是不希望被发生的

条件1: 一个白色对象被黑色对象引用(白色被挂在黑色下)
条件2: 灰色对象与它之间的可达关系的白色对象遭到破坏(灰色同时丢了该白色)

当以上两个条件同时满足时, 就会出现对象丢失现象
如果上述中的白色对象3, 如果他还有很多下游对象的话, 也会一并都清理掉
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><blockquote><p>为了防止这种现象的发生，最简单的方式就是STW，直接禁止掉其他用户程序对对象引用关系的干扰，但是<strong>STW的过程有明显的资源浪费，对所有的用户程序都有很大影响</strong>，如何能在保证对象不丢失的情况下合理的尽可能的提高GC效率，减少STW时间呢？</p></blockquote> <h3 id="_3-屏障机制"><a href="#_3-屏障机制" class="header-anchor">#</a> 3. 屏障机制</h3> <h4 id="_3-1-强-弱-三色不变式"><a href="#_3-1-强-弱-三色不变式" class="header-anchor">#</a> 3.1 “强-弱” 三色不变式</h4> <h5 id="_3-1-1-强三色不变式"><a href="#_3-1-1-强三色不变式" class="header-anchor">#</a> 3.1.1 强三色不变式</h5> <blockquote><p>黑色对象不会指向白色对象，只能指向灰色或黑色对象</p></blockquote> <p><img src="/LearnDocsHtml/assets/img/强三色不变式.07f6ddf8.png" alt="image"></p> <h5 id="_3-1-2-弱三色不变式"><a href="#_3-1-2-弱三色不变式" class="header-anchor">#</a> 3.1.2 弱三色不变式</h5> <blockquote><p>黑色对象可以指向白色对象，但此白色对象链路的上游中必须有一个灰色对象</p></blockquote> <p><img src="/LearnDocsHtml/assets/img/弱三色不变式.5213917d.png" alt="image"></p> <h4 id="_3-2-插入写屏障"><a href="#_3-2-插入写屏障" class="header-anchor">#</a> 3.2 插入写屏障</h4> <blockquote><p><strong>具体操作:</strong> 在A对象引用B对象的时候，B对象被标记为灰色。(将B挂在A下游，B必须被标记为灰色)</p> <p><strong>满足:</strong> 强三色不变式. (不存在黑色对象引用白色对象的情况了， 因为白色会强制变成灰色)</p></blockquote> <p><img src="/LearnDocsHtml/assets/img/插入写屏障1.db12b302.png" alt="image"></p> <p><img src="/LearnDocsHtml/assets/img/插入写屏障2.b66f4678.png" alt="image"></p> <p><img src="/LearnDocsHtml/assets/img/插入写屏障3.41570e00.png" alt="image"></p> <p><img src="/LearnDocsHtml/assets/img/插入写屏障4.f2eacd5f.png" alt="image"></p> <p><img src="/LearnDocsHtml/assets/img/插入写屏障5.b52cdafb.png" alt="image"></p> <p><img src="/LearnDocsHtml/assets/img/插入写屏障6.a2d98b0f.png" alt="image"></p> <p><img src="/LearnDocsHtml/assets/img/插入写屏障7.5430fcaf.png" alt="image"></p> <p><img src="/LearnDocsHtml/assets/img/插入写屏障8.ec305c71.png" alt="image"></p> <p><img src="/LearnDocsHtml/assets/img/插入写屏障9.25cb87ec.png" alt="image"></p> <p><img src="/LearnDocsHtml/assets/img/插入写屏障10.232b8149.png" alt="image"></p> <h4 id="_3-3-删除写屏障"><a href="#_3-3-删除写屏障" class="header-anchor">#</a> 3.3 删除写屏障</h4> <blockquote><p><strong>具体操作:</strong> 被删除的对象，如果自身为灰色或者白色，那么被标记为灰色</p> <p><strong>满足:</strong> 弱三色不变式. (保护灰色对象到白色对象的路径不会断)</p></blockquote> <p><img src="/LearnDocsHtml/assets/img/删除写屏障1.c60454ef.png" alt="image"></p> <p><img src="/LearnDocsHtml/assets/img/删除写屏障2.df5d11eb.png" alt="image"></p> <p><img src="/LearnDocsHtml/assets/img/删除写屏障3.930f6ab6.png" alt="image"></p> <p><img src="/LearnDocsHtml/assets/img/删除写屏障4.0297b92e.png" alt="image"></p> <p><img src="/LearnDocsHtml/assets/img/删除写屏障5.6fe8c0e1.png" alt="image"></p> <p><img src="/LearnDocsHtml/assets/img/删除写屏障6.5924545d.png" alt="image"></p> <p><img src="/LearnDocsHtml/assets/img/删除写屏障7.c920da33.png" alt="image"></p> <h4 id="_3-4-go-v1-8-混合写屏障机制"><a href="#_3-4-go-v1-8-混合写屏障机制" class="header-anchor">#</a> 3.4 Go V1.8 混合写屏障机制</h4> <div class="language-text line-numbers-mode"><pre class="language-text"><code>插入写屏障和删除写屏障的短板：

    插入写屏障：结束时需要STW来重新扫描栈，标记栈上引用的白色对象的存活；

    删除写屏障：回收精度低，GC开始时STW扫描堆栈来记录初始快照，这个过程会保护开始时刻的所有存活对象。

Go V1.8版本引入了混合写屏障机制（hybrid write barrier），避免了对栈re-scan的过程，极大的减少了STW的时间。结合了两者的优点。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><blockquote><p>混合写屏障规则</p></blockquote> <div class="language-text line-numbers-mode"><pre class="language-text"><code>具体操作:

1、GC开始将栈上的对象全部扫描并标记为黑色(之后不再进行第二次重复扫描，无需STW)，

2、GC期间，任何在栈上创建的新对象，均为黑色。

3、被删除的对象标记为灰色。

4、被添加的对象标记为灰色。

满足: 变形的弱三色不变式.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>合写屏障是Gc的一种屏障机制，所以只是当程序执行GC的时候，才会触发这种机制</strong></p> <blockquote><p>GC开始：扫描栈区，将可达对象全部标记为黑</p></blockquote> <p><img src="/LearnDocsHtml/assets/img/混合写屏障1.f58dd96b.png" alt="image"></p> <p><img src="/LearnDocsHtml/assets/img/混合写屏障2.67d5b1a4.png" alt="image"></p> <blockquote><p>场景一： 对象被一个堆对象删除引用，成为栈对象的下游</p></blockquote> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">//前提：堆对象4-&gt;对象7 = 对象7；  //对象7 被 对象4引用</span>
栈对象<span class="token number">1</span><span class="token operator">-</span><span class="token operator">&gt;</span>对象<span class="token number">7</span> <span class="token operator">=</span> 堆对象<span class="token number">7</span>；  <span class="token comment">//将堆对象7 挂在 栈对象1 下游</span>
堆对象<span class="token number">4</span><span class="token operator">-</span><span class="token operator">&gt;</span>对象<span class="token number">7</span> <span class="token operator">=</span> null；    <span class="token comment">//对象4 删除引用 对象7</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><img src="/LearnDocsHtml/assets/img/混合写屏障3.efb37452.png" alt="image"></p> <p><img src="/LearnDocsHtml/assets/img/混合写屏障4.dbb0aa75.png" alt="image"></p> <blockquote><p>对象被一个栈对象删除引用，成为另一个栈对象的下游</p></blockquote> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token builtin">new</span> 栈对象<span class="token number">9</span>；
对象<span class="token number">8</span><span class="token operator">-</span><span class="token operator">&gt;</span>对象<span class="token number">3</span> <span class="token operator">=</span> 对象<span class="token number">3</span>；      <span class="token comment">//将栈对象3 挂在 栈对象9 下游</span>
对象<span class="token number">2</span><span class="token operator">-</span><span class="token operator">&gt;</span>对象<span class="token number">3</span> <span class="token operator">=</span> null；      <span class="token comment">//对象2 删除引用 对象3</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><img src="/LearnDocsHtml/assets/img/混合写屏障5.65c1ab3e.png" alt="image"></p> <p><img src="/LearnDocsHtml/assets/img/混合写屏障6.7c8a9f07.png" alt="image"></p> <p><img src="/LearnDocsHtml/assets/img/混合写屏障7.0bafb740.png" alt="image"></p> <blockquote><p>对象被一个堆对象删除引用，成为另一个堆对象的下游</p></blockquote> <div class="language-go line-numbers-mode"><pre class="language-go"><code>堆对象<span class="token number">10</span><span class="token operator">-</span><span class="token operator">&gt;</span>对象<span class="token number">7</span> <span class="token operator">=</span> 堆对象<span class="token number">7</span>；       <span class="token comment">//将堆对象7 挂在 堆对象10 下游</span>
堆对象<span class="token number">4</span><span class="token operator">-</span><span class="token operator">&gt;</span>对象<span class="token number">7</span> <span class="token operator">=</span> null；         <span class="token comment">//对象4 删除引用 对象7</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="/LearnDocsHtml/assets/img/混合写屏障8.ddc283f4.png" alt="image"></p> <p><img src="/LearnDocsHtml/assets/img/混合写屏障9.faca4626.png" alt="image"></p> <p><img src="/LearnDocsHtml/assets/img/混合写屏障10.35c8666f.png" alt="image"></p> <blockquote><p>对象从一个栈对象删除引用，成为另一个堆对象的下游</p></blockquote> <div class="language-go line-numbers-mode"><pre class="language-go"><code>堆对象<span class="token number">10</span><span class="token operator">-</span><span class="token operator">&gt;</span>对象<span class="token number">7</span> <span class="token operator">=</span> 堆对象<span class="token number">7</span>；       <span class="token comment">//将堆对象7 挂在 堆对象10 下游</span>
堆对象<span class="token number">4</span><span class="token operator">-</span><span class="token operator">&gt;</span>对象<span class="token number">7</span> <span class="token operator">=</span> null；         <span class="token comment">//对象4 删除引用 对象7</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="/LearnDocsHtml/assets/img/混合写屏障11.00a51db5.png" alt="image"></p> <p><img src="/LearnDocsHtml/assets/img/混合写屏障12.4f29c515.png" alt="image"></p> <p><img src="/LearnDocsHtml/assets/img/混合写屏障13.225e69e7.png" alt="image"></p> <blockquote><p>olang中的混合写屏障满足弱三色不变式，结合了删除写屏障和插入写屏障的优点，只需要在开始时并发扫描各个goroutine的栈，使其变黑并一直保持，这个过程不需要STW，而标记结束后，因为栈在扫描后始终是黑色的，也无需再进行re-scan操作了，减少了STW的时间</p></blockquote> <h4 id="_3-5-对比总结"><a href="#_3-5-对比总结" class="header-anchor">#</a> 3.5 对比总结</h4> <ul><li><p>GoV1.3- 普通标记清除法，整体过程需要启动STW，效率极低。</p></li> <li><p>GoV1.5- 三色标记法， 堆空间启动写屏障，栈空间不启动，全部扫描之后，需要重新扫描一次栈(需要STW)，效率普通</p></li> <li><p>GoV1.8-三色标记法，混合写屏障机制， 栈空间不启动，堆空间启动。整个过程几乎不需要STW，效率较高</p></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">5/5/2023, 2:33:10 AM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/LearnDocsHtml/assets/js/app.0f1bd8f2.js" defer></script><script src="/LearnDocsHtml/assets/js/3.67df8e7b.js" defer></script><script src="/LearnDocsHtml/assets/js/2.084dc933.js" defer></script>
  </body>
</html>
