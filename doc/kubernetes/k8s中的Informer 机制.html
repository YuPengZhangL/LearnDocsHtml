<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>kubernetes中的informer机制 | YupengZ个人文档</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="开源技术资料整理">
    
    <link rel="preload" href="/LearnDocsHtml/assets/css/0.styles.0042faaf.css" as="style"><link rel="preload" href="/LearnDocsHtml/assets/js/app.0f1bd8f2.js" as="script"><link rel="preload" href="/LearnDocsHtml/assets/js/3.67df8e7b.js" as="script"><link rel="preload" href="/LearnDocsHtml/assets/js/47.f067c624.js" as="script"><link rel="prefetch" href="/LearnDocsHtml/assets/js/10.9deb6ef0.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/11.3e7a30f5.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/12.f0875641.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/13.23510c83.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/14.1f896a53.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/15.a162b02a.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/16.82837904.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/17.04907854.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/18.6ec2e925.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/19.82048133.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/2.084dc933.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/20.183aa861.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/21.33901b63.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/22.847aefdb.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/23.74ed3a9b.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/24.b6ba552b.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/25.1b9d230d.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/26.722cab78.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/27.1147dee1.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/28.f2857d64.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/29.11c8e912.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/30.129c224b.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/31.465857e6.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/32.182268cf.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/33.71679196.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/34.fe242440.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/35.8644ff0d.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/36.1f916d97.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/37.17fdfdba.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/38.7f72ddd5.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/39.048c9500.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/4.be19bd86.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/40.dd9db2e3.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/41.a1ab8356.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/42.beb5e602.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/43.dc67e933.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/44.0af8c02a.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/45.eb75ee6a.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/46.c5ce7e98.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/48.4bf4f48b.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/49.f0a75c7f.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/5.a338d993.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/50.03abd7d4.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/51.880e9109.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/52.c48b61d7.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/53.0059f21f.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/54.c5125de3.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/55.23d722dd.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/56.4a2270bb.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/57.8c988ee6.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/58.3a86a376.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/59.9fcb676b.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/6.9da9678c.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/60.24a5563f.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/61.3b2aaed9.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/62.339f6e71.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/63.1edaf49b.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/64.65ae4ca8.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/65.5f0e8f08.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/66.cfc630d1.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/67.f63acc95.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/68.a3f12ccf.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/69.88b6028b.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/7.c63f6924.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/70.ce51048a.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/71.7b143a95.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/72.d736ae69.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/73.f4164019.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/74.fe5ebe4a.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/8.3b044c8a.js"><link rel="prefetch" href="/LearnDocsHtml/assets/js/9.96e8b5d8.js">
    <link rel="stylesheet" href="/LearnDocsHtml/assets/css/0.styles.0042faaf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/LearnDocsHtml/" class="home-link router-link-active"><img src="/LearnDocsHtml/logo.jpg" alt="YupengZ个人文档" class="logo"> <span class="site-name can-hide">YupengZ个人文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="目录" class="dropdown-title"><span class="title">目录</span> <span class="arrow down"></span></button> <button type="button" aria-label="目录" class="mobile-dropdown-title"><span class="title">目录</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/docker/" class="nav-link">
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/es/" class="nav-link">
  ES
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/etcd/" class="nav-link">
  Etcd
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/kafka/" class="nav-link">
  Kafka
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/kubernetes/" class="nav-link router-link-active">
  Kubernetes
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/mongodb/" class="nav-link">
  mongodb
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/mysql/" class="nav-link">
  Mysql
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/network/" class="nav-link">
  Network
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/nginx/" class="nav-link">
  Nginx
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/postgresql/" class="nav-link">
  Postgresql
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/redis/" class="nav-link">
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/zookeeper/" class="nav-link">
  Zookeeper
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="目录" class="dropdown-title"><span class="title">目录</span> <span class="arrow down"></span></button> <button type="button" aria-label="目录" class="mobile-dropdown-title"><span class="title">目录</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/docker/" class="nav-link">
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/es/" class="nav-link">
  ES
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/etcd/" class="nav-link">
  Etcd
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/kafka/" class="nav-link">
  Kafka
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/kubernetes/" class="nav-link router-link-active">
  Kubernetes
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/mongodb/" class="nav-link">
  mongodb
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/mysql/" class="nav-link">
  Mysql
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/network/" class="nav-link">
  Network
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/nginx/" class="nav-link">
  Nginx
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/postgresql/" class="nav-link">
  Postgresql
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/redis/" class="nav-link">
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/LearnDocsHtml/doc/zookeeper/" class="nav-link">
  Zookeeper
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/LearnDocsHtml/doc/kubernetes/k8s 集群搭建.html" class="sidebar-link">虚拟机部署k8s集群</a></li><li><a href="/LearnDocsHtml/doc/kubernetes/k8s中的Informer 机制.html" class="active sidebar-link">kubernetes中的informer机制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/LearnDocsHtml/doc/kubernetes/k8s中的Informer 机制.html#引言" class="sidebar-link">引言</a></li><li class="sidebar-sub-header"><a href="/LearnDocsHtml/doc/kubernetes/k8s中的Informer 机制.html#一、informer介绍" class="sidebar-link">一、informer介绍</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/LearnDocsHtml/doc/kubernetes/k8s中的Informer 机制.html#_1-1-informer介绍" class="sidebar-link">1.1 informer介绍</a></li><li class="sidebar-sub-header"><a href="/LearnDocsHtml/doc/kubernetes/k8s中的Informer 机制.html#_1-2-informer架构说明" class="sidebar-link">1.2 informer架构说明</a></li><li class="sidebar-sub-header"><a href="/LearnDocsHtml/doc/kubernetes/k8s中的Informer 机制.html#_1-3-informer-demo" class="sidebar-link">1.3 informer demo</a></li></ul></li><li class="sidebar-sub-header"><a href="/LearnDocsHtml/doc/kubernetes/k8s中的Informer 机制.html#二、各组件源码分析" class="sidebar-link">二、各组件源码分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/LearnDocsHtml/doc/kubernetes/k8s中的Informer 机制.html#_2-1-refactor" class="sidebar-link">2.1 Refactor</a></li><li class="sidebar-sub-header"><a href="/LearnDocsHtml/doc/kubernetes/k8s中的Informer 机制.html#_2-2-deltafifo" class="sidebar-link">2.2 DeltaFIFO</a></li><li class="sidebar-sub-header"><a href="/LearnDocsHtml/doc/kubernetes/k8s中的Informer 机制.html#_2-3-indexer" class="sidebar-link">2.3 Indexer</a></li><li class="sidebar-sub-header"><a href="/LearnDocsHtml/doc/kubernetes/k8s中的Informer 机制.html#_2-4-sharedinformer" class="sidebar-link">2.4 SharedInformer</a></li><li class="sidebar-sub-header"><a href="/LearnDocsHtml/doc/kubernetes/k8s中的Informer 机制.html#_2-5-workqueue" class="sidebar-link">2.5 Workqueue</a></li></ul></li></ul></li><li><a href="/LearnDocsHtml/doc/kubernetes/kubernetes 核心.html" class="sidebar-link">Kubernetes设计架构</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/LearnDocsHtml/doc/kubernetes/kubernetes 核心.html#_1-kubernetes节点架构" class="sidebar-link">1. Kubernetes节点架构</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/LearnDocsHtml/doc/kubernetes/kubernetes 核心.html#_1-1-master-节点" class="sidebar-link">1.1 Master 节点</a></li><li class="sidebar-sub-header"><a href="/LearnDocsHtml/doc/kubernetes/kubernetes 核心.html#_1-2-node-节点" class="sidebar-link">1.2 Node 节点</a></li><li class="sidebar-sub-header"><a href="/LearnDocsHtml/doc/kubernetes/kubernetes 核心.html#_1-3-分层架构" class="sidebar-link">1.3 分层架构</a></li></ul></li><li class="sidebar-sub-header"><a href="/LearnDocsHtml/doc/kubernetes/kubernetes 核心.html#_2-基础组件" class="sidebar-link">2. 基础组件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/LearnDocsHtml/doc/kubernetes/kubernetes 核心.html#_2-1-kubelet" class="sidebar-link">2.1 kubelet</a></li><li class="sidebar-sub-header"><a href="/LearnDocsHtml/doc/kubernetes/kubernetes 核心.html#_2-2-kube-proxy" class="sidebar-link">2.2 kube-proxy</a></li><li class="sidebar-sub-header"><a href="/LearnDocsHtml/doc/kubernetes/kubernetes 核心.html#_2-3-kubernetes控制面板" class="sidebar-link">2.3 Kubernetes控制面板</a></li><li class="sidebar-sub-header"><a href="/LearnDocsHtml/doc/kubernetes/kubernetes 核心.html#_2-4-etcd" class="sidebar-link">2.4 etcd</a></li><li class="sidebar-sub-header"><a href="/LearnDocsHtml/doc/kubernetes/kubernetes 核心.html#_2-5-kubernetes-api-server" class="sidebar-link">2.5 Kubernetes API Server</a></li><li class="sidebar-sub-header"><a href="/LearnDocsHtml/doc/kubernetes/kubernetes 核心.html#_2-6-scheduler" class="sidebar-link">2.6 Scheduler</a></li><li class="sidebar-sub-header"><a href="/LearnDocsHtml/doc/kubernetes/kubernetes 核心.html#_2-7-kubernetes控制管理服务器" class="sidebar-link">2.7 Kubernetes控制管理服务器</a></li></ul></li><li class="sidebar-sub-header"><a href="/LearnDocsHtml/doc/kubernetes/kubernetes 核心.html#_3-kubernetes-核心组件" class="sidebar-link">3. Kubernetes 核心组件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/LearnDocsHtml/doc/kubernetes/kubernetes 核心.html#_3-1-pod" class="sidebar-link">3.1 pod</a></li><li class="sidebar-sub-header"><a href="/LearnDocsHtml/doc/kubernetes/kubernetes 核心.html#_3-2-deployment-控制器" class="sidebar-link">3.2 Deployment 控制器</a></li><li class="sidebar-sub-header"><a href="/LearnDocsHtml/doc/kubernetes/kubernetes 核心.html#_3-3-statefulset-控制器" class="sidebar-link">3.3 StatefulSet 控制器</a></li><li class="sidebar-sub-header"><a href="/LearnDocsHtml/doc/kubernetes/kubernetes 核心.html#_3-4-daemonset-控制器" class="sidebar-link">3.4 DaemonSet 控制器</a></li><li class="sidebar-sub-header"><a href="/LearnDocsHtml/doc/kubernetes/kubernetes 核心.html#_3-5-service" class="sidebar-link">3.5 Service</a></li><li class="sidebar-sub-header"><a href="/LearnDocsHtml/doc/kubernetes/kubernetes 核心.html#_3-6-ingress" class="sidebar-link">3.6 Ingress</a></li><li class="sidebar-sub-header"><a href="/LearnDocsHtml/doc/kubernetes/kubernetes 核心.html#_3-7" class="sidebar-link">3.7</a></li></ul></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="kubernetes中的informer机制"><a href="#kubernetes中的informer机制" class="header-anchor">#</a> kubernetes中的informer机制</h1> <h2 id="引言"><a href="#引言" class="header-anchor">#</a> 引言</h2> <p>使用k8s中list与watch来获取资源</p> <p>listwatch demo</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;context&quot;</span>
	<span class="token string">&quot;flag&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;os&quot;</span>
	<span class="token string">&quot;path/filepath&quot;</span>

	coreV1 <span class="token string">&quot;k8s.io/api/core/v1&quot;</span>

	metav1 <span class="token string">&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span>

	<span class="token string">&quot;k8s.io/client-go/kubernetes&quot;</span>
	<span class="token string">&quot;k8s.io/client-go/rest&quot;</span>
	<span class="token string">&quot;k8s.io/client-go/tools/clientcmd&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">getClientSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>kubernetes<span class="token punctuation">.</span>Clientset <span class="token punctuation">{</span>
	<span class="token keyword">var</span> err <span class="token builtin">error</span>
	<span class="token keyword">var</span> config <span class="token operator">*</span>rest<span class="token punctuation">.</span>Config
	<span class="token keyword">var</span> kubeConfig <span class="token operator">*</span><span class="token builtin">string</span>
	<span class="token keyword">if</span> home <span class="token operator">:=</span> <span class="token function">homeDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> home <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
		kubeConfig <span class="token operator">=</span> flag<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">&quot;kubeconfig&quot;</span><span class="token punctuation">,</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>home<span class="token punctuation">,</span> <span class="token string">&quot;.kube&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;config&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;(optional) absolute path to the kubeconfig file&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		kubeConfig <span class="token operator">=</span> flag<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">&quot;kubeconfig&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;absolute path to the kubeconfig file&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// 使用 ServiceAccount 创建集群配置（InCluster模式）</span>
	<span class="token keyword">if</span> config<span class="token punctuation">,</span> err <span class="token operator">=</span> rest<span class="token punctuation">.</span><span class="token function">InClusterConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token comment">// 使用 KubeConfig 文件创建集群配置</span>
		<span class="token keyword">if</span> config<span class="token punctuation">,</span> err <span class="token operator">=</span> clientcmd<span class="token punctuation">.</span><span class="token function">BuildConfigFromFlags</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token operator">*</span>kubeConfig<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 创建 clientSet</span>
	clientSet<span class="token punctuation">,</span> err <span class="token operator">:=</span> kubernetes<span class="token punctuation">.</span><span class="token function">NewForConfig</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> clientSet
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">homeDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> h <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Getenv</span><span class="token punctuation">(</span><span class="token string">&quot;HOME&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> h <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> h
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> os<span class="token punctuation">.</span><span class="token function">Getenv</span><span class="token punctuation">(</span><span class="token string">&quot;USERPROFILE&quot;</span><span class="token punctuation">)</span> <span class="token comment">// windows</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Must</span><span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	clientSet <span class="token operator">:=</span> <span class="token function">getClientSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// kubectl run --image=nginx nginx-app --port=80</span>
	podList<span class="token punctuation">,</span> err <span class="token operator">:=</span> clientSet<span class="token punctuation">.</span><span class="token function">CoreV1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Pods</span><span class="token punctuation">(</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> metav1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token function">Must</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>podList<span class="token punctuation">.</span>Items<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;当前命名空间下POD资源为空&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> pod <span class="token operator">:=</span> <span class="token keyword">range</span> podList<span class="token punctuation">.</span>Items <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;List获取到POD: %s\n&quot;</span><span class="token punctuation">,</span> pod<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;开始watch POD 变化...&quot;</span><span class="token punctuation">)</span>
	w<span class="token punctuation">,</span> err <span class="token operator">:=</span> clientSet<span class="token punctuation">.</span><span class="token function">CoreV1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Pods</span><span class="token punctuation">(</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Watch</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> metav1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token function">Must</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> w<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token keyword">select</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> event <span class="token operator">:=</span> <span class="token operator">&lt;-</span>w<span class="token punctuation">.</span><span class="token function">ResultChan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			pod<span class="token punctuation">,</span> ok <span class="token operator">:=</span> event<span class="token punctuation">.</span>Object<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>coreV1<span class="token punctuation">.</span>Pod<span class="token punctuation">)</span>
			<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Watch 到 %s 变化,EventType: %s\n&quot;</span><span class="token punctuation">,</span> pod<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> event<span class="token punctuation">.</span>Type<span class="token punctuation">)</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;------------&quot;</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 注意: 每次resourceVersion 都会增加</span>
<span class="token comment">//新增 ADD</span>
<span class="token comment">//修改 Modify  调度完成 绑定nodeName，更新status字段</span>
<span class="token comment">//修改 Modify  status 增加更多字段，主要是修改status的message信息，例如 &quot;containers with unready status: [nginx-app]&quot;</span>
<span class="token comment">//修改 Modify  从cni网络插件中获取到POD的ip地址并填充到status中，status的message置为空,修改pod运行状态为Running</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br></div></div><p><strong>分享内容</strong></p> <ul><li>list&amp;watch使用 informer介绍</li> <li>Reflector、DeltaFIFO、Indexer、ShardInformer、Workqueue各组件作用与源码走读</li> <li>使用informer实现一个自定义控制器</li></ul> <h2 id="一、informer介绍"><a href="#一、informer介绍" class="header-anchor">#</a> 一、informer介绍</h2> <p>做过业务开发的同学应该知道mysql与redis的关系，当我们访问量很大时，会有大量的请求发送到mysql，此时我们可以引入redis作为我们的缓存，将业务的热点数据存放到redis中，查询时直接从缓存中查询，大大减轻了对mysql的压力，</p> <p>对于k8s来讲也是一样的，在k8s中各个控制器或组件需要获取到各种资源对象，并且如果资源对象如果发生变化，控制器希望能进行自己逻辑处理，比如deployment控制器需要不断去维护pod数量与副本数的一致，如果每次都需要调用API获取资源或者使用watch启动一个长链接，会对APIserver造成很大的压力并且网络调用速度会相对慢一些，</p> <p>此时我们需要一个类似redis一样的缓存机制来缓存我们k8s中的资源对象，并且如果资源对象发生变化，通过回调函数通知到控制器执行逻辑，Informers 的内存缓存就是来解决这个问题的</p> <p>使用informer与不使用 对比 (by 白总)</p> <p>https://github.com/chenghongxi/kubernetes-learning/tree/master/informer</p> <p>所有演示代码仓库： https://github.com/noovertime7/dailytest.git</p> <p>informer各组件代码位置: https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/client-go/tools/cache/delta_fifo.go</p> <p>貔貅小分队主页  https://space.bilibili.com/3493104248162809</p> <p>多集群管理平台gopixiu  https://github.com/caoyingjunz/gopixiu</p> <p>k8s极速小白部署工具  https://github.com/caoyingjunz/kubez-ansible.git</p> <h3 id="_1-1-informer介绍"><a href="#_1-1-informer介绍" class="header-anchor">#</a> 1.1 informer介绍</h3> <p><img src="https://www.notion.so/image/https%3A%2F%2Fbxdc-static.oss-cn-beijing.aliyuncs.com%2Fimages%2F20200727110511.png?id=31da04d6-8556-422b-8e9e-834ced020572&amp;table=block&amp;spaceId=dbc99cc1-a8f6-4ded-bd01-465426f678b3&amp;width=2000&amp;userId=&amp;cache=v2" alt="img"></p> <p>如上图展示了 Informer 的基本处理流程：</p> <ul><li>以 <a href="https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/apimachinery/pkg/watch/watch.go" target="_blank" rel="noopener noreferrer">events 事件<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的方式从 APIServer 获取数据</li> <li>提供一个类似客户端的 Lister 接口，从内存缓存(Informer)中 get 和 list 对象</li> <li>为添加、删除、更新注册事件处理程序</li></ul> <h3 id="_1-2-informer架构说明"><a href="#_1-2-informer架构说明" class="header-anchor">#</a> 1.2 informer架构说明</h3> <p><img src="https://img-blog.csdnimg.cn/img_convert/f52e6ddabe7b8e2dc688f07d6c36c460.png" alt="img"></p> <p><img src="https://www.notion.so/image/https%3A%2F%2Fbxdc-static.oss-cn-beijing.aliyuncs.com%2Fimages%2Fclient-go-controller-interaction.jpeg?id=ca324b0f-33c8-406c-8fc8-81dfc537172d&amp;table=block&amp;spaceId=dbc99cc1-a8f6-4ded-bd01-465426f678b3&amp;width=2000&amp;userId=&amp;cache=v2" alt="img"></p> <ol><li>首先初始化 Informer，Reflector 通过 List 接口获取所有的 Pod 对象</li> <li>Reflector 拿到所有 Pod 后，将全部 Pod 放到 Store（本地缓存）中</li> <li>如果有人调用 Lister 的 List/Get 方法获取 Pod，那么 Lister 直接从 Store 中去拿数据</li> <li>Informer 初始化完成后，Reflector 开始 Watch Pod 相关的事件</li> <li>此时如果我们删除 Pod1，那么 Reflector 会监听到这个事件，然后将这个事件发送到 DeltaFIFO 中</li> <li>DeltaFIFO 首先先将这个事件存储在一个队列中，然后去操作 Store 中的数据，删除其中的 Pod1</li> <li>DeltaFIFO 然后 Pop 这个事件到事件处理器（资源事件处理器）中进行处理</li> <li>LocalStore 会周期性地把所有的 Pod 信息重新放回 DeltaFIFO 中去</li></ol> <p><strong>Reflector（反射器）</strong> <code>生产者</code></p> <p>Reflector 用于监控（Watch）指定的 Kubernetes 资源，当监控的资源发生变化时，触发相应的变更事件，例如 Add 事件、Update 事件、Delete 事件，并将其资源对象存放到本地缓存 DeltaFIFO 中。</p> <p><strong>DeltaFIFO</strong>  : <code>一个存储Delta类型数据的FIFO</code></p> <p>DeltaFIFO 是一个生产者-消费者的队列，生产者是 Reflector，消费者是 Pop 函数，FIFO 是一个先进先出的队列，而 Delta 是一个资源对象存储，它可以保存资源对象的操作类型，例如 Add 操作类型、Update 操作类型、Delete 操作类型、Sync 操作类型等。</p> <p><strong>Indexer</strong>  : <code>一个实现了index功能的store</code></p> <p>Indexer 是 client-go 用来存储资源对象并自带索引功能的本地存储，Informer(sharedIndexInformer) 从 DeltaFIFO 中将消费出来的资源对象存储至 Indexer。Indexer 与 Etcd 集群中的数据保持完全一致。这样我们就可以很方便地从本地存储中读取相应的资源对象数据，而无须每次从远程 APIServer 中读取，以减轻服务器的压力。</p> <p>这里理论知识太多，直接去查看源码显得有一定困难，我们可以用一个实际的示例来进行说明，比如现在我们删除一个 Pod，一个 Informers 的执行流程是怎样的：</p> <ol><li></li></ol> <p><strong>源码级详细理解</strong></p> <p><img src="https://img-blog.csdnimg.cn/img_convert/87411b7508e784a071e642ec42ce6dd6.png" alt="img"></p> <h3 id="_1-3-informer-demo"><a href="#_1-3-informer-demo" class="header-anchor">#</a> 1.3 informer demo</h3> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;flag&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;os&quot;</span>
	<span class="token string">&quot;path/filepath&quot;</span>
    
    v1 <span class="token string">&quot;k8s.io/api/core/v1&quot;</span>
	<span class="token string">&quot;k8s.io/apimachinery/pkg/labels&quot;</span>
	<span class="token string">&quot;k8s.io/client-go/informers&quot;</span>
	<span class="token string">&quot;k8s.io/client-go/kubernetes&quot;</span>
	<span class="token string">&quot;k8s.io/client-go/rest&quot;</span>
	<span class="token string">&quot;k8s.io/client-go/tools/cache&quot;</span>
	<span class="token string">&quot;k8s.io/client-go/tools/clientcmd&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">getClientSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>kubernetes<span class="token punctuation">.</span>Clientset <span class="token punctuation">{</span>
	<span class="token keyword">var</span> err <span class="token builtin">error</span>
	<span class="token keyword">var</span> config <span class="token operator">*</span>rest<span class="token punctuation">.</span>Config
	<span class="token keyword">var</span> kubeConfig <span class="token operator">*</span><span class="token builtin">string</span>
	<span class="token keyword">if</span> home <span class="token operator">:=</span> <span class="token function">homeDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> home <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
		kubeConfig <span class="token operator">=</span> flag<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">&quot;kubeconfig&quot;</span><span class="token punctuation">,</span> filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>home<span class="token punctuation">,</span> <span class="token string">&quot;.kube&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;config&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;(optional) absolute path to the kubeconfig file&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		kubeConfig <span class="token operator">=</span> flag<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">&quot;kubeconfig&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;absolute path to the kubeconfig file&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// 使用 ServiceAccount 创建集群配置（InCluster模式）</span>
	<span class="token keyword">if</span> config<span class="token punctuation">,</span> err <span class="token operator">=</span> rest<span class="token punctuation">.</span><span class="token function">InClusterConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token comment">// 使用 KubeConfig 文件创建集群配置</span>
		<span class="token keyword">if</span> config<span class="token punctuation">,</span> err <span class="token operator">=</span> clientcmd<span class="token punctuation">.</span><span class="token function">BuildConfigFromFlags</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token operator">*</span>kubeConfig<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 创建 clientSet</span>
	clientSet<span class="token punctuation">,</span> err <span class="token operator">:=</span> kubernetes<span class="token punctuation">.</span><span class="token function">NewForConfig</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> clientSet
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">homeDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> h <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Getenv</span><span class="token punctuation">(</span><span class="token string">&quot;HOME&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> h <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> h
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> os<span class="token punctuation">.</span><span class="token function">Getenv</span><span class="token punctuation">(</span><span class="token string">&quot;USERPROFILE&quot;</span><span class="token punctuation">)</span> <span class="token comment">// windows</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	clientSet <span class="token operator">:=</span> <span class="token function">getClientSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	factory <span class="token operator">:=</span> informers<span class="token punctuation">.</span><span class="token function">NewSharedInformerFactoryWithOptions</span><span class="token punctuation">(</span>clientSet<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	podInformer <span class="token operator">:=</span> factory<span class="token punctuation">.</span><span class="token function">Core</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Pods</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// 向factory注册podInformer</span>
	informer <span class="token operator">:=</span> podInformer<span class="token punctuation">.</span><span class="token function">Informer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	indexer <span class="token operator">:=</span> podInformer<span class="token punctuation">.</span><span class="token function">Lister</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	informer<span class="token punctuation">.</span><span class="token function">AddEventHandler</span><span class="token punctuation">(</span>cache<span class="token punctuation">.</span>ResourceEventHandlerFuncs<span class="token punctuation">{</span>
		AddFunc<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;add&quot;</span><span class="token punctuation">,</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">)</span><span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		UpdateFunc<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>oldObj<span class="token punctuation">,</span> newObj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;update&quot;</span><span class="token punctuation">,</span> oldObj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">)</span><span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		DeleteFunc<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;delete&quot;</span><span class="token punctuation">,</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">)</span><span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token comment">// 可以添加多个EventHandler</span>
	informer<span class="token punctuation">.</span><span class="token function">AddEventHandler</span><span class="token punctuation">(</span>cache<span class="token punctuation">.</span>ResourceEventHandlerFuncs<span class="token punctuation">{</span>
		AddFunc<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;add2&quot;</span><span class="token punctuation">,</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">)</span><span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	stopCh <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token comment">// 启动factory</span>
	factory<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>stopCh<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>stopCh<span class="token punctuation">)</span>
	<span class="token comment">//等待所有的informer同步完成</span>
	factory<span class="token punctuation">.</span><span class="token function">WaitForCacheSync</span><span class="token punctuation">(</span>stopCh<span class="token punctuation">)</span>

	pods<span class="token punctuation">,</span> err <span class="token operator">:=</span> indexer<span class="token punctuation">.</span><span class="token function">Pods</span><span class="token punctuation">(</span>v1<span class="token punctuation">.</span>NamespaceAll<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span>labels<span class="token punctuation">.</span><span class="token function">Everything</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalln</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">for</span> index<span class="token punctuation">,</span> pod <span class="token operator">:=</span> <span class="token keyword">range</span> pods <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token string">&quot;-&gt;&quot;</span><span class="token punctuation">,</span> pod<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br></div></div><h2 id="二、各组件源码分析"><a href="#二、各组件源码分析" class="header-anchor">#</a> 二、各组件源码分析</h2> <h3 id="_2-1-refactor"><a href="#_2-1-refactor" class="header-anchor">#</a> 2.1 Refactor</h3> <h4 id="_2-1-1-reflector-源码分析"><a href="#_2-1-1-reflector-源码分析" class="header-anchor">#</a> 2.1.1 Reflector 源码分析</h4> <p>前面我们说了 Informer 通过对 APIServer 的资源对象执行 List 和 Watch 操作，把获取到的数据存储在本地的缓存中，其中实现这个的核心功能就是 Reflector，我们可以称其为反射器，就是将 Etcd 里面的数据反射到本地存储（DeltaFIFO）中。Reflector 首先通过 List 操作获取所有的资源对象数据，保存到本地存储，然后通过 Watch 操作监控资源的变化，触发相应的事件处理，比如前面示例中的 Add 事件、Update 事件、Delete 事件。</p> <p>Reflector 结构体的定义位于 <code>staging/src/k8s.io/client-go/tools/cache/reflector.go</code> 下面：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// Reflector(反射器) 监听指定的资源，将所有的变化都反射到给定的存储中去</span>
<span class="token keyword">type</span> Reflector <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token comment">// name 标识这个反射器的名称，默认为 文件:行数（比如reflector.go:125）</span>
  <span class="token comment">// 默认名字通过 k8s.io/apimachinery/pkg/util/naming/from_stack.go 下面的 GetNameFromCallsite 函数生成</span>
	name <span class="token builtin">string</span>

  <span class="token comment">// 期望放到 Store 中的类型名称，如果提供，则是 expectedGVK 的字符串形式</span>
  <span class="token comment">// 否则就是 expectedType 的字符串，它仅仅用于显示，不用于解析或者比较。</span>
	expectedTypeName <span class="token builtin">string</span>
	<span class="token comment">// An example object of the type we expect to place in the store.</span>
	<span class="token comment">// Only the type needs to be right, except that when that is</span>
	<span class="token comment">// `unstructured.Unstructured` the object's `&quot;apiVersion&quot;` and</span>
	<span class="token comment">// `&quot;kind&quot;` must also be right.</span>
  <span class="token comment">// 我们放到 Store 中的对象类型</span>
	expectedType reflect<span class="token punctuation">.</span>Type
	<span class="token comment">// 如果是非结构化的，我们期望放在 Sotre 中的对象的 GVK</span>
	expectedGVK <span class="token operator">*</span>schema<span class="token punctuation">.</span>GroupVersionKind
	<span class="token comment">// 与 watch 源同步的目标 Store</span>
	store Store
	<span class="token comment">// 用来执行 lists 和 watches 操作的 listerWatcher 接口（最重要的）</span>
	listerWatcher ListerWatcher

	<span class="token comment">// backoff manages backoff of ListWatch</span>
	backoffManager wait<span class="token punctuation">.</span>BackoffManager

	resyncPeriod time<span class="token punctuation">.</span>Duration
	<span class="token comment">// ShouldResync 会周期性的被调用，当返回 true 的时候，就会调用 Store 的 Resync 操作</span>
	ShouldResync <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
	<span class="token comment">// clock allows tests to manipulate time</span>
	clock clock<span class="token punctuation">.</span>Clock
	<span class="token comment">// paginatedResult defines whether pagination should be forced for list calls.</span>
	<span class="token comment">// It is set based on the result of the initial list call.</span>
	paginatedResult <span class="token builtin">bool</span>
	<span class="token comment">// Kubernetes 资源在 APIServer 中都是有版本的，对象的任何修改(添加、删除、更新)都会造成资源版本更新，lastSyncResourceVersion 就是指的这个版本</span>
	lastSyncResourceVersion <span class="token builtin">string</span>
	<span class="token comment">// 如果之前的 list 或 watch 带有 lastSyncResourceVersion 的请求中是一个 HTTP 410（Gone）的失败请求，则 isLastSyncResourceVersionGone 为 true</span>
	isLastSyncResourceVersionGone <span class="token builtin">bool</span>
	<span class="token comment">// lastSyncResourceVersionMutex 用于保证对 lastSyncResourceVersion 的读/写访问。</span>
	lastSyncResourceVersionMutex sync<span class="token punctuation">.</span>RWMutex
	<span class="token comment">// WatchListPageSize is the requested chunk size of initial and resync watch lists.</span>
	<span class="token comment">// If unset, for consistent reads (RV=&quot;&quot;) or reads that opt-into arbitrarily old data</span>
	<span class="token comment">// (RV=&quot;0&quot;) it will default to pager.PageSize, for the rest (RV != &quot;&quot; &amp;&amp; RV != &quot;0&quot;)</span>
	<span class="token comment">// it will turn off pagination to allow serving them from watch cache.</span>
	<span class="token comment">// NOTE: It should be used carefully as paginated lists are always served directly from</span>
	<span class="token comment">// etcd, which is significantly less efficient and may lead to serious performance and</span>
	<span class="token comment">// scalability problems.</span>
	WatchListPageSize <span class="token builtin">int64</span>
<span class="token punctuation">}</span>

<span class="token comment">// NewReflector 创建一个新的反射器对象，将使给定的 Store 保持与服务器中指定的资源对象的内容同步。</span>
<span class="token comment">// 反射器只把具有 expectedType 类型的对象放到 Store 中，除非 expectedType 是 nil。</span>
<span class="token comment">// 如果 resyncPeriod 是非0，那么反射器会周期性地检查 ShouldResync 函数来决定是否调用 Store 的 Resync 操作</span>
<span class="token comment">// `ShouldResync==nil` 意味着总是要执行 Resync 操作。</span>
<span class="token comment">// 这使得你可以使用反射器周期性地处理所有的全量和增量的对象。</span>
<span class="token keyword">func</span> <span class="token function">NewReflector</span><span class="token punctuation">(</span>lw ListerWatcher<span class="token punctuation">,</span> expectedType <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> store Store<span class="token punctuation">,</span> resyncPeriod time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> <span class="token operator">*</span>Reflector <span class="token punctuation">{</span>
  <span class="token comment">// 默认的反射器名称为 file:line</span>
	<span class="token keyword">return</span> <span class="token function">NewNamedReflector</span><span class="token punctuation">(</span>naming<span class="token punctuation">.</span><span class="token function">GetNameFromCallsite</span><span class="token punctuation">(</span>internalPackages<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lw<span class="token punctuation">,</span> expectedType<span class="token punctuation">,</span> store<span class="token punctuation">,</span> resyncPeriod<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// NewNamedReflector 与 NewReflector 一样，只是指定了一个 name 用于日志记录</span>
<span class="token keyword">func</span> <span class="token function">NewNamedReflector</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> lw ListerWatcher<span class="token punctuation">,</span> expectedType <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> store Store<span class="token punctuation">,</span> resyncPeriod time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> <span class="token operator">*</span>Reflector <span class="token punctuation">{</span>
	realClock <span class="token operator">:=</span> <span class="token operator">&amp;</span>clock<span class="token punctuation">.</span>RealClock<span class="token punctuation">{</span><span class="token punctuation">}</span>
	r <span class="token operator">:=</span> <span class="token operator">&amp;</span>Reflector<span class="token punctuation">{</span>
		name<span class="token punctuation">:</span>          name<span class="token punctuation">,</span>
		listerWatcher<span class="token punctuation">:</span> lw<span class="token punctuation">,</span>
		store<span class="token punctuation">:</span>         store<span class="token punctuation">,</span>
		backoffManager<span class="token punctuation">:</span> wait<span class="token punctuation">.</span><span class="token function">NewExponentialBackoffManager</span><span class="token punctuation">(</span><span class="token number">800</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">,</span> <span class="token number">30</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Minute<span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> realClock<span class="token punctuation">)</span><span class="token punctuation">,</span>
		resyncPeriod<span class="token punctuation">:</span>   resyncPeriod<span class="token punctuation">,</span>
		clock<span class="token punctuation">:</span>          realClock<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	r<span class="token punctuation">.</span><span class="token function">setExpectedType</span><span class="token punctuation">(</span>expectedType<span class="token punctuation">)</span>
	<span class="token keyword">return</span> r
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br></div></div><p>从源码中我们可以看出来通过 <code>NewReflector 实例化反射器的时候，必须传入一个ListerWatcher 接口对象，这个也是反射器最核心的功能，该接口拥有</code> <code>List</code> 和 <code>Watch</code> 方法，用于获取和监控资源对象</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/listwatch.go</span>

<span class="token comment">// Lister 是知道如何执行初始化List列表的对象</span>
<span class="token keyword">type</span> Lister <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token comment">// List 应该返回一个列表类型的对象；</span>
  <span class="token comment">// Items 字段将被解析，ResourceVersion 字段将被用于正确启动 watch 的地方</span>
	<span class="token function">List</span><span class="token punctuation">(</span>options metav1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span>runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Watcher 是知道如何执行 watch 操作的任何对象</span>
<span class="token keyword">type</span> Watcher <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token comment">// Watch 在指定的版本开始执行 watch 操作</span>
	<span class="token function">Watch</span><span class="token punctuation">(</span>options metav1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span>watch<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// ListerWatcher 是任何知道如何对一个资源执行初始化List列表和启动Watch监控操作的对象</span>
<span class="token keyword">type</span> ListerWatcher <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	Lister
	Watcher
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>而 Reflector 对象通过 Run 函数来启动监控并处理监控事件的：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/reflector.go</span>

<span class="token comment">// Run 函数反复使用反射器的 ListAndWatch 函数来获取所有对象和后续的 deltas。</span>
<span class="token comment">// 当 stopCh 被关闭的时候，Run函数才会退出。</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Reflector<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span>stopCh <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;Starting reflector %s (%s) from %s&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>expectedTypeName<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resyncPeriod<span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
	wait<span class="token punctuation">.</span><span class="token function">BackoffUntil</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">ListAndWatch</span><span class="token punctuation">(</span>stopCh<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			utilruntime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>backoffManager<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> stopCh<span class="token punctuation">)</span>
	klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;Stopping reflector %s (%s) from %s&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>expectedTypeName<span class="token punctuation">,</span> r<span class="token punctuation">.</span>resyncPeriod<span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>所以不管我们传入的<code>ListWatcher</code>对象是如何实现的 List 和 Watch 操作，只要实现了就可以，最主要的还是看 ListAndWatch 函数是如何去实现的，如何去调用 List 和 Watch 的：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/reflector.go</span>

<span class="token comment">// ListAndWatch 函数首先列出所有的对象，并在调用的时候获得资源版本，然后使用该资源版本来进行 watch 操作。</span>
<span class="token comment">// 如果 ListAndWatch 没有初始化 watch 成功就会返回错误。</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Reflector<span class="token punctuation">)</span> <span class="token function">ListAndWatch</span><span class="token punctuation">(</span>stopCh <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;Listing and watching %v from %s&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>expectedTypeName<span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
	<span class="token keyword">var</span> resourceVersion <span class="token builtin">string</span>

	options <span class="token operator">:=</span> metav1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">{</span>ResourceVersion<span class="token punctuation">:</span> r<span class="token punctuation">.</span><span class="token function">relistResourceVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>

	<span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
		initTrace <span class="token operator">:=</span> trace<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;Reflector ListAndWatch&quot;</span><span class="token punctuation">,</span> trace<span class="token punctuation">.</span>Field<span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token keyword">defer</span> initTrace<span class="token punctuation">.</span><span class="token function">LogIfLong</span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
		<span class="token keyword">var</span> list runtime<span class="token punctuation">.</span>Object
		<span class="token keyword">var</span> paginatedResult <span class="token builtin">bool</span>
		<span class="token keyword">var</span> err <span class="token builtin">error</span>
		listCh <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
		panicCh <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> r <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> r <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
					panicCh <span class="token operator">&lt;-</span> r
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	    <span class="token comment">// 如果 listWatcher 支持，会尝试 chunks（分块）收集 List 列表数据</span>
      <span class="token comment">// 如果不支持，第一个 List 列表请求将返回完整的响应数据。</span>
			pager <span class="token operator">:=</span> pager<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>pager<span class="token punctuation">.</span><span class="token function">SimplePageFunc</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>opts metav1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span>runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> r<span class="token punctuation">.</span>listerWatcher<span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span>opts<span class="token punctuation">)</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">switch</span> <span class="token punctuation">{</span>
			<span class="token keyword">case</span> r<span class="token punctuation">.</span>WatchListPageSize <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
				pager<span class="token punctuation">.</span>PageSize <span class="token operator">=</span> r<span class="token punctuation">.</span>WatchListPageSize
			<span class="token keyword">case</span> r<span class="token punctuation">.</span>paginatedResult<span class="token punctuation">:</span>
        <span class="token comment">// 获得一个初始的分页结果。假定此资源和服务器符合分页请求，并保留默认的分页器大小设置</span>
			<span class="token keyword">case</span> options<span class="token punctuation">.</span>ResourceVersion <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>ResourceVersion <span class="token operator">!=</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">:</span>
				pager<span class="token punctuation">.</span>PageSize <span class="token operator">=</span> <span class="token number">0</span>
			<span class="token punctuation">}</span>

			list<span class="token punctuation">,</span> paginatedResult<span class="token punctuation">,</span> err <span class="token operator">=</span> pager<span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span>
			<span class="token keyword">if</span> <span class="token function">isExpiredError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				r<span class="token punctuation">.</span><span class="token function">setIsLastSyncResourceVersionExpired</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
				list<span class="token punctuation">,</span> paginatedResult<span class="token punctuation">,</span> err <span class="token operator">=</span> pager<span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> metav1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">{</span>ResourceVersion<span class="token punctuation">:</span> r<span class="token punctuation">.</span><span class="token function">relistResourceVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			<span class="token function">close</span><span class="token punctuation">(</span>listCh<span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">select</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>stopCh<span class="token punctuation">:</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token keyword">case</span> r <span class="token operator">:=</span> <span class="token operator">&lt;-</span>panicCh<span class="token punctuation">:</span>
			<span class="token function">panic</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>listCh<span class="token punctuation">:</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;%s: Failed to list %v: %v&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">,</span> r<span class="token punctuation">.</span>expectedTypeName<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">if</span> options<span class="token punctuation">.</span>ResourceVersion <span class="token operator">==</span> <span class="token string">&quot;0&quot;</span> <span class="token operator">&amp;&amp;</span> paginatedResult <span class="token punctuation">{</span>
			r<span class="token punctuation">.</span>paginatedResult <span class="token operator">=</span> <span class="token boolean">true</span>
		<span class="token punctuation">}</span>

		r<span class="token punctuation">.</span><span class="token function">setIsLastSyncResourceVersionExpired</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token comment">// list 成功</span>
		initTrace<span class="token punctuation">.</span><span class="token function">Step</span><span class="token punctuation">(</span><span class="token string">&quot;Objects listed&quot;</span><span class="token punctuation">)</span>
		listMetaInterface<span class="token punctuation">,</span> err <span class="token operator">:=</span> meta<span class="token punctuation">.</span><span class="token function">ListAccessor</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;%s: Unable to understand list result %#v: %v&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">,</span> list<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
    <span class="token comment">// 获取资源版本号</span>
		resourceVersion <span class="token operator">=</span> listMetaInterface<span class="token punctuation">.</span><span class="token function">GetResourceVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		initTrace<span class="token punctuation">.</span><span class="token function">Step</span><span class="token punctuation">(</span><span class="token string">&quot;Resource version extracted&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">// 将资源数据转换成资源对象列表，将 runtime.Object 对象转换成 []runtime.Object 对象</span>
		items<span class="token punctuation">,</span> err <span class="token operator">:=</span> meta<span class="token punctuation">.</span><span class="token function">ExtractList</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;%s: Unable to understand list result %#v (%v)&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">,</span> list<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		initTrace<span class="token punctuation">.</span><span class="token function">Step</span><span class="token punctuation">(</span><span class="token string">&quot;Objects extracted&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">// 将资源对象列表中的资源对象和资源版本号存储在 Store 中</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">syncWith</span><span class="token punctuation">(</span>items<span class="token punctuation">,</span> resourceVersion<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;%s: Unable to sync list result: %v&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		initTrace<span class="token punctuation">.</span><span class="token function">Step</span><span class="token punctuation">(</span><span class="token string">&quot;SyncWith done&quot;</span><span class="token punctuation">)</span>
		r<span class="token punctuation">.</span><span class="token function">setLastSyncResourceVersion</span><span class="token punctuation">(</span>resourceVersion<span class="token punctuation">)</span>
		initTrace<span class="token punctuation">.</span><span class="token function">Step</span><span class="token punctuation">(</span><span class="token string">&quot;Resource version updated&quot;</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>

	resyncerrc <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">error</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
	cancelCh <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>cancelCh<span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		resyncCh<span class="token punctuation">,</span> cleanup <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">resyncChan</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
		<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token punctuation">{</span>
			<span class="token keyword">select</span> <span class="token punctuation">{</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>resyncCh<span class="token punctuation">:</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>stopCh<span class="token punctuation">:</span>
				<span class="token keyword">return</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>cancelCh<span class="token punctuation">:</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
      <span class="token comment">// 如果 ShouldResync 为 nil 或者调用返回true，则执行 Store 的 Resync 操作</span>
			<span class="token keyword">if</span> r<span class="token punctuation">.</span>ShouldResync <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> r<span class="token punctuation">.</span><span class="token function">ShouldResync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;%s: forcing resync&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
				<span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">Resync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
					resyncerrc <span class="token operator">&lt;-</span> err
					<span class="token keyword">return</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			resyncCh<span class="token punctuation">,</span> cleanup <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">resyncChan</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token comment">// stopCh 一个停止循环的机会</span>
		<span class="token keyword">select</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>stopCh<span class="token punctuation">:</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token punctuation">}</span>

		timeoutSeconds <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span>minWatchTimeout<span class="token punctuation">.</span><span class="token function">Seconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>rand<span class="token punctuation">.</span><span class="token function">Float64</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token comment">// 设置watch的选项，因为前期列举了全量对象，从这里只要监听最新版本以后的资源就可以了</span>
    <span class="token comment">// 如果没有资源变化总不能一直挂着吧？也不知道是卡死了还是怎么了，所以设置一个超时会好一点</span>
		options <span class="token operator">=</span> metav1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">{</span>
			ResourceVersion<span class="token punctuation">:</span> resourceVersion<span class="token punctuation">,</span>
			TimeoutSeconds<span class="token punctuation">:</span> <span class="token operator">&amp;</span>timeoutSeconds<span class="token punctuation">,</span>
			AllowWatchBookmarks<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span>

		start <span class="token operator">:=</span> r<span class="token punctuation">.</span>clock<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 执行 Watch 操作</span>
		w<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span>listerWatcher<span class="token punctuation">.</span><span class="token function">Watch</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">switch</span> <span class="token punctuation">{</span>
			<span class="token keyword">case</span> <span class="token function">isExpiredError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">:</span>
				klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;%s: watch of %v closed with: %v&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">,</span> r<span class="token punctuation">.</span>expectedTypeName<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token keyword">case</span> err <span class="token operator">==</span> io<span class="token punctuation">.</span>EOF<span class="token punctuation">:</span>
				<span class="token comment">// watch closed normally</span>
			<span class="token keyword">case</span> err <span class="token operator">==</span> io<span class="token punctuation">.</span>ErrUnexpectedEOF<span class="token punctuation">:</span>
				klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;%s: Watch for %v closed with unexpected EOF: %v&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">,</span> r<span class="token punctuation">.</span>expectedTypeName<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token keyword">default</span><span class="token punctuation">:</span>
				utilruntime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;%s: Failed to watch %v: %v&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">,</span> r<span class="token punctuation">.</span>expectedTypeName<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> utilnet<span class="token punctuation">.</span><span class="token function">IsConnectionRefused</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 调用 watchHandler 来处理分发 watch 到的事件对象</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">watchHandler</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> w<span class="token punctuation">,</span> <span class="token operator">&amp;</span>resourceVersion<span class="token punctuation">,</span> resyncerrc<span class="token punctuation">,</span> stopCh<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> err <span class="token operator">!=</span> errorStopRequested <span class="token punctuation">{</span>
				<span class="token keyword">switch</span> <span class="token punctuation">{</span>
				<span class="token keyword">case</span> <span class="token function">isExpiredError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">:</span>
					klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;%s: watch of %v closed with: %v&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">,</span> r<span class="token punctuation">.</span>expectedTypeName<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
				<span class="token keyword">default</span><span class="token punctuation">:</span>
					klog<span class="token punctuation">.</span><span class="token function">Warningf</span><span class="token punctuation">(</span><span class="token string">&quot;%s: watch of %v ended with: %v&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>name<span class="token punctuation">,</span> r<span class="token punctuation">.</span>expectedTypeName<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br></div></div><p>上面的 ListAndWatch 函数实现看上去虽然非常复杂，但其实大部分是对分页的各种情况进行处理，最核心的还是调用 <code>r.listerWatcher.List(opts)</code> 获取全量的资源对象，而这个 List 其实 ListerWatcher 实现的 List 方法，这个 ListerWatcher 接口实际上在该接口定义的同一个文件中就有一个 ListWatch 结构体实现了：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/listwatch.go</span>

<span class="token comment">// ListFunc 知道如何 List 资源</span>
<span class="token keyword">type</span> ListFunc <span class="token keyword">func</span><span class="token punctuation">(</span>options metav1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span>runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>

<span class="token comment">// WatchFunc 知道如何 watch 资源</span>
<span class="token keyword">type</span> WatchFunc <span class="token keyword">func</span><span class="token punctuation">(</span>options metav1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span>watch<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>

<span class="token comment">// ListWatch 结构体知道如何 list 和 watch 资源对象，它实现了 ListerWatcher 接口。</span>
<span class="token comment">// 它为 NewReflector 使用者提供了方便的函数。其中 ListFunc 和 WatchFunc 不能为 nil。</span>
<span class="token keyword">type</span> ListWatch <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	ListFunc  ListFunc
	WatchFunc WatchFunc
	<span class="token comment">// DisableChunking 对 list watcher 请求不分块。</span>
	DisableChunking <span class="token builtin">bool</span>
<span class="token punctuation">}</span>

<span class="token comment">// 列出一组 APIServer 资源</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>lw <span class="token operator">*</span>ListWatch<span class="token punctuation">)</span> <span class="token function">List</span><span class="token punctuation">(</span>options metav1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span>runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> lw<span class="token punctuation">.</span><span class="token function">ListFunc</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Watch 一组 APIServer 资源</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>lw <span class="token operator">*</span>ListWatch<span class="token punctuation">)</span> <span class="token function">Watch</span><span class="token punctuation">(</span>options metav1<span class="token punctuation">.</span>ListOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span>watch<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> lw<span class="token punctuation">.</span><span class="token function">WatchFunc</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>当我们真正使用一个 Informer 对象的时候，实例化的时候就会调用这里的 ListWatch 来进行初始化</p> <h4 id="_2-1-2-流程总结"><a href="#_2-1-2-流程总结" class="header-anchor">#</a> 2.1.2 流程总结</h4> <p>比如我们要获取deployment资源</p> <ol><li><p>deployment Informer会向factory通过进行注册</p></li> <li><p>调用上面的 NewFilteredDeploymentInformer 函数进行初始化，而在初始化的使用就传入了 cache.ListWatch 对象，其中就有 List 和 Watch 的实现操作</p></li> <li><p>获取到了全量的 List 数据过后，通过 <code>listMetaInterface.GetResourceVersion()</code> 来获取资源的版本号</p></li></ol> <div class="language- line-numbers-mode"><pre class="language-text"><code>ResourceVersion（资源版本号）非常重要，Kubernetes 中所有的资源都拥有该字段，它标识当前资源对象的版本号，每次修改（CUD）当前资源对象时，Kubernetes API Server 都会更改 ResourceVersion，这样 client-go 执行 Watch 操作时可以根据ResourceVersion 来确定当前资源对象是否发生了变化。 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="3"><li><code>meta.ExtractList</code> 函数将资源数据转换成资源对象列表</li> <li><code>syncWith</code> 函数将资源对象列表中的资源对象和资源版本号存储在 Store 中</li> <li>通过 <code>r.setLastSyncResourceVersion(resourceVersion)</code> 操作来设置最新的资源版本号，其他的就是启动一个 goroutine 去定期检查是否需要执行 Resync 操作，调用存储中的 <code>r.store.Resync()</code> 来执行</li> <li>Watch 操作通过 HTTP 协议与 APIServer 建立长连接，接收Kubernetes API Server 发来的资源变更事件，和 List 操作一样，Watch 的真正实现也是具体的 Informer 初始化的时候传入的</li></ol> <div class="language- line-numbers-mode"><pre class="language-text"><code>获得 watch 的资源数据后，通过调用 r.watchHandler 来处理资源的变更事件，当触发Add 事件、Update 事件、Delete 事件时，将对应的资源对象更新到本地缓存（DeltaFIFO）中并更新 ResourceVersion 资源版本号。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="7"><li>从上面的实现我们可以看出获取到的数据最终都流向了本地的 Store，也就是 DeltaFIFO，所以接下来我们需要来分析 DeltaFIFO 的实现</li></ol> <h3 id="_2-2-deltafifo"><a href="#_2-2-deltafifo" class="header-anchor">#</a> 2.2 DeltaFIFO</h3> <p>前面我们讲到 Reflector 中通过 ListAndWatch 获取到数据后传入到了本地的存储中，也就是 DeltaFIFO 中。从 DeltaFIFO 的名字可以看出它是一个 FIFO，也就是一个先进先出的队列，而 Delta 表示的是变化的资源对象存储，包含操作资源对象的类型和数据，Reflector 就是这个队列的生产者。</p> <p>在了解 DeltaFIFO 之前我们需要先具体了解下什么是 Delta，我们先来看看 client-go 中是如何定义的，Delta 的数据结构定义位于<code>staging/src/k8s.io/client-go/tools/cache/delta_fifo.go</code>文件中。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/delta_fifo.go</span>

<span class="token comment">// DeltaType 是变化的类型（添加、删除等）</span>
<span class="token keyword">type</span> DeltaType <span class="token builtin">string</span>

<span class="token comment">// 变化的类型定义</span>
<span class="token keyword">const</span> <span class="token punctuation">(</span>
	Added   DeltaType <span class="token operator">=</span> <span class="token string">&quot;Added&quot;</span>     <span class="token comment">// 增加</span>
	Updated DeltaType <span class="token operator">=</span> <span class="token string">&quot;Updated&quot;</span>   <span class="token comment">// 更新</span>
	Deleted DeltaType <span class="token operator">=</span> <span class="token string">&quot;Deleted&quot;</span>   <span class="token comment">// 删除</span>
	<span class="token comment">// 当遇到 watch 错误，不得不进行重新list时，就会触发 Replaced。</span>
  <span class="token comment">// 我们不知道被替换的对象是否发生了变化。</span>
	<span class="token comment">//</span>
  <span class="token comment">// 注意：以前版本的 DeltaFIFO 也会对 Replace 事件使用 Sync。</span>
  <span class="token comment">// 所以只有当选项 EmitDeltaTypeReplaced 为真时才会触发 Replaced。</span>
	Replaced DeltaType <span class="token operator">=</span> <span class="token string">&quot;Replaced&quot;</span>
	<span class="token comment">// Sync 是针对周期性重新同步期间的合成事件</span>
	Sync DeltaType <span class="token operator">=</span> <span class="token string">&quot;Sync&quot;</span>          <span class="token comment">// 同步</span>
<span class="token punctuation">)</span>

<span class="token comment">// Delta 是 DeltaFIFO 存储的类型。</span>
<span class="token comment">// 它告诉你发生了什么变化，以及变化后对象的状态。</span>
<span class="token comment">//</span>
<span class="token comment">// [*] 除非变化是删除操作，否则你将得到对象被删除前的最终状态。</span>
<span class="token keyword">type</span> Delta <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Type   DeltaType
	Object <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p><img src="https://www.notion.so/image/https%3A%2F%2Fbxdc-static.oss-cn-beijing.aliyuncs.com%2Fimages%2Fclient-go-deltafifo-flow.png?id=4c0562fb-0aad-4218-baaa-265107695326&amp;table=block&amp;spaceId=dbc99cc1-a8f6-4ded-bd01-465426f678b3&amp;width=2000&amp;userId=&amp;cache=v2" alt="img"></p> <p>其实也非常好理解，比如我们现在添加了一个 Pod，那么这个 Delta 就是带有 Added 这个类型的 Pod，如果是删除了一个 Deployment，那么这个 Delta 就是带有 Deleted 类型的 Deployment，为什么要带上类型呢？因为我们需要根据不同的类型去执行不同的操作，增加、更新、删除的动作显然是不一样的。</p> <h4 id="_2-2-1-fifo"><a href="#_2-2-1-fifo" class="header-anchor">#</a> 2.2.1 FIFO</h4> <p>FIFO 很好理解，就是一个先进先出的队列，Reflector 是其生产者，其数据结构定义位于  <code>staging/src/k8s.io/client-go/tools/cache/fifo.go</code> 文件中：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/fifo.go</span>

<span class="token keyword">type</span> FIFO <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	lock sync<span class="token punctuation">.</span>RWMutex
	cond sync<span class="token punctuation">.</span>Cond

  <span class="token comment">// items 中的每一个 key 也在 queue 中</span>
	items <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	queue <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>

	<span class="token comment">// 如果第一批 items 被 Replace() 插入或者先调用了 Deleta/Add/Update</span>
  <span class="token comment">// 则 populated 为 true。</span>
	populated <span class="token builtin">bool</span>
	<span class="token comment">// 第一次调用 Replace() 时插入的 items 数</span>
	initialPopulationCount <span class="token builtin">int</span>

  <span class="token comment">// keyFunc 用于生成排队的 item 插入和检索的 key。</span>
	keyFunc KeyFunc

  <span class="token comment">// 标识队列已关闭，以便在队列清空时控制循环可以退出。</span>
	closed     <span class="token builtin">bool</span>
	closedLock sync<span class="token punctuation">.</span>Mutex
<span class="token punctuation">}</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	<span class="token boolean">_</span> <span class="token operator">=</span> <span class="token function">Queue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>FIFO<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// FIFO 是一个 Queue</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>上面的 FIFO 数据结构中定义了 items 和 queue 两个属性来保存队列中的数据，其中 queue 中存的是资源对象的 key 列表，而 items 是一个 map 类型，其 key 就是 queue 中保存的 key，value 值是真正的资源对象数据。既然是先进进去的队列，那么就要具有队列的基本功能，结构体下面其实就有一个类型断言，表示当前的 FIFO 实现了 Queue 这个接口，所以 FIFO 要实现的功能都是在 Queue 中定义的，Queue 接口和 FIFO 位于同一文件中：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/fifo.go</span>

<span class="token comment">// Queue 扩展了 Store  // with a collection of Store keys to &quot;process&quot;.</span>
<span class="token comment">// 每一次添加、更新或删除都可以将对象的key放入到该集合中。</span>
<span class="token comment">// Queue 具有使用给定的 accumulator 来推导出相应的 key 的方法</span>
<span class="token comment">// Queue 可以从多个 goroutine 中并发访问</span>
<span class="token comment">// Queue 可以被关闭，之后 Pop 操作会返回一个错误</span>
<span class="token keyword">type</span> Queue <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	Store

	<span class="token comment">// Pop 一直阻塞，直到至少有一个key要处理或队列被关闭，队列被关闭会返回一个错误。</span>
  <span class="token comment">// 在前面的情况下 Pop 原子性地选择一个 key 进行处理，从 Store 中删除关联（key、accumulator）的数据,</span>
  <span class="token comment">// 并处理 accumulator。Pop 会返回被处理的 accumulator 和处理的结果。</span>
	
	<span class="token comment">// PopProcessFunc 函数可以返回一个 ErrRequeue{inner}，在这种情况下，Pop 将</span>
  <span class="token comment">//（a）把那个（key，accumulator）关联作为原子处理的一部分返回到 Queue 中</span>
  <span class="token comment">// (b) 从 Pop 返回内部错误。</span>
	<span class="token function">Pop</span><span class="token punctuation">(</span>PopProcessFunc<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>

	<span class="token comment">// 仅当该 key 尚未与一个非空的 accumulator 相关联的时候，AddIfNotPresent 将给定的 accumulator 放入 Queue（与 accumulator 的 key 相关联的）</span>
	<span class="token function">AddIfNotPresent</span><span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
	
  <span class="token comment">// 如果第一批 keys 都已经 Popped，则 HasSynced 返回 true。</span>
  <span class="token comment">// 如果在添加、更新、删除之前发生了第一次 Replace 操作，则第一批 keys 为 true</span>
  <span class="token comment">// 否则为空。</span>
	<span class="token function">HasSynced</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>

	<span class="token comment">// 关闭该队列</span>
	<span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>从上面的定义中可以看出 Queue 这个接口扩展了 Store 这个接口，这个就是前面我们说的本地存储，队列实际上也是一种存储，然后在 Store 的基础上增加 Pop、AddIfNotPresent、HasSynced、Close 4个函数就变成了 Queue 队列了，所以我们优先来看下 Store 这个接口的定义，该数据结构定义位于文件 <code>k8s.io/client-go/tools/cache/store.go</code> 中</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/store.go</span>

<span class="token comment">// Store 是一个通用的对象存储和处理的接口。</span>
<span class="token comment">// Store 包含一个从字符串 keys 到 accumulators 的映射，并具有 to/from 当前</span>
<span class="token comment">// 给定 key 关联的 accumulators 添加、更新和删除给定对象的操作。</span>
<span class="token comment">// 一个 Store 还知道如何从给定的对象中获取 key，所以很多操作只提供对象。</span>
<span class="token comment">//</span>
<span class="token comment">// 在最简单的 Store 实现中，每个 accumulator 只是最后指定的对象，或者删除后为空，</span>
<span class="token comment">// 所以 Store 只是简单的存储。</span>
<span class="token comment">//</span>
<span class="token comment">// Reflector 反射器知道如何 watch 一个服务并更新一个 Store 存储，这个包提供了 Store 的各种实现。</span>
<span class="token keyword">type</span> Store <span class="token keyword">interface</span> <span class="token punctuation">{</span>

	<span class="token comment">// Add 将指定对象添加到与指定对象的 key 相关的 accumulator(累加器)中。</span>
	<span class="token function">Add</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span>

	<span class="token comment">// Update 与指定对象的 key 相关的 accumulator 中更新指定的对象</span>
	<span class="token function">Update</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span>

	<span class="token comment">// Delete 根据指定的对象 key 删除指定的对象</span>
	<span class="token function">Delete</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span>

	<span class="token comment">// List 返回当前所有非空的 accumulators 的列表</span>
	<span class="token function">List</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

	<span class="token comment">// ListKeys 返回当前与非空 accumulators 关联的所有 key 的列表</span>
	<span class="token function">ListKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>

	<span class="token comment">// Get 根据指定的对象获取关联的 accumulator</span>
	<span class="token function">Get</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>item <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> exists <span class="token builtin">bool</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>

	<span class="token comment">// GetByKey 根据指定的对象 key 获取关联的 accumulator</span>
	<span class="token function">GetByKey</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>item <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> exists <span class="token builtin">bool</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>

	<span class="token comment">// Replace 会删除原来Store中的内容，并将新增的list的内容存入Store中，即完全替换数据</span>
  <span class="token comment">// Store 拥有 list 列表的所有权，在调用此函数后，不应该引用它了。</span>
	<span class="token function">Replace</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span>

	<span class="token comment">// Resync 在 Store 中没有意义，但是在 DeltaFIFO 中有意义。</span>
	<span class="token function">Resync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token punctuation">}</span>

<span class="token comment">// KeyFunc 就是从一个对象中生成一个唯一的 Key 的函数，上面的 FIFO 中就有用到</span>
<span class="token keyword">type</span> KeyFunc <span class="token keyword">func</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>

<span class="token comment">// MetaNamespaceKeyFunc 是默认的 KeyFunc，生成的 key 格式为：</span>
<span class="token comment">// &lt;namespace&gt;/&lt;name&gt;</span>
<span class="token comment">// 如果是全局的，则namespace为空，那么生成的 key 就是 &lt;name&gt;</span>
<span class="token comment">// 当然要从 key 拆分出 namespace 和 name 也非常简单</span>
<span class="token keyword">func</span> <span class="token function">MetaNamespaceKeyFunc</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> key<span class="token punctuation">,</span> ok <span class="token operator">:=</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span>ExplicitKey<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token function">string</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	meta<span class="token punctuation">,</span> err <span class="token operator">:=</span> meta<span class="token punctuation">.</span><span class="token function">Accessor</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;object has no meta: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>meta<span class="token punctuation">.</span><span class="token function">GetNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> meta<span class="token punctuation">.</span><span class="token function">GetNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> meta<span class="token punctuation">.</span><span class="token function">GetName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> meta<span class="token punctuation">.</span><span class="token function">GetName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br></div></div><p>Store 就是一个通用的对象存储和处理的接口，可以用来写入对象和获取对象。其中 cache 数据结构就实现了上面的 Store 接口，但是这个属于后面的 Indexer 部分的知识点，这里我们就不展开说明了。</p> <p>我们说 Queue 扩展了 Store 接口，所以 Queue 本身也是一个存储，只是在存储的基础上增加了 Pop 这样的函数来实现弹出对象，是不是就变成了一个队列了。</p> <p>接下来看看 FIFO 是如何实现存储和 Pop 的功能的。首先是实现 Store 存储中最基本的方法，第一个就是添加对象：</p> <p>更新对象，实现非常简单，因为上面的 Add 方法就包含了 Update 的实现，因为 items 属性是一个 Map，对象有更新直接将对应 key 的 value 值替换成新的对象即可：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/fifo.go</span>

<span class="token comment">// Update 和 Add 相同的实现</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>FIFO<span class="token punctuation">)</span> <span class="token function">Update</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> f<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>接着就是删除 Delete 方法的实现，这里可能大家会有一个疑问，下面的删除实现只删除了 items 中的元素，那这样岂不是 queue 和 items 中的 key 会不一致吗？的确会这样，但是这是一个队列，下面的 Pop() 函数会根据 queue 里面的元素一个一个的弹出 key，没有对象就不处理了，相当于下面的 Pop() 函数中实现了 queue 的 key 的删除：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/fifo.go</span>

<span class="token comment">// Delete 从队列中移除一个对象。</span>
<span class="token comment">// 不会添加到 queue 中去，这个实现是假设消费者只关心对象</span>
<span class="token comment">// 不关心它们被创建或添加的顺序。</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>FIFO<span class="token punctuation">)</span> <span class="token function">Delete</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取对象的 key</span>
	id<span class="token punctuation">,</span> err <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token function">keyFunc</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> KeyError<span class="token punctuation">{</span>obj<span class="token punctuation">,</span> err<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	f<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> f<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	f<span class="token punctuation">.</span>populated <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token comment">// 删除 items 中 key 为 id 的元素，就是删除队列中的对象</span>
	<span class="token function">delete</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>items<span class="token punctuation">,</span> id<span class="token punctuation">)</span>
  <span class="token comment">//?为什么不直接处理 queue 这个 slice 呢？</span>
	<span class="token keyword">return</span> err
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>然后是获取队列中所有对象的 List 方法的实现：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/fifo.go</span>

<span class="token comment">// List 获取队列中的所有对象</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>FIFO<span class="token punctuation">)</span> <span class="token function">List</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
	f<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> f<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	list <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>items<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">// 获取所有的items的values值（items是一个Map）</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> item <span class="token operator">:=</span> <span class="token keyword">range</span> f<span class="token punctuation">.</span>items <span class="token punctuation">{</span>
		list <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> item<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> list
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>接着是获取队列中所有元素的 key 的 ListKeys 方法实现：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/fifo.go</span>

<span class="token comment">// ListKeys 返回现在 FIFO 队列中所有对象的 keys 列表。</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>FIFO<span class="token punctuation">)</span> <span class="token function">ListKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token punctuation">{</span>
	f<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> f<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	list <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>items<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">// 获取所有items的key值（items是一个Map）</span>
	<span class="token keyword">for</span> key <span class="token operator">:=</span> <span class="token keyword">range</span> f<span class="token punctuation">.</span>items <span class="token punctuation">{</span>
		list <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> list
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>至于根据对象或者对象的 key 获取队列中的元素，就更简单了：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/fifo.go</span>

<span class="token comment">// Get 获取指定对象在队列中的元素</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>FIFO<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>item <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> exists <span class="token builtin">bool</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	key<span class="token punctuation">,</span> err <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token function">keyFunc</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> KeyError<span class="token punctuation">{</span>obj<span class="token punctuation">,</span> err<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// 调用 GetByKey 实现</span>
	<span class="token keyword">return</span> f<span class="token punctuation">.</span><span class="token function">GetByKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// GetByKey 根据 key 获取队列中的元素</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>FIFO<span class="token punctuation">)</span> <span class="token function">GetByKey</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>item <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> exists <span class="token builtin">bool</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	f<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> f<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 因为 items 是一个 Map，所以直接根据 key 获取即可</span>
	item<span class="token punctuation">,</span> exists <span class="token operator">=</span> f<span class="token punctuation">.</span>items<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
	<span class="token keyword">return</span> item<span class="token punctuation">,</span> exists<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>然后是一个 Replace 替换函数的实现：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/fifo.go</span>

<span class="token comment">// Replace 将删除队列中的内容，'f' 拥有 map 的所有权，调用该函数过后，不应该再引用 map。</span>
<span class="token comment">// 'f' 的队列也会被重置，返回时，队列将包含 map 中的元素，没有特定的顺序。</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>FIFO<span class="token punctuation">)</span> <span class="token function">Replace</span><span class="token punctuation">(</span>list <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> resourceVersion <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token comment">// 从 list 中提取出 key 然后和里面的元素重新进行映射</span>
  items <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> item <span class="token operator">:=</span> <span class="token keyword">range</span> list <span class="token punctuation">{</span>
		key<span class="token punctuation">,</span> err <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token function">keyFunc</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> KeyError<span class="token punctuation">{</span>item<span class="token punctuation">,</span> err<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		items<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> item
	<span class="token punctuation">}</span>

	f<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> f<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> <span class="token operator">!</span>f<span class="token punctuation">.</span>populated <span class="token punctuation">{</span>
		f<span class="token punctuation">.</span>populated <span class="token operator">=</span> <span class="token boolean">true</span>
		f<span class="token punctuation">.</span>initialPopulationCount <span class="token operator">=</span> <span class="token function">len</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 重新设置 items 和 queue 的值</span>
	f<span class="token punctuation">.</span>items <span class="token operator">=</span> items
	f<span class="token punctuation">.</span>queue <span class="token operator">=</span> f<span class="token punctuation">.</span>queue<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>
	<span class="token keyword">for</span> id <span class="token operator">:=</span> <span class="token keyword">range</span> items <span class="token punctuation">{</span>
		f<span class="token punctuation">.</span>queue <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>queue<span class="token punctuation">,</span> id<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>queue<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		f<span class="token punctuation">.</span>cond<span class="token punctuation">.</span><span class="token function">Broadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>还有 Store 存储中的最后一个方法 Resync 的实现：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/fifo.go</span>

<span class="token comment">// Resync 会保证 Store 中的每个对象在 queue 中都有它的 key。</span>
<span class="token comment">// </span>
<span class="token comment">// 这应该是禁止操作的，因为该属性由所有操作维护</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>FIFO<span class="token punctuation">)</span> <span class="token function">Resync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	f<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> f<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 将所有 queue 中的元素放到一个 set 中</span>
	inQueue <span class="token operator">:=</span> sets<span class="token punctuation">.</span><span class="token function">NewString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> id <span class="token operator">:=</span> <span class="token keyword">range</span> f<span class="token punctuation">.</span>queue <span class="token punctuation">{</span>
		inQueue<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// 然后将所有 items 中的 key 加回到 queue 中去</span>
	<span class="token keyword">for</span> id <span class="token operator">:=</span> <span class="token keyword">range</span> f<span class="token punctuation">.</span>items <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>inQueue<span class="token punctuation">.</span><span class="token function">Has</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			f<span class="token punctuation">.</span>queue <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>queue<span class="token punctuation">,</span> id<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>queue<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		f<span class="token punctuation">.</span>cond<span class="token punctuation">.</span><span class="token function">Broadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>上面的所有方法就实现了一个普通的 Store，然后要想变成一个 Queue，还需要实现额外的 Pop 方法：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/fifo.go</span>

<span class="token comment">// Pop 会等到一个元素准备好后再进行处理，如果有多个元素准备好了，则按照它们被添加或更新的顺序返回。</span>
<span class="token comment">//</span>
<span class="token comment">// 在处理之前，元素会从队列（和存储）中移除，所以如果没有成功处理，应该用 AddIfNotPresent() 函数把它添加回来。</span>
<span class="token comment">// 处理函数是在有锁的情况下调用的，所以更新其中需要和队列同步的数据结构是安全的。</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>FIFO<span class="token punctuation">)</span> <span class="token function">Pop</span><span class="token punctuation">(</span>process PopProcessFunc<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	f<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> f<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token comment">// 当队列为空时，Pop() 的调用会被阻塞住，直到新的元素插入队列后</span>
		<span class="token keyword">for</span> <span class="token function">len</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>queue<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> f<span class="token punctuation">.</span><span class="token function">IsClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> ErrFIFOClosed
			<span class="token punctuation">}</span>
			<span class="token comment">// 等待 condition 被广播</span>
			f<span class="token punctuation">.</span>cond<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
    <span class="token comment">// 取出 queue 队列中的第一个元素（key）</span>
		id <span class="token operator">:=</span> f<span class="token punctuation">.</span>queue<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token comment">// 删除第一个元素</span>
		f<span class="token punctuation">.</span>queue <span class="token operator">=</span> f<span class="token punctuation">.</span>queue<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
		<span class="token keyword">if</span> f<span class="token punctuation">.</span>initialPopulationCount <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			f<span class="token punctuation">.</span>initialPopulationCount<span class="token operator">--</span>
		<span class="token punctuation">}</span>
    <span class="token comment">// 获取被弹出的元素</span>
		item<span class="token punctuation">,</span> ok <span class="token operator">:=</span> f<span class="token punctuation">.</span>items<span class="token punctuation">[</span>id<span class="token punctuation">]</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
			<span class="token comment">// 因为 item 可能已经被删除了。</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
    <span class="token comment">// 删除弹出的元素</span>
		<span class="token function">delete</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>items<span class="token punctuation">,</span> id<span class="token punctuation">)</span>
    <span class="token comment">// 处理弹出的元素</span>
		err <span class="token operator">:=</span> <span class="token function">process</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
		<span class="token keyword">if</span> e<span class="token punctuation">,</span> ok <span class="token operator">:=</span> err<span class="token punctuation">.</span><span class="token punctuation">(</span>ErrRequeue<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
      <span class="token comment">// 如果处理没成功，需要调用 addIfNotPresent 加回队列</span>
			f<span class="token punctuation">.</span><span class="token function">addIfNotPresent</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> item<span class="token punctuation">)</span>
			err <span class="token operator">=</span> e<span class="token punctuation">.</span>Err
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> item<span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>另外的一个就是上面提到的 AddIfNotPresent、HasSynced、Close 几个函数的实现：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/fifo.go</span>

<span class="token comment">// AddIfNotPresent 插入一个元素，将其放入队列中。</span>
<span class="token comment">// 如果元素已经在集合中了，则会被忽略。</span>
<span class="token comment">//</span>
<span class="token comment">// 这在单个的 生产者/消费者 的场景下非常有用，这样消费者可以安全地重试</span>
<span class="token comment">// 而不需要与生产者争夺，也不需要排队等待过时的元素。</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>FIFO<span class="token punctuation">)</span> <span class="token function">AddIfNotPresent</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	id<span class="token punctuation">,</span> err <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token function">keyFunc</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>  <span class="token comment">// 获取对象的 key</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> KeyError<span class="token punctuation">{</span>obj<span class="token punctuation">,</span> err<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	f<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> f<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	f<span class="token punctuation">.</span><span class="token function">addIfNotPresent</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> obj<span class="token punctuation">)</span>  <span class="token comment">// 调用 addIfNotPresent 真正的实现</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// addIfNotPresent 会假设已经持有 fifo 锁了，如果不存在，则将其添加到队列中去。</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>FIFO<span class="token punctuation">)</span> <span class="token function">addIfNotPresent</span><span class="token punctuation">(</span>id <span class="token builtin">string</span><span class="token punctuation">,</span> obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	f<span class="token punctuation">.</span>populated <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token comment">// 存在则忽略</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> exists <span class="token operator">:=</span> f<span class="token punctuation">.</span>items<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span> exists <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// 添加到 queue 和 items 中去</span>
	f<span class="token punctuation">.</span>queue <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>queue<span class="token punctuation">,</span> id<span class="token punctuation">)</span>
	f<span class="token punctuation">.</span>items<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> obj
  <span class="token comment">// 广播 condition</span>
	f<span class="token punctuation">.</span>cond<span class="token punctuation">.</span><span class="token function">Broadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 关闭队列</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>FIFO<span class="token punctuation">)</span> <span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	f<span class="token punctuation">.</span>closedLock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> f<span class="token punctuation">.</span>closedLock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 标记为关闭</span>
	f<span class="token punctuation">.</span>closed <span class="token operator">=</span> <span class="token boolean">true</span>
	f<span class="token punctuation">.</span>cond<span class="token punctuation">.</span><span class="token function">Broadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 如果先调用了 Add/Update/Delete/AddIfNotPresent，或者先调用了Update，但被 Replace() 插入的第一批元素已经被弹出，则 HasSynced 返回true。</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>FIFO<span class="token punctuation">)</span> <span class="token function">HasSynced</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	f<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> f<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> f<span class="token punctuation">.</span>populated <span class="token operator">&amp;&amp;</span> f<span class="token punctuation">.</span>initialPopulationCount <span class="token operator">==</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><p>到这里我们就实现了一个简单的 FIFO 队列，其实这里就是对 FIFO 这个数据结构的理解，没有特别的地方，只是在队列里面有 items 和 queue 两个属性来维护队列而已。</p> <h4 id="_2-2-3-fifo-demo"><a href="#_2-2-3-fifo-demo" class="header-anchor">#</a> 2.2.3 FIFo demo</h4> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> fifo_demo

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;testing&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> testFifoObject <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	name <span class="token builtin">string</span>
	val  <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">testFifoObjectKeyFunc</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span>testFifoObject<span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestFIFO_requeueOnPop</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	f <span class="token operator">:=</span> <span class="token function">NewFIFO</span><span class="token punctuation">(</span>testFifoObjectKeyFunc<span class="token punctuation">)</span>
	<span class="token keyword">var</span> testData <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>testFifoObject<span class="token punctuation">{</span>
		<span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span> val<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">&quot;test2&quot;</span><span class="token punctuation">,</span> val<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">&quot;test3&quot;</span><span class="token punctuation">,</span> val<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">&quot;tes4&quot;</span><span class="token punctuation">,</span> val<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> test <span class="token operator">:=</span> <span class="token keyword">range</span> testData <span class="token punctuation">{</span>
		f<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>testData<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Logf</span><span class="token punctuation">(</span><span class="token string">&quot;keys : %v&quot;</span><span class="token punctuation">,</span> f<span class="token punctuation">.</span><span class="token function">ListKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		data <span class="token operator">:=</span> <span class="token function">Pop</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>
		t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	item<span class="token punctuation">,</span> ok<span class="token punctuation">,</span> err <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>testFifoObject<span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span> val<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> ok<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h4 id="_2-2-4-deltafifo"><a href="#_2-2-4-deltafifo" class="header-anchor">#</a> 2.2.4 DeltaFIFO</h4> <p>上面我们已经实现了 FIFO，接下来就看下一个 DeltaFIFO 是如何实现的，DeltaFIFO 和 FIFO 一样也是一个队列，但是也有不同的地方，里面的元素是一个 Delta，Delta 上面我们已经提到表示的是带有变化类型的资源对象。</p> <p>DeltaFIFO 的数据结构定义位于 <code>staging/src/k8s.io/client-go/tools/cache/delta_fifo.go</code> 文件中：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/delta_fifo.go</span>

<span class="token keyword">type</span> DeltaFIFO <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token comment">// lock/cond 保护访问的 items 和 queue</span>
	lock sync<span class="token punctuation">.</span>RWMutex
	cond sync<span class="token punctuation">.</span>Cond

  <span class="token comment">// 用来存储 Delta 数据 -&gt; 对象key: Delta数组</span>

	items <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>Deltas
  <span class="token comment">// 用来存储资源对象的key</span>
	queue <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>

	<span class="token comment">// 通过 Replace() 接口将第一批对象放入队列，或者第一次调用增、删、改接口时标记为true</span>
	populated <span class="token builtin">bool</span>
	<span class="token comment">// 通过 Replace() 接口（全量）将第一批对象放入队列的对象数量</span>
	initialPopulationCount <span class="token builtin">int</span>

	<span class="token comment">// 对象键的计算函数</span>
	keyFunc KeyFunc

	<span class="token comment">// knownObjects 列出 &quot;known&quot; 的键 -- 影响到 Delete()，Replace() 和 Resync()</span>
  <span class="token comment">// knownObjects 其实就是 Indexer，里面存有已知全部的对象</span>
	knownObjects KeyListerGetter

	<span class="token comment">// 标记 queue 被关闭了</span>
  closed     <span class="token builtin">bool</span>
	closedLock sync<span class="token punctuation">.</span>Mutex

	<span class="token comment">// emitDeltaTypeReplaced 当 Replace() 被调用的时候，是否要 emit Replaced 或者 Sync</span>
	<span class="token comment">// DeltaType(保留向后兼容)。</span>
	emitDeltaTypeReplaced <span class="token builtin">bool</span>
<span class="token punctuation">}</span>

<span class="token comment">// KeyListerGetter 任何知道如何列出键和按键获取对象的东西</span>
<span class="token keyword">type</span> KeyListerGetter <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	KeyLister
	KeyGetter
<span class="token punctuation">}</span>

<span class="token comment">// 获取所有的键</span>
<span class="token keyword">type</span> KeyLister <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">ListKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token comment">// 根据键获取对象</span>
<span class="token keyword">type</span> KeyGetter <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">GetByKey</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><p>DeltaFIFO 与 FIFO 一样都是一个 Queue，所以他们都实现了 Queue，所以我们这里来看下 DeltaFIFO 是如何实现 Queue 功能的，当然和 FIFO 一样都是实现 Queue 接口里面的所有方法。</p> <p>虽然实现流程和 FIFO 是一样的，但是具体的实现是不一样的，比如 DeltaFIFO 的对象键计算函数就不同：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/delta_fifo.go</span>

<span class="token comment">// DeltaFIFO 的对象键计算函数</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>DeltaFIFO<span class="token punctuation">)</span> <span class="token function">KeyOf</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 用 Deltas 做一次转换，判断是否是 Delta 切片</span>
  <span class="token keyword">if</span> d<span class="token punctuation">,</span> ok <span class="token operator">:=</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span>Deltas<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> KeyError<span class="token punctuation">{</span>obj<span class="token punctuation">,</span> ErrZeroLengthDeltasObject<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
    <span class="token comment">// 使用最新版本的对象进行计算</span>
		obj <span class="token operator">=</span> d<span class="token punctuation">.</span><span class="token function">Newest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Object
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> d<span class="token punctuation">,</span> ok <span class="token operator">:=</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span>DeletedFinalStateUnknown<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		<span class="token keyword">return</span> d<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// 具体计算还是要看初始化 DeltaFIFO 传入的 KeyFunc 函数</span>
	<span class="token keyword">return</span> f<span class="token punctuation">.</span><span class="token function">keyFunc</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Newest 返回最新的 Delta，如果没有则返回 nil。</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>d Deltas<span class="token punctuation">)</span> <span class="token function">Newest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Delta <span class="token punctuation">{</span>
	<span class="token keyword">if</span> n <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span> n <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token operator">&amp;</span>d<span class="token punctuation">[</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>DeltaFIFO 的计算对象键的函数为什么要先做一次 Deltas 的类型转换呢？那是因为 Pop() 出去的对象很可能还要再添加进来（比如处理失败需要再放进来），此时添加的对象就是已经封装好的 Deltas 对象了。</p> <p>然后同样按照上面的方式来分析 DeltaFIFO 的实现，首先查看 Store 存储部分的实现，也就是增、删、改、查功能。</p> <p>同样的 Add、Update 和 Delete 的实现方法基本上是一致的：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/delta_fifo.go</span>

<span class="token comment">// Add 插入一个元素放入到队列中</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>DeltaFIFO<span class="token punctuation">)</span> <span class="token function">Add</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	f<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> f<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	f<span class="token punctuation">.</span>populated <span class="token operator">=</span> <span class="token boolean">true</span>  <span class="token comment">// 队列第一次写入操作都要设置标记</span>
	<span class="token keyword">return</span> f<span class="token punctuation">.</span><span class="token function">queueActionLocked</span><span class="token punctuation">(</span>Added<span class="token punctuation">,</span> obj<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Update 和 Add 一样，只是是 Updated 一个 Delta</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>DeltaFIFO<span class="token punctuation">)</span> <span class="token function">Update</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	f<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> f<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	f<span class="token punctuation">.</span>populated <span class="token operator">=</span> <span class="token boolean">true</span>  <span class="token comment">// 队列第一次写入操作都要设置标记</span>
	<span class="token keyword">return</span> f<span class="token punctuation">.</span><span class="token function">queueActionLocked</span><span class="token punctuation">(</span>Updated<span class="token punctuation">,</span> obj<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 删除和添加一样，但会产生一个删除的 Delta。如果给定的对象还不存在，它将被忽略。</span>
<span class="token comment">// 例如，它可能已经被替换（重新list）删除了。</span>
<span class="token comment">// 在这个方法中，`f.knownObjects` 如果不为nil，则提供（通过GetByKey）被认为已经存在的 _additional_ 对象。</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>DeltaFIFO<span class="token punctuation">)</span> <span class="token function">Delete</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	id<span class="token punctuation">,</span> err <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token function">KeyOf</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> KeyError<span class="token punctuation">{</span>obj<span class="token punctuation">,</span> err<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	f<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> f<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 队列第一次写入操作都要设置这个标记</span>
	f<span class="token punctuation">.</span>populated <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token comment">// 相当于没有 Indexer 的时候，就通过自己的存储对象检查下</span>
	<span class="token keyword">if</span> f<span class="token punctuation">.</span>knownObjects <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> exists <span class="token operator">:=</span> f<span class="token punctuation">.</span>items<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">!</span>exists <span class="token punctuation">{</span>
			<span class="token comment">// 自己的存储里面都没有，那也就不用处理了</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> 
		<span class="token comment">// 相当于 Indexer 里面和自己的存储里面都没有这个对象，那么也就相当于不存在了，就不处理了。</span>
    <span class="token boolean">_</span><span class="token punctuation">,</span> exists<span class="token punctuation">,</span> err <span class="token operator">:=</span> f<span class="token punctuation">.</span>knownObjects<span class="token punctuation">.</span><span class="token function">GetByKey</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
		<span class="token boolean">_</span><span class="token punctuation">,</span> itemsExist <span class="token operator">:=</span> f<span class="token punctuation">.</span>items<span class="token punctuation">[</span>id<span class="token punctuation">]</span>
		<span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>exists <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>itemsExist <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// 同样调用 queueActionLocked 将数据放入队列</span>
	<span class="token keyword">return</span> f<span class="token punctuation">.</span><span class="token function">queueActionLocked</span><span class="token punctuation">(</span>Deleted<span class="token punctuation">,</span> obj<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><p>可以看出 Add 、Update、Delete 方法最终都是调用的 <code>queueActionLocked</code> 函数来实现：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/delta_fifo.go</span>

<span class="token comment">// queueActionLocked 追加到对象的 delta 列表中。</span>
<span class="token comment">// 调用者必须先 lock。</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>DeltaFIFO<span class="token punctuation">)</span> <span class="token function">queueActionLocked</span><span class="token punctuation">(</span>actionType DeltaType<span class="token punctuation">,</span> obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	id<span class="token punctuation">,</span> err <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token function">KeyOf</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>  <span class="token comment">// 获取对象键</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> KeyError<span class="token punctuation">{</span>obj<span class="token punctuation">,</span> err<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
  
  <span class="token comment">// 将 actionType 和资源对象 obj 构造成 Delta，添加到 items 中</span>
	newDeltas <span class="token operator">:=</span> <span class="token function">append</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>items<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">,</span> Delta<span class="token punctuation">{</span>actionType<span class="token punctuation">,</span> obj<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 去重</span>
	newDeltas <span class="token operator">=</span> <span class="token function">dedupDeltas</span><span class="token punctuation">(</span>newDeltas<span class="token punctuation">)</span>

	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>newDeltas<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
    <span class="token comment">// 新对象的 key 不在队列中则插入 queue 队列</span>
		<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> exists <span class="token operator">:=</span> f<span class="token punctuation">.</span>items<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">!</span>exists <span class="token punctuation">{</span>
			f<span class="token punctuation">.</span>queue <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>queue<span class="token punctuation">,</span> id<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
    <span class="token comment">// 重新更新 items</span>
		f<span class="token punctuation">.</span>items<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> newDeltas
    <span class="token comment">// 通知所有的消费者解除阻塞</span>
		f<span class="token punctuation">.</span>cond<span class="token punctuation">.</span><span class="token function">Broadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这种情况不会发生，因为给定一个非空列表时，dedupDeltas 永远不会返回一个空列表。</span>
    <span class="token comment">// 但如果真的返回了一个空列表，那么我们就需要从 map 中删除这个元素。</span>
		<span class="token function">delete</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>items<span class="token punctuation">,</span> id<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// ==============排重==============</span>
<span class="token comment">// 重新list和watch可以以任何顺序多次提供相同的更新。</span>
<span class="token comment">// 如果最近的两个 Delta 相同，则将它们合并。</span>
<span class="token keyword">func</span> <span class="token function">dedupDeltas</span><span class="token punctuation">(</span>deltas Deltas<span class="token punctuation">)</span> Deltas <span class="token punctuation">{</span>
	n <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>deltas<span class="token punctuation">)</span>  
	<span class="token keyword">if</span> n <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token punctuation">{</span>  <span class="token comment">// 小于两个 delta 没必要合并了</span>
		<span class="token keyword">return</span> deltas
	<span class="token punctuation">}</span>
  <span class="token comment">// Deltas是[]Delta，新的对象是追加到Slice后面</span>
  <span class="token comment">// 所以取最后两个元素来判断是否相同</span>
	a <span class="token operator">:=</span> <span class="token operator">&amp;</span>deltas<span class="token punctuation">[</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
	b <span class="token operator">:=</span> <span class="token operator">&amp;</span>deltas<span class="token punctuation">[</span>n<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span>
  <span class="token comment">// 执行去重操作</span>
	<span class="token keyword">if</span> out <span class="token operator">:=</span> <span class="token function">isDup</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span> out <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token comment">// 将去重保留下来的delta追加到前面n-2个delta中去</span>
		d <span class="token operator">:=</span> <span class="token function">append</span><span class="token punctuation">(</span>Deltas<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> deltas<span class="token punctuation">[</span><span class="token punctuation">:</span>n<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token function">append</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token operator">*</span>out<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> deltas
<span class="token punctuation">}</span>

<span class="token comment">// 判断两个 Delta 是否是重复的</span>
<span class="token keyword">func</span> <span class="token function">isDup</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token operator">*</span>Delta<span class="token punctuation">)</span> <span class="token operator">*</span>Delta <span class="token punctuation">{</span>
  <span class="token comment">// 这个函数应该应该可以判断多种类型的重复，目前只有删除这一种能够合并</span>
	<span class="token keyword">if</span> out <span class="token operator">:=</span> <span class="token function">isDeletionDup</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span> out <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> out
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// 判断是否为删除类型的重复</span>
<span class="token keyword">func</span> <span class="token function">isDeletionDup</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token operator">*</span>Delta<span class="token punctuation">)</span> <span class="token operator">*</span>Delta <span class="token punctuation">{</span>
  <span class="token comment">// 二者类型都是删除那肯定有一个是重复的，则返回一个即可</span>
	<span class="token keyword">if</span> b<span class="token punctuation">.</span>Type <span class="token operator">!=</span> Deleted <span class="token operator">||</span> a<span class="token punctuation">.</span>Type <span class="token operator">!=</span> Deleted <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 更复杂的检查还是这样就够了？</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> b<span class="token punctuation">.</span>Object<span class="token punctuation">.</span><span class="token punctuation">(</span>DeletedFinalStateUnknown<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		<span class="token keyword">return</span> a
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> b
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br></div></div><p>因为系统对于删除的对象有 <code>DeletedFinalStateUnknown</code> 这个状态，所以会存在两次删除的情况，但是两次添加同一个对象由于 APIServer 可以保证对象的唯一性，所以这里没有考虑合并两次添加操作的情况。</p> <p>然后看看其他几个主要方法的实现：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/delta_fifo.go</span>

<span class="token comment">// 列举接口实现</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>DeltaFIFO<span class="token punctuation">)</span> <span class="token function">List</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
	f<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> f<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> f<span class="token punctuation">.</span><span class="token function">listLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 真正的列举实现</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>DeltaFIFO<span class="token punctuation">)</span> <span class="token function">listLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
	list <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>items<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> item <span class="token operator">:=</span> <span class="token keyword">range</span> f<span class="token punctuation">.</span>items <span class="token punctuation">{</span>
		list <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> item<span class="token punctuation">.</span><span class="token function">Newest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Object<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> list
<span class="token punctuation">}</span>

<span class="token comment">// 返回现在 FIFO 中所有的对象键。</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>DeltaFIFO<span class="token punctuation">)</span> <span class="token function">ListKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token punctuation">{</span>
	f<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> f<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	list <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>items<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> key <span class="token operator">:=</span> <span class="token keyword">range</span> f<span class="token punctuation">.</span>items <span class="token punctuation">{</span>
		list <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> list
<span class="token punctuation">}</span>

<span class="token comment">// 根据对象获取FIFO中对应的元素</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>DeltaFIFO<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>item <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> exists <span class="token builtin">bool</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	key<span class="token punctuation">,</span> err <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token function">KeyOf</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> KeyError<span class="token punctuation">{</span>obj<span class="token punctuation">,</span> err<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> f<span class="token punctuation">.</span><span class="token function">GetByKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 通过对象键获取FIFO中的元素（获取到的是 Delta 数组）</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>DeltaFIFO<span class="token punctuation">)</span> <span class="token function">GetByKey</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>item <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> exists <span class="token builtin">bool</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	f<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> f<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	d<span class="token punctuation">,</span> exists <span class="token operator">:=</span> f<span class="token punctuation">.</span>items<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
	<span class="token keyword">if</span> exists <span class="token punctuation">{</span>
		<span class="token comment">// 复制元素的slice，这样对这个切片的操作就不会影响返回的对象了。</span>
		d <span class="token operator">=</span> <span class="token function">copyDeltas</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> d<span class="token punctuation">,</span> exists<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// copyDeltas 返回 d 的浅拷贝，也就是说它拷贝的是切片，而不是切片中的对象。</span>
<span class="token comment">// Get/List 可以返回一个不会被后续修改影响的对象。</span>
<span class="token keyword">func</span> <span class="token function">copyDeltas</span><span class="token punctuation">(</span>d Deltas<span class="token punctuation">)</span> Deltas <span class="token punctuation">{</span>
	d2 <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span>Deltas<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token function">copy</span><span class="token punctuation">(</span>d2<span class="token punctuation">,</span> d<span class="token punctuation">)</span>
	<span class="token keyword">return</span> d2
<span class="token punctuation">}</span>

<span class="token comment">// 判断队列是否关闭了</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>DeltaFIFO<span class="token punctuation">)</span> <span class="token function">IsClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	f<span class="token punctuation">.</span>closedLock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> f<span class="token punctuation">.</span>closedLock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> f<span class="token punctuation">.</span>closed
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div><p>接下来我们来看看 Replace 函数的时候，这个也是 Store 里面的定义的接口：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/delta_fifo.go</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>DeltaFIFO<span class="token punctuation">)</span> <span class="token function">Replace</span><span class="token punctuation">(</span>list <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> resourceVersion <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	f<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> f<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	keys <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span>sets<span class="token punctuation">.</span>String<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token comment">// keep 对老客户端的向后兼容</span>
	action <span class="token operator">:=</span> Sync
	<span class="token keyword">if</span> f<span class="token punctuation">.</span>emitDeltaTypeReplaced <span class="token punctuation">{</span>
		action <span class="token operator">=</span> Replaced
	<span class="token punctuation">}</span>
  <span class="token comment">// 遍历 list</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> item <span class="token operator">:=</span> <span class="token keyword">range</span> list <span class="token punctuation">{</span>
    <span class="token comment">// 计算对象键</span>
		key<span class="token punctuation">,</span> err <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token function">KeyOf</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> KeyError<span class="token punctuation">{</span>item<span class="token punctuation">,</span> err<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
    <span class="token comment">// 记录处理过的对象键，使用 set 集合存储</span>
		keys<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token comment">// 重新同步一次对象</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token function">queueActionLocked</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;couldn't enqueue object: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// 如果没有 Indexer 存储的话，自己存储的就是所有的老对象</span>
  <span class="token comment">// 目的要看看那些老对象不在全量集合中，那么就是删除的对象了</span>
	<span class="token keyword">if</span> f<span class="token punctuation">.</span>knownObjects <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token comment">// 针对自己的列表进行删除检测。</span>
		queuedDeletions <span class="token operator">:=</span> <span class="token number">0</span>
    <span class="token comment">// 遍历所有元素</span>
		<span class="token keyword">for</span> k<span class="token punctuation">,</span> oldItem <span class="token operator">:=</span> <span class="token keyword">range</span> f<span class="token punctuation">.</span>items <span class="token punctuation">{</span>
      <span class="token comment">// 如果元素在输入的对象中存在就忽略了。</span>
			<span class="token keyword">if</span> keys<span class="token punctuation">.</span><span class="token function">Has</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">}</span>
      <span class="token comment">// 到这里证明当前的 oldItem 元素不在输入的列表中，证明对象已经被删除了</span>
			<span class="token keyword">var</span> deletedObj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
			<span class="token keyword">if</span> n <span class="token operator">:=</span> oldItem<span class="token punctuation">.</span><span class="token function">Newest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> n <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				deletedObj <span class="token operator">=</span> n<span class="token punctuation">.</span>Object
			<span class="token punctuation">}</span>
			queuedDeletions<span class="token operator">++</span>
      <span class="token comment">// 因为可能队列中已经存在 Deleted 类型的元素了，避免重复，所以采用 DeletedFinalStateUnknown 来包装下对象</span>
			<span class="token keyword">if</span> err <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token function">queueActionLocked</span><span class="token punctuation">(</span>Deleted<span class="token punctuation">,</span> DeletedFinalStateUnknown<span class="token punctuation">{</span>k<span class="token punctuation">,</span> deletedObj<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> err
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
    <span class="token comment">// 如果 populated 没有设置，说明是第一次并且还没有任何修改操作执行过</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>f<span class="token punctuation">.</span>populated <span class="token punctuation">{</span>
      <span class="token comment">// 这个时候需要标记下</span>
			f<span class="token punctuation">.</span>populated <span class="token operator">=</span> <span class="token boolean">true</span>
			<span class="token comment">// 记录第一次设置的对象数量</span>
			f<span class="token punctuation">.</span>initialPopulationCount <span class="token operator">=</span> <span class="token function">len</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span> <span class="token operator">+</span> queuedDeletions
		<span class="token punctuation">}</span>

		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	
  <span class="token comment">// 检测已经删除但是没有在队列中的元素。</span>
  <span class="token comment">// 从 Indexer 中获取所有的对象键</span>
	knownKeys <span class="token operator">:=</span> f<span class="token punctuation">.</span>knownObjects<span class="token punctuation">.</span><span class="token function">ListKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	queuedDeletions <span class="token operator">:=</span> <span class="token number">0</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> k <span class="token operator">:=</span> <span class="token keyword">range</span> knownKeys <span class="token punctuation">{</span>
    <span class="token comment">// 对象存在就忽略</span>
		<span class="token keyword">if</span> keys<span class="token punctuation">.</span><span class="token function">Has</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
    <span class="token comment">// 到这里同样证明当前的对象键对应的对象被删除了</span>
    <span class="token comment">// 获取被删除的对象键对应的对象</span>
		deletedObj<span class="token punctuation">,</span> exists<span class="token punctuation">,</span> err <span class="token operator">:=</span> f<span class="token punctuation">.</span>knownObjects<span class="token punctuation">.</span><span class="token function">GetByKey</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			deletedObj <span class="token operator">=</span> <span class="token boolean">nil</span>
			klog<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;Unexpected error %v during lookup of key %v, placing DeleteFinalStateUnknown marker without object&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">,</span> k<span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token operator">!</span>exists <span class="token punctuation">{</span>
			deletedObj <span class="token operator">=</span> <span class="token boolean">nil</span>
			klog<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;Key %v does not exist in known objects store, placing DeleteFinalStateUnknown marker without object&quot;</span><span class="token punctuation">,</span> k<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
    <span class="token comment">// 累加删除的对象数量</span>
		queuedDeletions<span class="token operator">++</span>
    <span class="token comment">// 把对象删除的 Delta 放入队列，和上面一样避免重复，使用 DeletedFinalStateUnknown 包装下对象</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token function">queueActionLocked</span><span class="token punctuation">(</span>Deleted<span class="token punctuation">,</span> DeletedFinalStateUnknown<span class="token punctuation">{</span>k<span class="token punctuation">,</span> deletedObj<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> err
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// 和上面一致</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>f<span class="token punctuation">.</span>populated <span class="token punctuation">{</span>
		f<span class="token punctuation">.</span>populated <span class="token operator">=</span> <span class="token boolean">true</span>
		f<span class="token punctuation">.</span>initialPopulationCount <span class="token operator">=</span> <span class="token function">len</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span> <span class="token operator">+</span> queuedDeletions
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br></div></div><p>到这里我们就将完整实现了 DeltaFIFO，然后加上前面的 Reflector 反射器，就可以结合起来了：</p> <h4 id="_2-2-5-流程总结"><a href="#_2-2-5-流程总结" class="header-anchor">#</a> 2.2.5 流程总结</h4> <p>Reflector 通过 ListAndWatch 首先获取全量的资源对象数据，然后调用 DeltaFIFO 的 Replace() 方法全量插入队列，然后后续通过 Watch 操作根据资源对象的操作类型调用 DeltaFIFO 的 Add、Update、Delete 方法，将数据更新到队列中。我们可以用下图来总结这两个组件之间的关系：</p> <p><img src="https://www.notion.so/image/https%3A%2F%2Fbxdc-static.oss-cn-beijing.aliyuncs.com%2Fimages%2Freflector-and-deltafifo.png?id=84108549-f744-4762-9551-3111804c437a&amp;table=block&amp;spaceId=dbc99cc1-a8f6-4ded-bd01-465426f678b3&amp;width=2000&amp;userId=&amp;cache=v2" alt="img"></p> <p>至于 Pop 出来的元素如何处理，就要看 Pop 的回调函数 <code>PopProcessFunc</code> 了。我们可以回到最初的 SharedInformer 中，在 sharedIndexInformer 的 Run 函数中就初始化了 DeltaFIFO，也配置了用于 Pop 回调处理的函数：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>sharedIndexInformer<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span>stopCh <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> utilruntime<span class="token punctuation">.</span><span class="token function">HandleCrash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 初始化 DeltaFIFO，这里就可以看出来 KnownObjects 就是一个 Indexer</span>
	fifo <span class="token operator">:=</span> <span class="token function">NewDeltaFIFOWithOptions</span><span class="token punctuation">(</span>DeltaFIFOOptions<span class="token punctuation">{</span>
		KnownObjects<span class="token punctuation">:</span>          s<span class="token punctuation">.</span>indexer<span class="token punctuation">,</span>
		EmitDeltaTypeReplaced<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	cfg <span class="token operator">:=</span> <span class="token operator">&amp;</span>Config<span class="token punctuation">{</span>
		Queue<span class="token punctuation">:</span>            fifo<span class="token punctuation">,</span>
		ListerWatcher<span class="token punctuation">:</span>    s<span class="token punctuation">.</span>listerWatcher<span class="token punctuation">,</span>
		ObjectType<span class="token punctuation">:</span>       s<span class="token punctuation">.</span>objectType<span class="token punctuation">,</span>
		FullResyncPeriod<span class="token punctuation">:</span> s<span class="token punctuation">.</span>resyncCheckPeriod<span class="token punctuation">,</span>
		RetryOnError<span class="token punctuation">:</span>     <span class="token boolean">false</span><span class="token punctuation">,</span>
		ShouldResync<span class="token punctuation">:</span>     s<span class="token punctuation">.</span>processor<span class="token punctuation">.</span>shouldResync<span class="token punctuation">,</span>

		Process<span class="token punctuation">:</span> s<span class="token punctuation">.</span>HandleDeltas<span class="token punctuation">,</span>  <span class="token comment">// 指定 Pop 函数的回调处理函数</span>
	<span class="token punctuation">}</span>
	<span class="token operator">...</span><span class="token operator">...</span>
<span class="token punctuation">}</span>

<span class="token comment">// 真正的 Pop 回调处理函数</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>sharedIndexInformer<span class="token punctuation">)</span> <span class="token function">HandleDeltas</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	s<span class="token punctuation">.</span>blockDeltas<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> s<span class="token punctuation">.</span>blockDeltas<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// from oldest to newest</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> d <span class="token operator">:=</span> <span class="token keyword">range</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span>Deltas<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">switch</span> d<span class="token punctuation">.</span>Type <span class="token punctuation">{</span>
		<span class="token keyword">case</span> Sync<span class="token punctuation">,</span> Replaced<span class="token punctuation">,</span> Added<span class="token punctuation">,</span> Updated<span class="token punctuation">:</span>
			s<span class="token punctuation">.</span>cacheMutationDetector<span class="token punctuation">.</span><span class="token function">AddObject</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>Object<span class="token punctuation">)</span>
			<span class="token keyword">if</span> old<span class="token punctuation">,</span> exists<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>indexer<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>Object<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> exists <span class="token punctuation">{</span>
				<span class="token operator">...</span><span class="token operator">...</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 将对象添加到 Indexer 中</span>
				<span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>indexer<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>Object<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
					<span class="token keyword">return</span> err
				<span class="token punctuation">}</span>
				<span class="token operator">...</span><span class="token operator">...</span>
			<span class="token punctuation">}</span>
		<span class="token keyword">case</span> Deleted<span class="token punctuation">:</span>
      <span class="token comment">// 删除 Indexer 中的对象</span>
			<span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>indexer<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>Object<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> err
			<span class="token punctuation">}</span>
			<span class="token operator">...</span><span class="token operator">...</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><p>从上面可以看出 DeltaFIFO 中的元素被弹出来后被同步到了 Indexer 存储中，而在 DeltaFIFO 中的 KnownObjects 也就是这个指定的 Indexer，所以接下来我们就需要重点分析 Indexer 组件的实现了。</p> <h3 id="_2-3-indexer"><a href="#_2-3-indexer" class="header-anchor">#</a> 2.3 Indexer</h3> <p><img src="https://img-blog.csdnimg.cn/2b7f0e0478cc4e35b811875906d663d9.png" alt="img"></p> <p>上节课我们讲到 DeltaFIFO 中的元素通过 Pop 函数弹出后，在指定的回调函数中将元素添加到了 Indexer 中。Indexer 是什么？字面意思是索引器，它就是 Informer 中的 LocalStore 部分，我们可以和数据库进行类比，数据库是建立在存储之上的，索引也是构建在存储之上，只是和数据做了一个映射，使得按照某些条件查询速度会非常快，所以说 Indexer 本身也是一个存储，只是它在存储的基础上扩展了索引功能。从 Indexer 接口的定义可以证明这一点：</p> <p>在去查看 Indexer 的接口具体实现之前，我们需要了解 Indexer 中几个非常重要的概念：Indices、Index、Indexers 及 IndexFunc。</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/e470cdec594d0279457a5b16c27456d7.png" alt="img"></p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/indexer.go</span>

<span class="token comment">// 用于计算一个对象的索引键集合</span>
<span class="token keyword">type</span> IndexFunc <span class="token keyword">func</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>

<span class="token comment">// 索引键与对象键集合的映射</span>
<span class="token keyword">type</span> Index <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>sets<span class="token punctuation">.</span>String

<span class="token comment">// 索引器名称与 IndexFunc 的映射，相当于存储索引的各种分类</span>
<span class="token keyword">type</span> Indexers <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>IndexFunc

<span class="token comment">// 索引器名称与 Index 索引的映射</span>
<span class="token keyword">type</span> Indices <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>Index
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>这4个数据结构的命名非常容易让大家混淆，直接查看源码也不是那么容易的。这里我们来仔细解释下。首先什么叫索引，索引就是为了快速查找的，比如我们需要查找某个节点上的所有 Pod，那就让 Pod 按照节点名称排序列举出来，对应的就是 Index 这个类型，具体的就是 <code>map[node]sets.pod</code>，但是如何去查找可以有多种方式，就是上面的 Indexers 这个类型的作用。我们可以用一个比较具体的示例来解释他们的关系和含义，如下所示：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>

	v1 <span class="token string">&quot;k8s.io/api/core/v1&quot;</span>
	<span class="token string">&quot;k8s.io/apimachinery/pkg/api/meta&quot;</span>
	metav1 <span class="token string">&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span>
	<span class="token string">&quot;k8s.io/client-go/tools/cache&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
	NamespaceIndexName <span class="token operator">=</span> <span class="token string">&quot;namespace&quot;</span>
	NodeNameIndexName  <span class="token operator">=</span> <span class="token string">&quot;nodeName&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">NamespaceIndexFunc</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	m<span class="token punctuation">,</span> err <span class="token operator">:=</span> meta<span class="token punctuation">.</span><span class="token function">Accessor</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;object has no meta: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>m<span class="token punctuation">.</span><span class="token function">GetNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NodeNameIndexFunc</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	pod<span class="token punctuation">,</span> ok <span class="token operator">:=</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>pod<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>NodeName<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	index <span class="token operator">:=</span> cache<span class="token punctuation">.</span><span class="token function">NewIndexer</span><span class="token punctuation">(</span>cache<span class="token punctuation">.</span>MetaNamespaceKeyFunc<span class="token punctuation">,</span> cache<span class="token punctuation">.</span>Indexers<span class="token punctuation">{</span>
		NamespaceIndexName<span class="token punctuation">:</span> NamespaceIndexFunc<span class="token punctuation">,</span>
		NodeNameIndexName<span class="token punctuation">:</span>  NodeNameIndexFunc<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	pod1 <span class="token operator">:=</span> <span class="token operator">&amp;</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">{</span>
		ObjectMeta<span class="token punctuation">:</span> metav1<span class="token punctuation">.</span>ObjectMeta<span class="token punctuation">{</span>
			Name<span class="token punctuation">:</span>      <span class="token string">&quot;index-pod-1&quot;</span><span class="token punctuation">,</span>
			Namespace<span class="token punctuation">:</span> <span class="token string">&quot;default&quot;</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		Spec<span class="token punctuation">:</span> v1<span class="token punctuation">.</span>PodSpec<span class="token punctuation">{</span>NodeName<span class="token punctuation">:</span> <span class="token string">&quot;node1&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	pod2 <span class="token operator">:=</span> <span class="token operator">&amp;</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">{</span>
		ObjectMeta<span class="token punctuation">:</span> metav1<span class="token punctuation">.</span>ObjectMeta<span class="token punctuation">{</span>
			Name<span class="token punctuation">:</span>      <span class="token string">&quot;index-pod-2&quot;</span><span class="token punctuation">,</span>
			Namespace<span class="token punctuation">:</span> <span class="token string">&quot;default&quot;</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		Spec<span class="token punctuation">:</span> v1<span class="token punctuation">.</span>PodSpec<span class="token punctuation">{</span>NodeName<span class="token punctuation">:</span> <span class="token string">&quot;node2&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	pod3 <span class="token operator">:=</span> <span class="token operator">&amp;</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">{</span>
		ObjectMeta<span class="token punctuation">:</span> metav1<span class="token punctuation">.</span>ObjectMeta<span class="token punctuation">{</span>
			Name<span class="token punctuation">:</span>      <span class="token string">&quot;index-pod-3&quot;</span><span class="token punctuation">,</span>
			Namespace<span class="token punctuation">:</span> <span class="token string">&quot;kube-system&quot;</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		Spec<span class="token punctuation">:</span> v1<span class="token punctuation">.</span>PodSpec<span class="token punctuation">{</span>NodeName<span class="token punctuation">:</span> <span class="token string">&quot;node2&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	<span class="token boolean">_</span> <span class="token operator">=</span> index<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>pod1<span class="token punctuation">)</span>
	<span class="token boolean">_</span> <span class="token operator">=</span> index<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>pod2<span class="token punctuation">)</span>
	<span class="token boolean">_</span> <span class="token operator">=</span> index<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>pod3<span class="token punctuation">)</span>

	<span class="token comment">// ByIndex 两个参数：IndexName（索引器名称）和 indexKey（需要检索的key）</span>
	pods<span class="token punctuation">,</span> err <span class="token operator">:=</span> index<span class="token punctuation">.</span><span class="token function">ByIndex</span><span class="token punctuation">(</span>NamespaceIndexName<span class="token punctuation">,</span> <span class="token string">&quot;default&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> pod <span class="token operator">:=</span> <span class="token keyword">range</span> pods <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>pod<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">)</span><span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;==========================&quot;</span><span class="token punctuation">)</span>

	pods<span class="token punctuation">,</span> err <span class="token operator">=</span> index<span class="token punctuation">.</span><span class="token function">ByIndex</span><span class="token punctuation">(</span>NodeNameIndexName<span class="token punctuation">,</span> <span class="token string">&quot;node2&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> pod <span class="token operator">:=</span> <span class="token keyword">range</span> pods <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>pod<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">)</span><span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token comment">// 输出结果为：</span>
index<span class="token operator">-</span>pod<span class="token operator">-</span><span class="token number">1</span>
index<span class="token operator">-</span>pod<span class="token operator">-</span><span class="token number">2</span>
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
index<span class="token operator">-</span>pod<span class="token operator">-</span><span class="token number">2</span>
index<span class="token operator">-</span>pod<span class="token operator">-</span><span class="token number">3</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br></div></div><p>在上面的示例中首先通过 NewIndexer 函数实例化 Indexer 对象，第一个参数就是用于计算资源对象键的函数，这里我们使用的是 <code>MetaNamespaceKeyFunc</code> 这个默认的对象键函数；第二个参数是 Indexers，也就是存储索引器，上面我们知道 <code>Indexers</code> 的定义为 <code>map[string]IndexFunc</code>，为什么要定义成一个 map 呢？我们可以类比数据库中，我们要查询某项数据，索引的方式是不是多种多样啊？为了扩展，Kubernetes 中就使用一个 map 来存储各种各样的存储索引器，至于存储索引器如何生成，就使用一个 <code>IndexFunc</code> 暴露出去，给使用者自己实现即可。</p> <p>这里我们定义的了两个索引键生成函数： <code>NamespaceIndexFunc</code> 与 <code>NodeNameIndexFunc</code>，一个根据资源对象的命名空间来进行索引，一个根据资源对象所在的节点进行索引。然后定义了3个 Pod，前两个在 default 命名空间下面，另外一个在 kube-system 命名空间下面，然后通过 <code>index.Add</code> 函数添加这3个 Pod 资源对象。然后通过 <code>index.ByIndex</code> 函数查询在名为 <code>namespace</code> 的索引器下面匹配索引键为 <code>default</code> 的 Pod 列表。也就是查询 default 这个命名空间下面的所有 Pod，这里就是前两个定义的 Pod。</p> <p>对上面的示例如果我们理解了，那么就很容易理解上面定义的4个数据结构了：</p> <ul><li>IndexFunc：索引器函数，用于计算一个资源对象的索引值列表，上面示例是指定命名空间为索引值结果，当然我们也可以根据需求定义其他的，比如根据 Label 标签、Annotation 等属性来生成索引值列表。</li> <li>Index：存储数据，对于上面的示例，我们要查找某个命名空间下面的 Pod，那就要让 Pod 按照其命名空间进行索引，对应的 Index 类型就是 <code>map[namespace]sets.pod</code>。</li> <li>Indexers：存储索引器，key 为索引器名称，value 为索引器的实现函数，上面的示例就是 <code>map[&quot;namespace&quot;]MetaNamespaceIndexFunc</code>。</li> <li>Indices：存储缓存器，key 为索引器名称，value 为缓存的数据，对于上面的示例就是 <code>map[&quot;namespace&quot;]map[namespace]sets.pod</code>。</li></ul> <p>可能最容易混淆的是 Indexers 和 Indices 这两个概念，因为平时很多时候我们没有怎么区分二者的关系，这里我们可以这样理解：Indexers 是存储索引的，Indices 里面是存储的真正的数据（对象键），这样可能更好理解。</p> <p><img src="https://bxdc-static.oss-cn-beijing.aliyuncs.com/images/client-go-indexer-arch.png" alt="https://bxdc-static.oss-cn-beijing.aliyuncs.com/images/client-go-indexer-arch.png"></p> <p>按照上面的理解我们可以得到上面示例的索引数据如下所示：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// Indexers 就是包含的所有索引器(分类)以及对应实现</span>
Indexers<span class="token punctuation">:</span> <span class="token punctuation">{</span>  
  <span class="token string">&quot;namespace&quot;</span><span class="token punctuation">:</span> NamespaceIndexFunc<span class="token punctuation">,</span>
  <span class="token string">&quot;nodeName&quot;</span><span class="token punctuation">:</span> NodeNameIndexFunc<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token comment">// Indices 就是包含的所有索引分类中所有的索引数据</span>
Indices<span class="token punctuation">:</span> <span class="token punctuation">{</span>
	<span class="token string">&quot;namespace&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>  <span class="token comment">//namespace 这个索引分类下的所有索引数据</span>
		<span class="token string">&quot;default&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;pod-1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pod-2&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// Index 就是一个索引键下所有的对象键列表</span>
		<span class="token string">&quot;kube-system&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;pod-3&quot;</span><span class="token punctuation">]</span>   <span class="token comment">// Index</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token string">&quot;nodeName&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>  <span class="token comment">//nodeName 这个索引分类下的所有索引数据(对象键列表)</span>
		<span class="token string">&quot;node1&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;pod-1&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// Index</span>
		<span class="token string">&quot;node2&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;pod-2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pod-3&quot;</span><span class="token punctuation">]</span>  <span class="token comment">// Index</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="_2-3-1-threadsafemap"><a href="#_2-3-1-threadsafemap" class="header-anchor">#</a> 2.3.1 ThreadSafeMap</h4> <p>上面我们理解了 Indexer 中的几个重要的数据类型，下面我们来看下 Indexer 接口的具体实现 cache，位于文件 <code>k8s.io/client-go/tools/cache/store.go</code> 中：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// [k8s.io/client-go/tools/cache/store.go](&lt;http://k8s.io/client-go/tools/cache/store.go&gt;)</span>

<span class="token comment">// cache 用一个 ThreadSafeStore 和一个关联的 KeyFunc 来实现 Indexer</span>
<span class="token keyword">type</span> cache <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token comment">// cacheStorage 是一个线程安全的存储</span>
	cacheStorage ThreadSafeStore
  <span class="token comment">// keyFunc 用于计算对象键</span>
	keyFunc KeyFunc
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>我们可以看到这个 cache 包含一个 <code>ThreadSafeStore</code> 的属性，这是一个并发安全的存储，因为是存储，所以自然就有存储相关的增、删、改、查等操作，Indexer 就是在 ThreadSafeMap 基础上进行封装的，实现了索引相关的功能。接下来我们先来看看 ThreadSafeStore 的定义，位于 <code>k8s.io/client-go/tools/cache/thread_safe_store.go</code> 文件中：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> ThreadSafeStore <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Add</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">,</span> obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token function">Update</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">,</span> obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token function">Delete</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span>
	<span class="token function">Get</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>item <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> exists <span class="token builtin">bool</span><span class="token punctuation">)</span>
	<span class="token function">List</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token function">ListKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
	<span class="token function">Replace</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">)</span>
	<span class="token function">Index</span><span class="token punctuation">(</span>indexName <span class="token builtin">string</span><span class="token punctuation">,</span> obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
	<span class="token function">IndexKeys</span><span class="token punctuation">(</span>indexName<span class="token punctuation">,</span> indexKey <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
	<span class="token function">ListIndexFuncValues</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
	<span class="token function">ByIndex</span><span class="token punctuation">(</span>indexName<span class="token punctuation">,</span> indexKey <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
	<span class="token function">GetIndexers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Indexers

	<span class="token function">AddIndexers</span><span class="token punctuation">(</span>newIndexers Indexers<span class="token punctuation">)</span> <span class="token builtin">error</span>
	<span class="token function">Resync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>从接口的定义可以看出 ThreadSafeStore 和 Index 基本上差不多，但还是有一些区别的，这个接口是需要通过对象键来进行索引的。接下来我们来看看这个接口的具体实现 threadSafeMap 的定义：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/thread_safe_store.go</span>

<span class="token comment">// threadSafeMap 实现了 ThreadSafeStore</span>
<span class="token keyword">type</span> threadSafeMap <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	lock  sync<span class="token punctuation">.</span>RWMutex
  <span class="token comment">// 存储资源对象数据，key(对象键) 通过 keyFunc 得到</span>
  <span class="token comment">// 这就是真正存储的数据（对象键 -&gt; 对象）</span>
	items <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

	<span class="token comment">// indexers 索引分类与索引键函数的映射</span>
	indexers Indexers
	<span class="token comment">// indices 通过索引可以快速找到对象键</span>
	indices Indices
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>不要把索引键和对象键搞混了，索引键是用于对象快速查找的；对象键是对象在存储中的唯一命名，对象是通过名字+对象的方式存储的。接下来我们来仔细看下接口的具体实现，首先还是比较简单的 Add、Delete、Update 几个函数的实现：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/thread_safe_store.go</span>

<span class="token comment">// 添加对象</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>threadSafeMap<span class="token punctuation">)</span> <span class="token function">Add</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">,</span> obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 获取老的对象</span>
	oldObject <span class="token operator">:=</span> c<span class="token punctuation">.</span>items<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
  <span class="token comment">// 写入新的对象，items 中存的是 objKey -&gt; obj 的映射</span>
	c<span class="token punctuation">.</span>items<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> obj
  <span class="token comment">// 添加了新的对象，所以要更新索引</span>
	c<span class="token punctuation">.</span><span class="token function">updateIndices</span><span class="token punctuation">(</span>oldObject<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 更新对象，可以看到实现和 Add 是一样的</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>threadSafeMap<span class="token punctuation">)</span> <span class="token function">Update</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">,</span> obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	oldObject <span class="token operator">:=</span> c<span class="token punctuation">.</span>items<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
	c<span class="token punctuation">.</span>items<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> obj
	c<span class="token punctuation">.</span><span class="token function">updateIndices</span><span class="token punctuation">(</span>oldObject<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 删除对象</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>threadSafeMap<span class="token punctuation">)</span> <span class="token function">Delete</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 判断对象是否存在，存在才执行删除操作</span>
	<span class="token keyword">if</span> obj<span class="token punctuation">,</span> exists <span class="token operator">:=</span> c<span class="token punctuation">.</span>items<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span> exists <span class="token punctuation">{</span>
    <span class="token comment">// 删除对象索引</span>
		c<span class="token punctuation">.</span><span class="token function">deleteFromIndices</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    <span class="token comment">// 删除对象本身</span>
		<span class="token function">delete</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>items<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>可以看到基本的实现比较简单，就是添加、更新、删除对象数据后，然后更新或删除对应的索引，所以我们需要查看下更新或删除索引的具体实现：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/thread_safe_store.go</span>

<span class="token comment">// updateIndices 更新索引</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>threadSafeMap<span class="token punctuation">)</span> <span class="token function">updateIndices</span><span class="token punctuation">(</span>oldObj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> newObj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 如果有旧的对象，需要先从索引中删除这个对象</span>
	<span class="token keyword">if</span> oldObj <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span><span class="token function">deleteFromIndices</span><span class="token punctuation">(</span>oldObj<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// 循环所有的索引器</span>
	<span class="token keyword">for</span> name<span class="token punctuation">,</span> indexFunc <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>indexers <span class="token punctuation">{</span>
    <span class="token comment">// 获取对象的索引键</span>
		indexValues<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">indexFunc</span><span class="token punctuation">(</span>newObj<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;unable to calculate an index entry for key %q on index %q: %v&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> name<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
    <span class="token comment">// 得到当前索引器的索引</span>
		index <span class="token operator">:=</span> c<span class="token punctuation">.</span>indices<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
		<span class="token keyword">if</span> index <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
      <span class="token comment">// 没有对应的索引，则初始化一个索引</span>
			index <span class="token operator">=</span> Index<span class="token punctuation">{</span><span class="token punctuation">}</span>
			c<span class="token punctuation">.</span>indices<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> index
		<span class="token punctuation">}</span>
    <span class="token comment">// 循环所有的索引键</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> indexValue <span class="token operator">:=</span> <span class="token keyword">range</span> indexValues <span class="token punctuation">{</span>
      <span class="token comment">// 得到索引键对应的对象键列表</span>
			set <span class="token operator">:=</span> index<span class="token punctuation">[</span>indexValue<span class="token punctuation">]</span>
			<span class="token keyword">if</span> set <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token comment">// 没有对象键列表则初始化一个空列表</span>
				set <span class="token operator">=</span> sets<span class="token punctuation">.</span>String<span class="token punctuation">{</span><span class="token punctuation">}</span>
				index<span class="token punctuation">[</span>indexValue<span class="token punctuation">]</span> <span class="token operator">=</span> set
			<span class="token punctuation">}</span>
      <span class="token comment">// 将对象键插入到集合中，方便索引</span>
			set<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// deleteFromIndices 删除对象索引</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>threadSafeMap<span class="token punctuation">)</span> <span class="token function">deleteFromIndices</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 循环所有的索引器</span>
	<span class="token keyword">for</span> name<span class="token punctuation">,</span> indexFunc <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>indexers <span class="token punctuation">{</span>
    <span class="token comment">// 获取删除对象的索引键列表</span>
		indexValues<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">indexFunc</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;unable to calculate an index entry for key %q on index %q: %v&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> name<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
    <span class="token comment">// 获取当前索引器的索引</span>
		index <span class="token operator">:=</span> c<span class="token punctuation">.</span>indices<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
		<span class="token keyword">if</span> index <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
    <span class="token comment">// 循环所有索引键</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> indexValue <span class="token operator">:=</span> <span class="token keyword">range</span> indexValues <span class="token punctuation">{</span>
      <span class="token comment">// 获取索引键对应的对象键列表</span>
			set <span class="token operator">:=</span> index<span class="token punctuation">[</span>indexValue<span class="token punctuation">]</span>
			<span class="token keyword">if</span> set <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token comment">// 从对象键列表中删除当前要删除的对象键</span>
				set<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>

				<span class="token comment">// 如果当集合为空的时候不删除set，那么具有高基数的短生命资源的 indices 会导致未使用的空集合随时间增加内存。</span>
        <span class="token comment">// `kubernetes/kubernetes/issues/84959`.</span>
        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>set<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
					<span class="token function">delete</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> indexValue<span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br></div></div><p>添加索引和删除索引的实现都挺简单的，其实主要还是要对 indices、indexs 这些数据结构非常了解，这样就非常容易了，我们可以将 indexFunc 当成当前对象的命名空间来看待，这样对于上面的索引更新和删除的理解就肯定没问题了。</p> <p>然后接下来就是几个查询相关的接口实现：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/thread_safe_store.go</span>

<span class="token comment">// 获取对象</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>threadSafeMap<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>item <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> exists <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 只需要读锁</span>
	<span class="token keyword">defer</span> c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 直接从 map 中读取值</span>
	item<span class="token punctuation">,</span> exists <span class="token operator">=</span> c<span class="token punctuation">.</span>items<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
	<span class="token keyword">return</span> item<span class="token punctuation">,</span> exists
<span class="token punctuation">}</span>

<span class="token comment">// 对象列举</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>threadSafeMap<span class="token punctuation">)</span> <span class="token function">List</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	list <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>items<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> item <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>items <span class="token punctuation">{</span>
		list <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> item<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> list
<span class="token punctuation">}</span>

<span class="token comment">// 返回 threadSafeMap 中所有的对象键列表</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>threadSafeMap<span class="token punctuation">)</span> <span class="token function">ListKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	list <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>items<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> key <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>items <span class="token punctuation">{</span>
		list <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> list
<span class="token punctuation">}</span>

<span class="token comment">// 替换所有对象，相当于重新构建索引</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>threadSafeMap<span class="token punctuation">)</span> <span class="token function">Replace</span><span class="token punctuation">(</span>items <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> resourceVersion <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 直接覆盖之前的对象</span>
	c<span class="token punctuation">.</span>items <span class="token operator">=</span> items

	<span class="token comment">// 重新构建索引</span>
	c<span class="token punctuation">.</span>indices <span class="token operator">=</span> Indices<span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token keyword">for</span> key<span class="token punctuation">,</span> item <span class="token operator">:=</span> <span class="token keyword">range</span> c<span class="token punctuation">.</span>items <span class="token punctuation">{</span>
    <span class="token comment">// 更新元素的索引</span>
		c<span class="token punctuation">.</span><span class="token function">updateIndices</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> item<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><p>然后接下来就是和索引相关的几个接口实现，第一个就是 Index 函数：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/thread_safe_store.go</span>

<span class="token comment">// 通过指定的索引器和对象获取符合这个对象特征的所有对象</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>threadSafeMap<span class="token punctuation">)</span> <span class="token function">Index</span><span class="token punctuation">(</span>indexName <span class="token builtin">string</span><span class="token punctuation">,</span> obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 获得索引器 indexName 的索引键计算函数</span>
	indexFunc <span class="token operator">:=</span> c<span class="token punctuation">.</span>indexers<span class="token punctuation">[</span>indexName<span class="token punctuation">]</span>
	<span class="token keyword">if</span> indexFunc <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;Index with name %s does not exist&quot;</span><span class="token punctuation">,</span> indexName<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// 获取指定 obj 对象的索引键</span>
	indexedValues<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">indexFunc</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
  <span class="token comment">// 获得索引器 indexName 的所有索引</span>
	index <span class="token operator">:=</span> c<span class="token punctuation">.</span>indices<span class="token punctuation">[</span>indexName<span class="token punctuation">]</span>
 
  <span class="token comment">// 用来存储对象键的集合</span>
	<span class="token keyword">var</span> storeKeySet sets<span class="token punctuation">.</span>String
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>indexedValues<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span>
    <span class="token comment">// 大多数情况下只有一个值匹配（默认获取的索引键就是对象的 namespace）</span>
    <span class="token comment">// 直接拿到这个索引键的对象键集合</span>
		storeKeySet <span class="token operator">=</span> index<span class="token punctuation">[</span>indexedValues<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 由于有多个索引键，则可能有重复的对象键出现，索引需要去重</span>
		storeKeySet <span class="token operator">=</span> sets<span class="token punctuation">.</span>String<span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token comment">// 循环索引键</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> indexedValue <span class="token operator">:=</span> <span class="token keyword">range</span> indexedValues <span class="token punctuation">{</span>
      <span class="token comment">// 循环索引键下面的对象键，因为要去重</span>
			<span class="token keyword">for</span> key <span class="token operator">:=</span> <span class="token keyword">range</span> index<span class="token punctuation">[</span>indexedValue<span class="token punctuation">]</span> <span class="token punctuation">{</span>
				storeKeySet<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// 拿到了所有的对象键集合过后，循环拿到所有的对象集合</span>
	list <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> storeKeySet<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> storeKey <span class="token operator">:=</span> <span class="token keyword">range</span> storeKeySet <span class="token punctuation">{</span>
		list <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> c<span class="token punctuation">.</span>items<span class="token punctuation">[</span>storeKey<span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> list<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>这个 Index 函数就是获取一个指定对象的索引键，然后把这个索引键下面的所有的对象全部获取到，比如我们要获取一个 Pod 所在命名空间下面的所有 Pod，如果更抽象一点，就是符合对象<em>某些特征</em>的所有对象，而这个特征就是我们指定的索引键函数计算出来的。然后接下来就是一个比较重要的 ByIndex 函数的实现：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/thread_safe_store.go</span>

<span class="token comment">// 和上面的 Index 函数类似，只是是直接指定的索引键</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>threadSafeMap<span class="token punctuation">)</span> <span class="token function">ByIndex</span><span class="token punctuation">(</span>indexName<span class="token punctuation">,</span> indexedValue <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  
  <span class="token comment">// 获得索引器 indexName 的索引键计算函数</span>
	indexFunc <span class="token operator">:=</span> c<span class="token punctuation">.</span>indexers<span class="token punctuation">[</span>indexName<span class="token punctuation">]</span>
	<span class="token keyword">if</span> indexFunc <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;Index with name %s does not exist&quot;</span><span class="token punctuation">,</span> indexName<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// 获得索引器 indexName 的所有索引</span>
	index <span class="token operator">:=</span> c<span class="token punctuation">.</span>indices<span class="token punctuation">[</span>indexName<span class="token punctuation">]</span>
  <span class="token comment">// 获取指定索引键的所有所有对象键</span>
	set <span class="token operator">:=</span> index<span class="token punctuation">[</span>indexedValue<span class="token punctuation">]</span>
  <span class="token comment">// 然后根据对象键遍历获取对象</span>
	list <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> set<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> key <span class="token operator">:=</span> <span class="token keyword">range</span> set <span class="token punctuation">{</span>
		list <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> c<span class="token punctuation">.</span>items<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> list<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>可以很清楚地看到 ByIndex 函数和 Index 函数比较类似，但是更简单了，直接获取一个指定的索引键的全部资源对象。然后是其他几个索引相关的函数：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/thread_safe_store.go</span>

<span class="token comment">// IndexKeys 和上面的 ByIndex 几乎是一样的，只是这里是直接返回对象键列表</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>threadSafeMap<span class="token punctuation">)</span> <span class="token function">IndexKeys</span><span class="token punctuation">(</span>indexName<span class="token punctuation">,</span> indexedValue <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 获取索引器 indexName 的索引键计算函数</span>
	indexFunc <span class="token operator">:=</span> c<span class="token punctuation">.</span>indexers<span class="token punctuation">[</span>indexName<span class="token punctuation">]</span>
	<span class="token keyword">if</span> indexFunc <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;Index with name %s does not exist&quot;</span><span class="token punctuation">,</span> indexName<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// 获取索引器 indexName 的所有索引</span>
	index <span class="token operator">:=</span> c<span class="token punctuation">.</span>indices<span class="token punctuation">[</span>indexName<span class="token punctuation">]</span>
	<span class="token comment">// 直接获取指定索引键的对象键集合</span>
	set <span class="token operator">:=</span> index<span class="token punctuation">[</span>indexedValue<span class="token punctuation">]</span>
	<span class="token keyword">return</span> set<span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// 获取索引器下面的所有索引键</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>threadSafeMap<span class="token punctuation">)</span> <span class="token function">ListIndexFuncValues</span><span class="token punctuation">(</span>indexName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 获取索引器 indexName 的所有索引</span>
	index <span class="token operator">:=</span> c<span class="token punctuation">.</span>indices<span class="token punctuation">[</span>indexName<span class="token punctuation">]</span>
	names <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">// 遍历索引得到索引键</span>
	<span class="token keyword">for</span> key <span class="token operator">:=</span> <span class="token keyword">range</span> index <span class="token punctuation">{</span>
		names <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> names
<span class="token punctuation">}</span>

<span class="token comment">// 直接返回 indexers</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>threadSafeMap<span class="token punctuation">)</span> <span class="token function">GetIndexers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Indexers <span class="token punctuation">{</span>
	<span class="token keyword">return</span> c<span class="token punctuation">.</span>indexers
<span class="token punctuation">}</span>

<span class="token comment">// 添加一个新的 Indexers</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>threadSafeMap<span class="token punctuation">)</span> <span class="token function">AddIndexers</span><span class="token punctuation">(</span>newIndexers Indexers<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>items<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;cannot add indexers to running index&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// 获取旧的索引器和新的索引器keys</span>
	oldKeys <span class="token operator">:=</span> sets<span class="token punctuation">.</span><span class="token function">StringKeySet</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>indexers<span class="token punctuation">)</span>
	newKeys <span class="token operator">:=</span> sets<span class="token punctuation">.</span><span class="token function">StringKeySet</span><span class="token punctuation">(</span>newIndexers<span class="token punctuation">)</span>
  
  <span class="token comment">// 如果包含新的索引器，则提示冲突</span>
	<span class="token keyword">if</span> oldKeys<span class="token punctuation">.</span><span class="token function">HasAny</span><span class="token punctuation">(</span>newKeys<span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;indexer conflict: %v&quot;</span><span class="token punctuation">,</span> oldKeys<span class="token punctuation">.</span><span class="token function">Intersection</span><span class="token punctuation">(</span>newKeys<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// 将新的索引器添加到 Indexers 中</span>
	<span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> newIndexers <span class="token punctuation">{</span>
		c<span class="token punctuation">.</span>indexers<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> v
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// 没有真正实现 Resync 操作 </span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>threadSafeMap<span class="token punctuation">)</span> <span class="token function">Resync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br></div></div><p>这里我们就将 ThreadSafeMap 的实现进行了分析说明。整体来说比较方便，一个就是将对象数据存入到一个 map 中，然后就是维护索引，方便根据索引来查找到对应的对象。</p> <h4 id="_2-3-2-cache"><a href="#_2-3-2-cache" class="header-anchor">#</a> 2.3.2 cache</h4> <p>接下来再回过头去看 cache 的实现就非常简单了，因为 cache 就是对 ThreadSafeStore 的一个再次封装，很多操作都是直接调用的 <code>ThreadSafeStore</code> 的操作实现的，如下所示：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/store.go</span>

<span class="token comment">// Add 插入一个元素到 cache 中</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>cache<span class="token punctuation">)</span> <span class="token function">Add</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	key<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">keyFunc</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>  <span class="token comment">// 生成对象键</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> KeyError<span class="token punctuation">{</span>obj<span class="token punctuation">,</span> err<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// 将对象添加到底层的 ThreadSafeStore 中</span>
	c<span class="token punctuation">.</span>cacheStorage<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> obj<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// 更新cache中的对象</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>cache<span class="token punctuation">)</span> <span class="token function">Update</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	key<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">keyFunc</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> KeyError<span class="token punctuation">{</span>obj<span class="token punctuation">,</span> err<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	c<span class="token punctuation">.</span>cacheStorage<span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> obj<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// 删除cache中的对象</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>cache<span class="token punctuation">)</span> <span class="token function">Delete</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	key<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">keyFunc</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> KeyError<span class="token punctuation">{</span>obj<span class="token punctuation">,</span> err<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	c<span class="token punctuation">.</span>cacheStorage<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// 得到cache中所有的对象</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>cache<span class="token punctuation">)</span> <span class="token function">List</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> c<span class="token punctuation">.</span>cacheStorage<span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 得到cache中所有的对象键</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>cache<span class="token punctuation">)</span> <span class="token function">ListKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> c<span class="token punctuation">.</span>cacheStorage<span class="token punctuation">.</span><span class="token function">ListKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 得到cache中的Indexers</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>cache<span class="token punctuation">)</span> <span class="token function">GetIndexers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Indexers <span class="token punctuation">{</span>
	<span class="token keyword">return</span> c<span class="token punctuation">.</span>cacheStorage<span class="token punctuation">.</span><span class="token function">GetIndexers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 得到对象obj与indexName索引器关联的所有对象</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>cache<span class="token punctuation">)</span> <span class="token function">Index</span><span class="token punctuation">(</span>indexName <span class="token builtin">string</span><span class="token punctuation">,</span> obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> c<span class="token punctuation">.</span>cacheStorage<span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>indexName<span class="token punctuation">,</span> obj<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>cache<span class="token punctuation">)</span> <span class="token function">IndexKeys</span><span class="token punctuation">(</span>indexName<span class="token punctuation">,</span> indexKey <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> c<span class="token punctuation">.</span>cacheStorage<span class="token punctuation">.</span><span class="token function">IndexKeys</span><span class="token punctuation">(</span>indexName<span class="token punctuation">,</span> indexKey<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>cache<span class="token punctuation">)</span> <span class="token function">ListIndexFuncValues</span><span class="token punctuation">(</span>indexName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> c<span class="token punctuation">.</span>cacheStorage<span class="token punctuation">.</span><span class="token function">ListIndexFuncValues</span><span class="token punctuation">(</span>indexName<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>cache<span class="token punctuation">)</span> <span class="token function">ByIndex</span><span class="token punctuation">(</span>indexName<span class="token punctuation">,</span> indexKey <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> c<span class="token punctuation">.</span>cacheStorage<span class="token punctuation">.</span><span class="token function">ByIndex</span><span class="token punctuation">(</span>indexName<span class="token punctuation">,</span> indexKey<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>cache<span class="token punctuation">)</span> <span class="token function">AddIndexers</span><span class="token punctuation">(</span>newIndexers Indexers<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> c<span class="token punctuation">.</span>cacheStorage<span class="token punctuation">.</span><span class="token function">AddIndexers</span><span class="token punctuation">(</span>newIndexers<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>cache<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>item <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> exists <span class="token builtin">bool</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	key<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">keyFunc</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> KeyError<span class="token punctuation">{</span>obj<span class="token punctuation">,</span> err<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">GetByKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>cache<span class="token punctuation">)</span> <span class="token function">GetByKey</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>item <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> exists <span class="token builtin">bool</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	item<span class="token punctuation">,</span> exists <span class="token operator">=</span> c<span class="token punctuation">.</span>cacheStorage<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
	<span class="token keyword">return</span> item<span class="token punctuation">,</span> exists<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// 替换cache中所有的对象</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>cache<span class="token punctuation">)</span> <span class="token function">Replace</span><span class="token punctuation">(</span>list <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> resourceVersion <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	items <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> item <span class="token operator">:=</span> <span class="token keyword">range</span> list <span class="token punctuation">{</span>
		key<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">keyFunc</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> KeyError<span class="token punctuation">{</span>item<span class="token punctuation">,</span> err<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		items<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> item
	<span class="token punctuation">}</span>
	c<span class="token punctuation">.</span>cacheStorage<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span>items<span class="token punctuation">,</span> resourceVersion<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>cache<span class="token punctuation">)</span> <span class="token function">Resync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br></div></div><p>可以看到 cache 没有自己独特的实现方式，都是调用的包含的 <code>ThreadSafeStore</code> 操作接口。</p> <h4 id="_2-3-3-流程总结"><a href="#_2-3-3-流程总结" class="header-anchor">#</a> 2.3.3 流程总结</h4> <p>前面我们已经知道了 Reflector 通过 ListAndWatch 把数据传入 DeltaFIFO 后，经过 DeltaFIFO 的 Pop 函数将资源对象存入到了本地的一个存储 Indexer 中，而这个底层真正的存储其实就是上面的 ThreadSafeStore。</p> <p>要理解 Indexer 组件，最主要就是要把索引、索引器（索引分类）、索引键、对象键这几个概念弄清楚，有时候确实容易混乱，我们将上面的示例理解了应该就很好理解了，我们可以简单的理解为 Indexer 就是简单的把相同命名空间的对象放在一个集合中，然后基于命名空间来查找对象。</p> <h3 id="_2-4-sharedinformer"><a href="#_2-4-sharedinformer" class="header-anchor">#</a> 2.4 SharedInformer</h3> <p>若同一个资源的Informer被实例化了多次，每个Informer使用一个Reflector，那么会运行过多相同的ListAndWatch，太多重复的序列化和反序列化操作会导致api-server负载过重</p> <p>SharedInformer可以使同一类资源Informer共享一个Reflector。内部定义了一个map字段，用于存放所有Infromer的字段。</p> <h4 id="_2-4-1-sharedinformer"><a href="#_2-4-1-sharedinformer" class="header-anchor">#</a> 2.4.1  SharedInformer</h4> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/shared_informer.go</span>

<span class="token keyword">type</span> SharedInformer <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token comment">// 添加资源事件处理器，当有资源变化时就会通过回调通知使用者</span>
    <span class="token function">AddEventHandler</span><span class="token punctuation">(</span>handler ResourceEventHandler<span class="token punctuation">)</span>
    <span class="token comment">// 需要周期同步的资源事件处理器</span>
    <span class="token function">AddEventHandlerWithResyncPeriod</span><span class="token punctuation">(</span>handler ResourceEventHandler<span class="token punctuation">,</span> resyncPeriod time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span>
    
    <span class="token comment">// 获取一个 Store 对象，前面我们讲解了很多实现 Store 的结构</span>
    <span class="token function">GetStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Store
    <span class="token comment">// 获取一个 Controller，下面会详细介绍，主要是用来将 Reflector 和 DeltaFIFO 组合到一起工作</span>
    <span class="token function">GetController</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Controller

    <span class="token comment">// SharedInformer 的核心实现，启动并运行这个 SharedInformer</span>
    <span class="token comment">// 当 stopCh 关闭时候，informer 才会退出</span>
    <span class="token function">Run</span><span class="token punctuation">(</span>stopCh <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    <span class="token comment">// 告诉使用者全量的对象是否已经同步到了本地存储中</span>
    <span class="token function">HasSynced</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
    <span class="token comment">// 最新同步资源的版本</span>
    <span class="token function">LastSyncResourceVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token comment">// 在 SharedInformer 基础上扩展了添加和获取 Indexers 的能力</span>
<span class="token keyword">type</span> SharedIndexInformer <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    SharedInformer
    <span class="token comment">// 在启动之前添加 indexers 到 informer 中</span>
    <span class="token function">AddIndexers</span><span class="token punctuation">(</span>indexers Indexers<span class="token punctuation">)</span> <span class="token builtin">error</span>
    <span class="token function">GetIndexer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Indexer
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>如果我们要处理资源的事件的话，就需要添加一个事件处理器，传入一个 ResourceEventHandler 接口，其定义如下所示：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/controller.go</span>

<span class="token keyword">type</span> ResourceEventHandler <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token comment">// 添加对象回调函数</span>
    <span class="token function">OnAdd</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 更新对象回调函数</span>
    <span class="token function">OnUpdate</span><span class="token punctuation">(</span>oldObj<span class="token punctuation">,</span> newObj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 删除对象回调函数</span>
    <span class="token function">OnDelete</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>然后接下来我们来看看 SharedIndexInformer 的具体实现类的定义：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/shared_informer.go</span>

<span class="token keyword">type</span> sharedIndexInformer <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment">// Indexer也是一种Store，这个我们知道的，Controller负责把Reflector和FIFO逻辑串联起来</span>
    <span class="token comment">// 所以这两个变量就涵盖了开篇那张图里面的Reflector、DeltaFIFO和LocalStore(cache)</span>
    indexer    Indexer
    <span class="token comment">// 在 Controller 中将 Reflector 和 DeltaFIFO 关联了起来</span>
    controller Controller

    <span class="token comment">// 可能会存在多个ResourceEventHandler 对 ResourceEventHandler 进行了一层层封装，统一由 sharedProcessor 管理</span>
    processor             <span class="token operator">*</span>sharedProcessor
   
    <span class="token comment">// 监控对象在一个时间窗口内是否发生了变化</span>
    cacheMutationDetector MutationDetector

    <span class="token comment">// 用于 Reflector 中真正执行 ListAndWatch 的操作</span>
    listerWatcher ListerWatcher

    <span class="token comment">// informer 中要处理的对象</span>
    objectType    runtime<span class="token punctuation">.</span>Object

    <span class="token comment">// 定期同步周期</span>
    resyncCheckPeriod time<span class="token punctuation">.</span>Duration
    <span class="token comment">// 任何通过 AddEventHandler 添加的处理程序的默认重新同步的周期</span>
    defaultEventHandlerResyncPeriod time<span class="token punctuation">.</span>Duration
    clock clock<span class="token punctuation">.</span>Clock

    <span class="token comment">// 启动、停止标记</span>
    started<span class="token punctuation">,</span> stopped <span class="token builtin">bool</span>
    startedLock      sync<span class="token punctuation">.</span>Mutex
 
    blockDeltas sync<span class="token punctuation">.</span>Mutex
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h4 id="_2-4-2-controller"><a href="#_2-4-2-controller" class="header-anchor">#</a> 2.4.2 Controller</h4> <p>上面我们看到在 sharedIndexInformer 中定义了一个 Controller，这里的 Controller 并不是我们比较熟悉的 kube-controller-manager 管理的各种控制器，这里的 Controller 定义在 <code>client-go/tools/cache/controller.go</code> 中，目的是用来把 Reflector、DeltaFIFO 这些组件组合起来形成一个相对固定的、标准的处理流程。我们先来看下 Controller 的定义：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/controller.go</span>

<span class="token comment">// Controller 的抽象接口</span>
<span class="token keyword">type</span> Controller <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token comment">// Run 函数主要做两件事，一件是构造并运行一个 Reflector 反射器，将对象/通知从 Config 的</span>
    <span class="token comment">// ListerWatcher 送到 Config 的 Queue 队列，并在该队列上调用 Resync 操作</span>
    <span class="token comment">// 另外一件事就是不断从队列中弹出对象，并使用 Config 的 ProcessFunc 进行处理</span>
    <span class="token function">Run</span><span class="token punctuation">(</span>stopCh <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>      
    <span class="token function">HasSynced</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>                 <span class="token comment">// APIServer 中的资源对象是否同步到了 Store 中</span>
    <span class="token function">LastSyncResourceVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token comment">// 最新的资源版本号</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>因为 Controller 把多个模块整合起来实现了一套业务逻辑，所以在创建Controller 的时候需要提供一些配置：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/controller.go</span>

<span class="token keyword">type</span> Config <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Queue                          <span class="token comment">// 资源对象的队列，其实就是一个 DeltaFIFO</span>
    ListerWatcher                  <span class="token comment">// 用来构造 Reflector 的</span>
    Process ProcessFunc            <span class="token comment">// DeltaFIFO 队列 Pop 的时候回调函数，用于处理弹出的对象</span>
    ObjectType runtime<span class="token punctuation">.</span>Object      <span class="token comment">// 对象类型，也就是 Reflector 中使用的</span>
    FullResyncPeriod time<span class="token punctuation">.</span>Duration <span class="token comment">// 全量同步周期，在 Reflector 中使用</span>
    ShouldResync ShouldResyncFunc  <span class="token comment">// Reflector 中是否需要 Resync 操作</span>
    RetryOnError <span class="token builtin">bool</span>              <span class="token comment">// 出现错误是否需要重试</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>Controller 自己构造 Reflector 获取对象，Reflector 作为 DeltaFIFO 生产者持续监控 APIServer 的资源变化并推送到队列中。Controller 的 Run() 就是是队列的消费者，从队列中弹出对象并调用 Process() 进行处理。接下来我们来看 Controller 的一个具体实现 controller：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/controller.go</span>

<span class="token comment">// controller是 Controller 的一个具体实现</span>
<span class="token keyword">type</span> controller <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    config         Config       <span class="token comment">// 配置</span>
    reflector      <span class="token operator">*</span>Reflector   <span class="token comment">// 反射器</span>
    reflectorMutex sync<span class="token punctuation">.</span>RWMutex <span class="token comment">// 反射器的锁</span>
    clock          clock<span class="token punctuation">.</span>Clock  <span class="token comment">// 时钟</span>
<span class="token punctuation">}</span>

<span class="token comment">// 控制器核心实现</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>controller<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span>stopCh <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">defer</span> utilruntime<span class="token punctuation">.</span><span class="token function">HandleCrash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 新建一个协程，如果收到系统退出的信号就关闭队列</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">&lt;-</span>stopCh
        c<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Queue<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 实例化一个 Reflector，传入的参数都是从 Config 中获取的</span>
    r <span class="token operator">:=</span> <span class="token function">NewReflector</span><span class="token punctuation">(</span>
        c<span class="token punctuation">.</span>config<span class="token punctuation">.</span>ListerWatcher<span class="token punctuation">,</span>
        c<span class="token punctuation">.</span>config<span class="token punctuation">.</span>ObjectType<span class="token punctuation">,</span>
        c<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Queue<span class="token punctuation">,</span>
        c<span class="token punctuation">.</span>config<span class="token punctuation">.</span>FullResyncPeriod<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    r<span class="token punctuation">.</span>ShouldResync <span class="token operator">=</span> c<span class="token punctuation">.</span>config<span class="token punctuation">.</span>ShouldResync
    r<span class="token punctuation">.</span>clock <span class="token operator">=</span> c<span class="token punctuation">.</span>clock

    <span class="token comment">// 将反射器给到controller</span>
    c<span class="token punctuation">.</span>reflectorMutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    c<span class="token punctuation">.</span>reflector <span class="token operator">=</span> r
    c<span class="token punctuation">.</span>reflectorMutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// 等待所有协程执行完毕</span>
    <span class="token keyword">var</span> wg wait<span class="token punctuation">.</span>Group
    <span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// StartWithChannel 会启动协程执行 Reflector.Run()，接收到 stopCh 信号才会退出协程</span>
    wg<span class="token punctuation">.</span><span class="token function">StartWithChannel</span><span class="token punctuation">(</span>stopCh<span class="token punctuation">,</span> r<span class="token punctuation">.</span>Run<span class="token punctuation">)</span>
    
		<span class="token comment">// wait.Unitl() 就是周期性的调用 c.processLoop() 操作处理弹出的对象</span>
    wait<span class="token punctuation">.</span><span class="token function">Until</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>processLoop<span class="token punctuation">,</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> stopCh<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>从上面的核心函数 Run 的实现方式来看，该函数中主要就是实例化一个 Reflector，然后启动一个协程去执行这个反射器的 Run 函数，这个 Run 函数前面我们已经讲解过就是去调用 ListAndWatch 函数进行 List 和 Watch 操作，这个操作中具体的实现就是 Config 中的 ListerWatcher。然后的一个核心就是 processLoop() 函数的实现：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/controller.go</span>

<span class="token comment">// 处理队列弹出的对象</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>controller<span class="token punctuation">)</span> <span class="token function">processLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 死循环，不断从队列中弹出对象来处理</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
    <span class="token comment">// 从队列中弹出一个对象，然后处理这个对象</span>
    <span class="token comment">// 真正处理的是通过 Config 传递进来的 Process 函数</span>
		obj<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Queue<span class="token punctuation">.</span><span class="token function">Pop</span><span class="token punctuation">(</span><span class="token function">PopProcessFunc</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Process<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果队列关闭了那就直接退出了</span>
			<span class="token keyword">if</span> err <span class="token operator">==</span> ErrFIFOClosed <span class="token punctuation">{</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
      <span class="token comment">// 如果配置的是错误后允许重试</span>
			<span class="token keyword">if</span> c<span class="token punctuation">.</span>config<span class="token punctuation">.</span>RetryOnError <span class="token punctuation">{</span>
				<span class="token comment">// 如果错误可以再重试那么将弹出的对象重新入队列进行处理</span>
				c<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Queue<span class="token punctuation">.</span><span class="token function">AddIfNotPresent</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>上面的代码其实核心的处理就是从 DeltaFIFO 中不断 Pop 出一个对象，然后交给 Config 传递进来的 Process 函数去处理，这个函数是在 SharedInformer 中初始化的时候传递进来的。</p> <h4 id="_2-4-3-sharedprocessor"><a href="#_2-4-3-sharedprocessor" class="header-anchor">#</a> 2.4.3 sharedProcessor</h4> <p>然后上面 <code>SharedIndexInformer</code> 的实现中还有一个比较重要的属性就是 <code>sharedProcessor</code>，就是专门来处理事件的，通过 AddEventHandler 函数添加的处理器就会被封装成 <code>processorListener</code>，然后通过 <code>sharedProcessor</code> 管理起来，其定义如下所示：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/shared_informer.go</span>

<span class="token comment">// sharedProcessor 有一个 processorListener 的集合，可以向它的监听器分发事件通知对象。</span>
<span class="token keyword">type</span> sharedProcessor <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	listenersStarted <span class="token builtin">bool</span>  <span class="token comment">// 所有处理器是否已经启动</span>
	listenersLock    sync<span class="token punctuation">.</span>RWMutex  <span class="token comment">// 读写锁🔒</span>
	listeners        <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>processorListener  <span class="token comment">// 通用的处理器列表</span>
	syncingListeners <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>processorListener  <span class="token comment">// 需要定时同步的处理器列表</span>
	clock            clock<span class="token punctuation">.</span>Clock
	wg               wait<span class="token punctuation">.</span>Group
<span class="token punctuation">}</span>

<span class="token keyword">type</span> processorListener <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	nextCh <span class="token keyword">chan</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	addCh  <span class="token keyword">chan</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token comment">// 添加事件的通道</span>

	handler ResourceEventHandler

	<span class="token comment">// pendingNotifications 是一个无边界的环形缓冲区，用于保存所有尚未分发的通知。</span>
	pendingNotifications buffer<span class="token punctuation">.</span>RingGrowing

	requestedResyncPeriod time<span class="token punctuation">.</span>Duration
	
	resyncPeriod time<span class="token punctuation">.</span>Duration

	nextResync time<span class="token punctuation">.</span>Time

	resyncLock sync<span class="token punctuation">.</span>Mutex
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>processorListener 中就包含一个资源事件处理器，那么我们是如何传递事件进来的呢？首先我们来看看添加一个处理器是如何实现的：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/shared_informer.go</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>processorListener<span class="token punctuation">)</span> <span class="token function">add</span><span class="token punctuation">(</span>notification <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	p<span class="token punctuation">.</span>addCh <span class="token operator">&lt;-</span> notification
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>可以看到添加事件很简单，直接通过 addCh 这个通道接收，notification 就是我们所说的事件，也就是前面我们常说的 <code>DeltaFIFO</code> 输出的 Deltas。上面我们可以看到 addCh 是定义成的一个无缓冲通道，所以这个 add() 函数就是一个事件分发器，从 DeltaFIFO 中弹出的对象要逐一送到多个处理器，如果处理器没有及时处理 addCh 则会阻塞住：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/shared_informer.go</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>processorListener<span class="token punctuation">)</span> <span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> utilruntime<span class="token punctuation">.</span><span class="token function">HandleCrash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>nextCh<span class="token punctuation">)</span> <span class="token comment">// 通知 run() 函数停止</span>

	<span class="token keyword">var</span> nextCh <span class="token keyword">chan</span><span class="token operator">&lt;-</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token keyword">var</span> notification <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">// 死循环</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token keyword">select</span> <span class="token punctuation">{</span>
    <span class="token comment">// nextCh 还没初始化时，会被阻塞</span>
		<span class="token keyword">case</span> nextCh <span class="token operator">&lt;-</span> notification<span class="token punctuation">:</span>
			<span class="token comment">// 如果发送成功了（下面的 run 函数中消耗了数据后），从缓冲中再取一个事件出来</span>
			<span class="token keyword">var</span> ok <span class="token builtin">bool</span>
			notification<span class="token punctuation">,</span> ok <span class="token operator">=</span> p<span class="token punctuation">.</span>pendingNotifications<span class="token punctuation">.</span><span class="token function">ReadOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span> <span class="token comment">// 没有事件被 Pop，设置 nextCh 为 nil</span>
				nextCh <span class="token operator">=</span> <span class="token boolean">nil</span> <span class="token comment">// Disable 这个 select 的 case</span>
			<span class="token punctuation">}</span>
    <span class="token comment">// 从 p.addCh 通道中读取一个事件，消费 addCh 通道</span>
		<span class="token keyword">case</span> notificationToAdd<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token operator">&lt;-</span>p<span class="token punctuation">.</span>addCh<span class="token punctuation">:</span>  
			<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>  <span class="token comment">// 如果关闭了，则退出</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
      <span class="token comment">// notification 为空说明还没发送任何事件给处理器（pendingNotifications 为空）</span>
			<span class="token keyword">if</span> notification <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> 
        <span class="token comment">// 把刚刚获取的事件通过 p.nextCh 发送给处理器</span>
				notification <span class="token operator">=</span> notificationToAdd
				nextCh <span class="token operator">=</span> p<span class="token punctuation">.</span>nextCh
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 上一个事件还没发送完成（已经有一个通知等待发送），就先放到缓冲通道中</span>
				p<span class="token punctuation">.</span>pendingNotifications<span class="token punctuation">.</span><span class="token function">WriteOne</span><span class="token punctuation">(</span>notificationToAdd<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>pop() 函数的实现的利用了 golang 的 select 来同时操作多个 channel ，select 的 case 表达式都没有满足求值条件，那么 select 语句就会被阻塞，直到至少有一个 case 表达式满足条件为止，如果多个 case 语句同时满足则随机选择一个 case 执行。接下来，我们看看从 nextCh 读取事件后是如何处理的：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/shared_informer.go</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>processorListener<span class="token punctuation">)</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 当关闭 stopCh 后才会退出</span>
	stopCh <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	wait<span class="token punctuation">.</span><span class="token function">Until</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 不断从 nextCh 通道中取数据</span>
		<span class="token keyword">for</span> next <span class="token operator">:=</span> <span class="token keyword">range</span> p<span class="token punctuation">.</span>nextCh <span class="token punctuation">{</span>
      <span class="token comment">// 判断事件类型</span>
			<span class="token keyword">switch</span> notification <span class="token operator">:=</span> next<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">case</span> updateNotification<span class="token punctuation">:</span>
				p<span class="token punctuation">.</span>handler<span class="token punctuation">.</span><span class="token function">OnUpdate</span><span class="token punctuation">(</span>notification<span class="token punctuation">.</span>oldObj<span class="token punctuation">,</span> notification<span class="token punctuation">.</span>newObj<span class="token punctuation">)</span>
			<span class="token keyword">case</span> addNotification<span class="token punctuation">:</span>
				p<span class="token punctuation">.</span>handler<span class="token punctuation">.</span><span class="token function">OnAdd</span><span class="token punctuation">(</span>notification<span class="token punctuation">.</span>newObj<span class="token punctuation">)</span>
			<span class="token keyword">case</span> deleteNotification<span class="token punctuation">:</span>
				p<span class="token punctuation">.</span>handler<span class="token punctuation">.</span><span class="token function">OnDelete</span><span class="token punctuation">(</span>notification<span class="token punctuation">.</span>oldObj<span class="token punctuation">)</span>
			<span class="token keyword">default</span><span class="token punctuation">:</span>
				utilruntime<span class="token punctuation">.</span><span class="token function">HandleError</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;unrecognized notification: %T&quot;</span><span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
    <span class="token comment">// 当 p.nextCh 是空的且是关闭的时候才能到达这里，关闭 stopCh</span>
		<span class="token function">close</span><span class="token punctuation">(</span>stopCh<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> stopCh<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p><code>run()</code> 和 <code>pop()</code> 是 processorListener 的两个最核心的函数，processorListener 就是实现了事件的缓冲和处理，在没有事件的时候可以阻塞处理器，当事件较多是可以把事件缓冲起来，实现了事件分发器与处理器的异步处理。processorListener 的 run() 和 pop() 函数其实都是通过 sharedProcessor 启动的协程来调用的，所以下面我们再来对 sharedProcessor 进行分析了。首先看下如何添加一个 processorListener：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/shared_informer.go</span>

<span class="token comment">// 添加处理器</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>sharedProcessor<span class="token punctuation">)</span> <span class="token function">addListener</span><span class="token punctuation">(</span>listener <span class="token operator">*</span>processorListener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	p<span class="token punctuation">.</span>listenersLock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 加锁</span>
	<span class="token keyword">defer</span> p<span class="token punctuation">.</span>listenersLock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 调用 addListenerLocked 函数</span>
	p<span class="token punctuation">.</span><span class="token function">addListenerLocked</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span>
  <span class="token comment">// 如果事件处理列表中的处理器已经启动了，则手动启动下面的两个协程</span>
  <span class="token comment">// 相当于启动后了</span>
	<span class="token keyword">if</span> p<span class="token punctuation">.</span>listenersStarted <span class="token punctuation">{</span>  
    <span class="token comment">// 通过 wait.Group 启动两个协程，就是上面我们提到的 run 和 pop 函数</span>
		p<span class="token punctuation">.</span>wg<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>listener<span class="token punctuation">.</span>run<span class="token punctuation">)</span>
		p<span class="token punctuation">.</span>wg<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>listener<span class="token punctuation">.</span>pop<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 将处理器添加到处理器的列表中</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>sharedProcessor<span class="token punctuation">)</span> <span class="token function">addListenerLocked</span><span class="token punctuation">(</span>listener <span class="token operator">*</span>processorListener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 添加到通用处理器列表中</span>
	p<span class="token punctuation">.</span>listeners <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>listeners<span class="token punctuation">,</span> listener<span class="token punctuation">)</span>  
  <span class="token comment">// 添加到需要定时同步的处理器列表中</span>
	p<span class="token punctuation">.</span>syncingListeners <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>syncingListeners<span class="token punctuation">,</span> listener<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>这里添加处理器的函数 addListener 其实在 sharedIndexInformer 中的 AddEventHandler 函数中就会调用这个函数来添加处理器。然后就是事件分发的函数实现：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/shared_informer.go</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>sharedProcessor<span class="token punctuation">)</span> <span class="token function">distribute</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> sync <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	p<span class="token punctuation">.</span>listenersLock<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> p<span class="token punctuation">.</span>listenersLock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// sync 表示 obj 对象是否是同步事件对象</span>
  <span class="token comment">// 将对象分发给每一个事件处理器列表中的处理器</span>
	<span class="token keyword">if</span> sync <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> listener <span class="token operator">:=</span> <span class="token keyword">range</span> p<span class="token punctuation">.</span>syncingListeners <span class="token punctuation">{</span>
			listener<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> listener <span class="token operator">:=</span> <span class="token keyword">range</span> p<span class="token punctuation">.</span>listeners <span class="token punctuation">{</span>
			listener<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>然后就是将 sharedProcessor 运行起来：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/shared_informer.go</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>sharedProcessor<span class="token punctuation">)</span> <span class="token function">run</span><span class="token punctuation">(</span>stopCh <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		p<span class="token punctuation">.</span>listenersLock<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">defer</span> p<span class="token punctuation">.</span>listenersLock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 遍历所有的处理器，为处理器启动两个后台协程：run 和 pop 操作</span>
    <span class="token comment">// 后续添加的处理器就是在上面的 addListener 中去启动的</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> listener <span class="token operator">:=</span> <span class="token keyword">range</span> p<span class="token punctuation">.</span>listeners <span class="token punctuation">{</span>
			p<span class="token punctuation">.</span>wg<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>listener<span class="token punctuation">.</span>run<span class="token punctuation">)</span>
			p<span class="token punctuation">.</span>wg<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>listener<span class="token punctuation">.</span>pop<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
    <span class="token comment">// 标记为所有处理器都已启动</span>
		p<span class="token punctuation">.</span>listenersStarted <span class="token operator">=</span> <span class="token boolean">true</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 等待退出信号</span>
	<span class="token operator">&lt;-</span>stopCh
  <span class="token comment">// 接收到退出信号后，关闭所有的处理器</span>
	p<span class="token punctuation">.</span>listenersLock<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> p<span class="token punctuation">.</span>listenersLock<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 遍历所有处理器</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> listener <span class="token operator">:=</span> <span class="token keyword">range</span> p<span class="token punctuation">.</span>listeners <span class="token punctuation">{</span>
    <span class="token comment">// 关闭 addCh，pop 会停止，pop 会通知 run 停止</span>
		<span class="token function">close</span><span class="token punctuation">(</span>listener<span class="token punctuation">.</span>addCh<span class="token punctuation">)</span> 
	<span class="token punctuation">}</span>
  <span class="token comment">// 等待所有协程退出，就是上面所有处理器中启动的两个协程 pop 与 run</span>
	p<span class="token punctuation">.</span>wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>到这里 sharedProcessor 就完成了对 ResourceEventHandler 的封装处理，当然最终 sharedProcessor 还是在 SharedInformer 中去调用的。</p> <h4 id="_2-4-4-sharedinformer-的实现"><a href="#_2-4-4-sharedinformer-的实现" class="header-anchor">#</a> 2.4.4 SharedInformer 的实现</h4> <p>接下来我们就来看下 SharedInformer 的具体实现：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/shared_informer.go</span>

<span class="token comment">// 为 listwatcher 创建一个新的实例，用于 Reflector 从 apiserver 获取资源</span>
<span class="token comment">// 所以需要外部提供一个资源类型</span>
<span class="token keyword">func</span> <span class="token function">NewSharedInformer</span><span class="token punctuation">(</span>lw ListerWatcher<span class="token punctuation">,</span> exampleObject runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> defaultEventHandlerResyncPeriod time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> SharedInformer <span class="token punctuation">{</span>
	<span class="token comment">// 调用 NewSharedIndexInformer 实现</span>
  <span class="token keyword">return</span> <span class="token function">NewSharedIndexInformer</span><span class="token punctuation">(</span>lw<span class="token punctuation">,</span> exampleObject<span class="token punctuation">,</span> defaultEventHandlerResyncPeriod<span class="token punctuation">,</span> Indexers<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewSharedIndexInformer</span><span class="token punctuation">(</span>lw ListerWatcher<span class="token punctuation">,</span> exampleObject runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> defaultEventHandlerResyncPeriod time<span class="token punctuation">.</span>Duration<span class="token punctuation">,</span> indexers Indexers<span class="token punctuation">)</span> SharedIndexInformer <span class="token punctuation">{</span>
	realClock <span class="token operator">:=</span> <span class="token operator">&amp;</span>clock<span class="token punctuation">.</span>RealClock<span class="token punctuation">{</span><span class="token punctuation">}</span>
	sharedIndexInformer <span class="token operator">:=</span> <span class="token operator">&amp;</span>sharedIndexInformer<span class="token punctuation">{</span>
	  processor<span class="token punctuation">:</span>                       <span class="token operator">&amp;</span>sharedProcessor<span class="token punctuation">{</span>clock<span class="token punctuation">:</span> realClock<span class="token punctuation">}</span><span class="token punctuation">,</span>
    indexer<span class="token punctuation">:</span>                         <span class="token function">NewIndexer</span><span class="token punctuation">(</span>DeletionHandlingMetaNamespaceKeyFunc<span class="token punctuation">,</span> indexers<span class="token punctuation">)</span><span class="token punctuation">,</span>
		listerWatcher<span class="token punctuation">:</span>                   lw<span class="token punctuation">,</span>
		objectType<span class="token punctuation">:</span>                      exampleObject<span class="token punctuation">,</span>
		resyncCheckPeriod<span class="token punctuation">:</span>               defaultEventHandlerResyncPeriod<span class="token punctuation">,</span>
		defaultEventHandlerResyncPeriod<span class="token punctuation">:</span> defaultEventHandlerResyncPeriod<span class="token punctuation">,</span>
		cacheMutationDetector<span class="token punctuation">:</span>           <span class="token function">NewCacheMutationDetector</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%T&quot;</span><span class="token punctuation">,</span> exampleObject<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		clock<span class="token punctuation">:</span>                           realClock<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> sharedIndexInformer
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>实例化 SharedInformer 比较简单，实例化完成后就可以添加事件处理器了：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/shared_informer.go</span>

<span class="token comment">// 使用默认的同步周期添加事件处理器</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>sharedIndexInformer<span class="token punctuation">)</span> <span class="token function">AddEventHandler</span><span class="token punctuation">(</span>handler ResourceEventHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	s<span class="token punctuation">.</span><span class="token function">AddEventHandlerWithResyncPeriod</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> s<span class="token punctuation">.</span>defaultEventHandlerResyncPeriod<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 真正的添加事件处理器的实现</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>sharedIndexInformer<span class="token punctuation">)</span> <span class="token function">AddEventHandlerWithResyncPeriod</span><span class="token punctuation">(</span>handler ResourceEventHandler<span class="token punctuation">,</span> resyncPeriod time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	s<span class="token punctuation">.</span>startedLock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> s<span class="token punctuation">.</span>startedLock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 如果已经结束了，那就直接返回了</span>
	<span class="token keyword">if</span> s<span class="token punctuation">.</span>stopped <span class="token punctuation">{</span>
		klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;Handler %v was not added to shared informer because it has stopped already&quot;</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
  <span class="token comment">// 如果同步周期&gt;0</span>
	<span class="token keyword">if</span> resyncPeriod <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
    <span class="token comment">// 同步周期不能小于最小的时间</span>
		<span class="token keyword">if</span> resyncPeriod <span class="token operator">&lt;</span> minimumResyncPeriod <span class="token punctuation">{</span>
			klog<span class="token punctuation">.</span><span class="token function">Warningf</span><span class="token punctuation">(</span><span class="token string">&quot;resyncPeriod %d is too small. Changing it to the minimum allowed value of %d&quot;</span><span class="token punctuation">,</span> resyncPeriod<span class="token punctuation">,</span> minimumResyncPeriod<span class="token punctuation">)</span>
			resyncPeriod <span class="token operator">=</span> minimumResyncPeriod
		<span class="token punctuation">}</span>
    <span class="token comment">// </span>
		<span class="token keyword">if</span> resyncPeriod <span class="token operator">&lt;</span> s<span class="token punctuation">.</span>resyncCheckPeriod <span class="token punctuation">{</span>
      <span class="token comment">// 如果已经启动了，那就用 resyncCheckPeriod 这个周期</span>
			<span class="token keyword">if</span> s<span class="token punctuation">.</span>started <span class="token punctuation">{</span>
				klog<span class="token punctuation">.</span><span class="token function">Warningf</span><span class="token punctuation">(</span><span class="token string">&quot;resyncPeriod %d is smaller than resyncCheckPeriod %d and the informer has already started. Changing it to %d&quot;</span><span class="token punctuation">,</span> resyncPeriod<span class="token punctuation">,</span> s<span class="token punctuation">.</span>resyncCheckPeriod<span class="token punctuation">,</span> s<span class="token punctuation">.</span>resyncCheckPeriod<span class="token punctuation">)</span>
				resyncPeriod <span class="token operator">=</span> s<span class="token punctuation">.</span>resyncCheckPeriod
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果事件处理器的同步周期小于当前的 resyncCheckPeriod 且还没启动</span>
        <span class="token comment">// 则更新 resyncCheckPeriod 为 resyncPeriod</span>
        <span class="token comment">// 并相应调整所有监听器的同步周期</span>
				s<span class="token punctuation">.</span>resyncCheckPeriod <span class="token operator">=</span> resyncPeriod
				s<span class="token punctuation">.</span>processor<span class="token punctuation">.</span><span class="token function">resyncCheckPeriodChanged</span><span class="token punctuation">(</span>resyncPeriod<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	
  <span class="token comment">// 新建事件处理器</span>
	listener <span class="token operator">:=</span> <span class="token function">newProcessListener</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> resyncPeriod<span class="token punctuation">,</span> <span class="token function">determineResyncPeriod</span><span class="token punctuation">(</span>resyncPeriod<span class="token punctuation">,</span> s<span class="token punctuation">.</span>resyncCheckPeriod<span class="token punctuation">)</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>clock<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> initialBufferSize<span class="token punctuation">)</span>
  
  <span class="token comment">// 如果没有启动，那么就直接添加处理器就可以了</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>s<span class="token punctuation">.</span>started <span class="token punctuation">{</span>
    <span class="token comment">// 上面我们分析过添加事件处理器</span>
		s<span class="token punctuation">.</span>processor<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
  
	<span class="token comment">// blockDeltas 提供了一种方法来停止所有的事件分发，以便后面的事件处理器可以安全地加入 SharedInformer。</span>
  s<span class="token punctuation">.</span>blockDeltas<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> s<span class="token punctuation">.</span>blockDeltas<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 添加处理器</span>
	s<span class="token punctuation">.</span>processor<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span>

  <span class="token comment">// 因为到这里证明 SharedInformer 已经启动了，可能很多对象已经让其他处理器处理过了</span>
  <span class="token comment">// 所以这些对象就不会再通知新添加的处理器了，所以这里遍历 indexer 中的所有对象去通知新添加的处理器</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> item <span class="token operator">:=</span> <span class="token keyword">range</span> s<span class="token punctuation">.</span>indexer<span class="token punctuation">.</span><span class="token function">List</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		listener<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>addNotification<span class="token punctuation">{</span>newObj<span class="token punctuation">:</span> item<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><p>事件处理器添加完过后就要看下 SharedInformer 是如何把事件分发给每个处理器的了：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/shared_informer.go</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>sharedIndexInformer<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span>stopCh <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> utilruntime<span class="token punctuation">.</span><span class="token function">HandleCrash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 新建一个 DeltaFIFO</span>
	fifo <span class="token operator">:=</span> <span class="token function">NewDeltaFIFOWithOptions</span><span class="token punctuation">(</span>DeltaFIFOOptions<span class="token punctuation">{</span>
		KnownObjects<span class="token punctuation">:</span>          s<span class="token punctuation">.</span>indexer<span class="token punctuation">,</span>
		EmitDeltaTypeReplaced<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 用于构造 Controller 的配置</span>
	cfg <span class="token operator">:=</span> <span class="token operator">&amp;</span>Config<span class="token punctuation">{</span>
		Queue<span class="token punctuation">:</span>            fifo<span class="token punctuation">,</span>  
		ListerWatcher<span class="token punctuation">:</span>    s<span class="token punctuation">.</span>listerWatcher<span class="token punctuation">,</span>
		ObjectType<span class="token punctuation">:</span>       s<span class="token punctuation">.</span>objectType<span class="token punctuation">,</span>
		FullResyncPeriod<span class="token punctuation">:</span> s<span class="token punctuation">.</span>resyncCheckPeriod<span class="token punctuation">,</span>
		RetryOnError<span class="token punctuation">:</span>     <span class="token boolean">false</span><span class="token punctuation">,</span>
		ShouldResync<span class="token punctuation">:</span>     s<span class="token punctuation">.</span>processor<span class="token punctuation">.</span>shouldResync<span class="token punctuation">,</span>
    <span class="token comment">// Controller 调用 DeltaFIFO 的 Pop 函数传入这个回调函数来处理弹出的对象</span>
		Process<span class="token punctuation">:</span> s<span class="token punctuation">.</span>HandleDeltas<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		s<span class="token punctuation">.</span>startedLock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">defer</span> s<span class="token punctuation">.</span>startedLock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 新建一个 Controller 并标记为已经启动</span>
		s<span class="token punctuation">.</span>controller <span class="token operator">=</span> <span class="token function">New</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>
		s<span class="token punctuation">.</span>controller<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>controller<span class="token punctuation">)</span><span class="token punctuation">.</span>clock <span class="token operator">=</span> s<span class="token punctuation">.</span>clock
		s<span class="token punctuation">.</span>started <span class="token operator">=</span> <span class="token boolean">true</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	processorStopCh <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">var</span> wg wait<span class="token punctuation">.</span>Group
	<span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>              <span class="token comment">// 等待处理器停止</span>
	<span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>processorStopCh<span class="token punctuation">)</span> <span class="token comment">// 通知处理器停止</span>
  <span class="token comment">// 启动两个协程</span>
	wg<span class="token punctuation">.</span><span class="token function">StartWithChannel</span><span class="token punctuation">(</span>processorStopCh<span class="token punctuation">,</span> s<span class="token punctuation">.</span>cacheMutationDetector<span class="token punctuation">.</span>Run<span class="token punctuation">)</span>
	wg<span class="token punctuation">.</span><span class="token function">StartWithChannel</span><span class="token punctuation">(</span>processorStopCh<span class="token punctuation">,</span> s<span class="token punctuation">.</span>processor<span class="token punctuation">.</span>run<span class="token punctuation">)</span>

	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		s<span class="token punctuation">.</span>startedLock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">defer</span> s<span class="token punctuation">.</span>startedLock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 标记为已停止</span>
		s<span class="token punctuation">.</span>stopped <span class="token operator">=</span> <span class="token boolean">true</span> 
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 启动 Controller</span>
	s<span class="token punctuation">.</span>controller<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>stopCh<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><p>sharedIndexInformer 通过 Run() 函数启动了 Controller 和 sharedProcess，Controller 通过 DeltaFIFO 的 Pop 函数弹出 Deltas 对象，并使用 HandleDeltas 函数来处理这个对象，前面其实我们就讲解过。这个函数把 Deltas 转换为 sharedProcess 需要的各种Notification 类型。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// k8s.io/client-go/tools/cache/shared_informer.go</span>

<span class="token comment">// DeltaFIFO 的对象被 Pop 后的处理函数</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>sharedIndexInformer<span class="token punctuation">)</span> <span class="token function">HandleDeltas</span><span class="token punctuation">(</span>obj <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	s<span class="token punctuation">.</span>blockDeltas<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> s<span class="token punctuation">.</span>blockDeltas<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// 因为 Deltas 是 Delta 列表，里面包含一个对象的多个操作</span>
  <span class="token comment">// 所以要从最老的 Delta 到最新的 Delta 遍历处理</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> d <span class="token operator">:=</span> <span class="token keyword">range</span> obj<span class="token punctuation">.</span><span class="token punctuation">(</span>Deltas<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">switch</span> d<span class="token punctuation">.</span>Type <span class="token punctuation">{</span> <span class="token comment">// 根据对象操作类型进行处理</span>
    <span class="token comment">// 同步、替换、添加、更新类型</span>
		<span class="token keyword">case</span> Sync<span class="token punctuation">,</span> Replaced<span class="token punctuation">,</span> Added<span class="token punctuation">,</span> Updated<span class="token punctuation">:</span>
			s<span class="token punctuation">.</span>cacheMutationDetector<span class="token punctuation">.</span><span class="token function">AddObject</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>Object<span class="token punctuation">)</span>
      <span class="token comment">// 如果 indexer 中有这个对象，则当成更新事件进行处理</span>
			<span class="token keyword">if</span> old<span class="token punctuation">,</span> exists<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>indexer<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>Object<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> exists <span class="token punctuation">{</span>
				<span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>indexer<span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>Object<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>  
					<span class="token keyword">return</span> err
				<span class="token punctuation">}</span>

				isSync <span class="token operator">:=</span> <span class="token boolean">false</span>
				<span class="token keyword">switch</span> <span class="token punctuation">{</span>
				<span class="token keyword">case</span> d<span class="token punctuation">.</span>Type <span class="token operator">==</span> Sync<span class="token punctuation">:</span>
					isSync <span class="token operator">=</span> <span class="token boolean">true</span>
				<span class="token keyword">case</span> d<span class="token punctuation">.</span>Type <span class="token operator">==</span> Replaced<span class="token punctuation">:</span>
					<span class="token keyword">if</span> accessor<span class="token punctuation">,</span> err <span class="token operator">:=</span> meta<span class="token punctuation">.</span><span class="token function">Accessor</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>Object<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
						<span class="token keyword">if</span> oldAccessor<span class="token punctuation">,</span> err <span class="token operator">:=</span> meta<span class="token punctuation">.</span><span class="token function">Accessor</span><span class="token punctuation">(</span>old<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
							isSync <span class="token operator">=</span> accessor<span class="token punctuation">.</span><span class="token function">GetResourceVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> oldAccessor<span class="token punctuation">.</span><span class="token function">GetResourceVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
        <span class="token comment">// 通知处理器处理事件</span>
				s<span class="token punctuation">.</span>processor<span class="token punctuation">.</span><span class="token function">distribute</span><span class="token punctuation">(</span>updateNotification<span class="token punctuation">{</span>oldObj<span class="token punctuation">:</span> old<span class="token punctuation">,</span> newObj<span class="token punctuation">:</span> d<span class="token punctuation">.</span>Object<span class="token punctuation">}</span><span class="token punctuation">,</span> isSync<span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 将对象添加到 indexer 存储中</span>
				<span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>indexer<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>Object<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
					<span class="token keyword">return</span> err
				<span class="token punctuation">}</span>
        <span class="token comment">// 然后通知处理器处理事件</span>
				s<span class="token punctuation">.</span>processor<span class="token punctuation">.</span><span class="token function">distribute</span><span class="token punctuation">(</span>addNotification<span class="token punctuation">{</span>newObj<span class="token punctuation">:</span> d<span class="token punctuation">.</span>Object<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
    <span class="token comment">// 删除类型</span>
		<span class="token keyword">case</span> Deleted<span class="token punctuation">:</span>
      <span class="token comment">// 从 indexer 中删除对象</span>
			<span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>indexer<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>Object<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> err
			<span class="token punctuation">}</span>
      <span class="token comment">// 通知所有的处理器对象被删除了</span>
			s<span class="token punctuation">.</span>processor<span class="token punctuation">.</span><span class="token function">distribute</span><span class="token punctuation">(</span>deleteNotification<span class="token punctuation">{</span>oldObj<span class="token punctuation">:</span> d<span class="token punctuation">.</span>Object<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><h4 id="_2-4-5-sharedinformerfactory"><a href="#_2-4-5-sharedinformerfactory" class="header-anchor">#</a> 2.4.5 SharedInformerFactory</h4> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> SharedInformerFactory <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Start</span><span class="token punctuation">(</span>stopCh <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token function">InformerFor</span><span class="token punctuation">(</span>obj runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> newFunc NewInformerFunc<span class="token punctuation">)</span> cache<span class="token punctuation">.</span>SharedIndexInformer
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> SharedInformerFactory <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	internalinterfaces<span class="token punctuation">.</span>SharedInformerFactory
	<span class="token function">ForResource</span><span class="token punctuation">(</span>resource schema<span class="token punctuation">.</span>GroupVersionResource<span class="token punctuation">)</span> <span class="token punctuation">(</span>GenericInformer<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
	<span class="token function">WaitForCacheSync</span><span class="token punctuation">(</span>stopCh <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">map</span><span class="token punctuation">[</span>reflect<span class="token punctuation">.</span>Type<span class="token punctuation">]</span><span class="token builtin">bool</span>

	<span class="token function">Admissionregistration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> admissionregistration<span class="token punctuation">.</span>Interface
	<span class="token function">Internal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> apiserverinternal<span class="token punctuation">.</span>Interface
	<span class="token function">Apps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> apps<span class="token punctuation">.</span>Interface
	<span class="token function">Autoscaling</span><span class="token punctuation">(</span><span class="token punctuation">)</span> autoscaling<span class="token punctuation">.</span>Interface
	<span class="token function">Batch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> batch<span class="token punctuation">.</span>Interface
	<span class="token function">Certificates</span><span class="token punctuation">(</span><span class="token punctuation">)</span> certificates<span class="token punctuation">.</span>Interface
	<span class="token function">Coordination</span><span class="token punctuation">(</span><span class="token punctuation">)</span> coordination<span class="token punctuation">.</span>Interface
	<span class="token function">Core</span><span class="token punctuation">(</span><span class="token punctuation">)</span> core<span class="token punctuation">.</span>Interface
	<span class="token function">Discovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> discovery<span class="token punctuation">.</span>Interface
	<span class="token function">Events</span><span class="token punctuation">(</span><span class="token punctuation">)</span> events<span class="token punctuation">.</span>Interface
	<span class="token function">Extensions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> extensions<span class="token punctuation">.</span>Interface
	<span class="token function">Flowcontrol</span><span class="token punctuation">(</span><span class="token punctuation">)</span> flowcontrol<span class="token punctuation">.</span>Interface
	<span class="token function">Networking</span><span class="token punctuation">(</span><span class="token punctuation">)</span> networking<span class="token punctuation">.</span>Interface
	<span class="token function">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span> node<span class="token punctuation">.</span>Interface
	<span class="token function">Policy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> policy<span class="token punctuation">.</span>Interface
	<span class="token function">Rbac</span><span class="token punctuation">(</span><span class="token punctuation">)</span> rbac<span class="token punctuation">.</span>Interface
	<span class="token function">Scheduling</span><span class="token punctuation">(</span><span class="token punctuation">)</span> scheduling<span class="token punctuation">.</span>Interface
	<span class="token function">Storage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> storage<span class="token punctuation">.</span>Interface
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>具体实现 sharedInformerFactory</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// staging/client-go/informer/factory.go</span>
<span class="token keyword">type</span> sharedInformerFactory <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  client           kubernetes<span class="token punctuation">.</span>Interface
  namespace        <span class="token builtin">string</span>
  tweakListOptions internalinterfaces<span class="token punctuation">.</span>TweakListOptionsFunc
  lock             sync<span class="token punctuation">.</span>Mutex
  defaultResync    time<span class="token punctuation">.</span>Duration
  customResync     <span class="token keyword">map</span><span class="token punctuation">[</span>reflect<span class="token punctuation">.</span>Type<span class="token punctuation">]</span>time<span class="token punctuation">.</span>Duration

  <span class="token comment">// 按照类型存放共享的informer</span>
  informers <span class="token keyword">map</span><span class="token punctuation">[</span>reflect<span class="token punctuation">.</span>Type<span class="token punctuation">]</span>cache<span class="token punctuation">.</span>SharedIndexInformer

  <span class="token comment">// 这个字段用来追踪informers是否被启动了</span>
  <span class="token comment">// 可以保证Start()方法安全的重复调用多次（幂等性）</span>
  startedInformers <span class="token keyword">map</span><span class="token punctuation">[</span>reflect<span class="token punctuation">.</span>Type<span class="token punctuation">]</span><span class="token builtin">bool</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><strong>启动 Start方法</strong></p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>sharedInformerFactory<span class="token punctuation">)</span> <span class="token function">Start</span><span class="token punctuation">(</span>stopCh <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token comment">// 遍历所有的informers</span>
  <span class="token keyword">for</span> informerType<span class="token punctuation">,</span> informer <span class="token operator">:=</span> <span class="token keyword">range</span> f<span class="token punctuation">.</span>informers <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>f<span class="token punctuation">.</span>startedInformers<span class="token punctuation">[</span>informerType<span class="token punctuation">]</span> <span class="token punctuation">{</span>
      <span class="token comment">// 每一种informer启动一个协程，运行Run方法</span>
      <span class="token keyword">go</span> informer<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>stopCh<span class="token punctuation">)</span>
      f<span class="token punctuation">.</span>startedInformers<span class="token punctuation">[</span>informerType<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>注册 InformerFor方法</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>sharedInformerFactory<span class="token punctuation">)</span> <span class="token function">InformerFor</span><span class="token punctuation">(</span>obj runtime<span class="token punctuation">.</span>Object<span class="token punctuation">,</span> newFunc internalinterfaces<span class="token punctuation">.</span>NewInformerFunc<span class="token punctuation">)</span> cache<span class="token punctuation">.</span>SharedIndexInformer <span class="token punctuation">{</span>
	f<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> f<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	informerType <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
	informer<span class="token punctuation">,</span> exists <span class="token operator">:=</span> f<span class="token punctuation">.</span>informers<span class="token punctuation">[</span>informerType<span class="token punctuation">]</span>
	<span class="token keyword">if</span> exists <span class="token punctuation">{</span>
		<span class="token keyword">return</span> informer
	<span class="token punctuation">}</span>

	resyncPeriod<span class="token punctuation">,</span> exists <span class="token operator">:=</span> f<span class="token punctuation">.</span>customResync<span class="token punctuation">[</span>informerType<span class="token punctuation">]</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>exists <span class="token punctuation">{</span>
		resyncPeriod <span class="token operator">=</span> f<span class="token punctuation">.</span>defaultResync
	<span class="token punctuation">}</span>

	informer <span class="token operator">=</span> <span class="token function">newFunc</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>client<span class="token punctuation">,</span> resyncPeriod<span class="token punctuation">)</span>
	f<span class="token punctuation">.</span>informers<span class="token punctuation">[</span>informerType<span class="token punctuation">]</span> <span class="token operator">=</span> informer

	<span class="token keyword">return</span> informer
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h4 id="_2-4-6-流程总结"><a href="#_2-4-6-流程总结" class="header-anchor">#</a> 2.4.6 流程总结</h4> <ol><li>通过 Reflector 实现资源对象的 List 和 Watch 操作</li> <li>将通过 List 全量列举的对象存储在 Indexer 中，然后再 Watch 资源，一旦有变化就更新 Indexer，并在 Indexer 中采用 Namespace 做对象索引</li> <li>更新到 Indexer 的过程通过 DeltaFIFO 实现有顺序的更新，因为资源状态是通过全量+增量的方式实现同步的，所以顺序错误会造成状态不一致</li> <li>使用者可以注册回调函数，在更新到 Indexer 的同时通知使用者去处理，为了保证回调处理不被某一个处理器阻塞，SharedInformer 实现了processorListener 异步缓冲处理</li> <li>整个过程是通过 Controller 来驱动的</li></ol> <h3 id="_2-5-workqueue"><a href="#_2-5-workqueue" class="header-anchor">#</a> 2.5 Workqueue</h3> <p>未完待续...</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">5/5/2023, 2:33:10 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/LearnDocsHtml/doc/kubernetes/k8s 集群搭建.html" class="prev">
        虚拟机部署k8s集群
      </a></span> <span class="next"><a href="/LearnDocsHtml/doc/kubernetes/kubernetes 核心.html">
        Kubernetes设计架构
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/LearnDocsHtml/assets/js/app.0f1bd8f2.js" defer></script><script src="/LearnDocsHtml/assets/js/3.67df8e7b.js" defer></script><script src="/LearnDocsHtml/assets/js/47.f067c624.js" defer></script>
  </body>
</html>
